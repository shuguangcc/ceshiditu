import{n as K}from"./compilerUtils-034cacb8.js";import{s as W,a as Y}from"./Error-653283ae.js";import{n as j}from"./Evented-515b9d9c.js";import{c as F,i as $}from"./mathUtils-2519596a.js";import{t as _,f as J,P as B,E as G,r as R,h as Q}from"./typedArrayUtil-a8b5b3e9.js";import{f as v,v as Z,a as ee}from"./promiseUtils-6684e352.js";import{V,X as te,d as ae}from"./request-d3e98716.js";import{e as re,g as se,B as ie,u as oe}from"./VisualVariablePassParameters-5807c7dc.js";import{i as ne}from"./TextureOnly.glsl-18701a3b.js";import{c as y}from"./basicInterfaces-19ed850e.js";import{_ as le}from"./preload-helper-41c905a7.js";import{a as he}from"./assets-0b172f07.js";import{u,P as g,L as A,D as S,M as H,G as U,Y as me,V as de,E as pe}from"./enums-64ab819c.js";import{E as c,n as _e}from"./Texture-e79b14e7.js";import{_ as ue,x as ce,n as Te}from"./FramebufferObject-50e1b68f.js";import{e as ge}from"./Util-a48361c6.js";function Ee(){if(_(N)){const r=e=>he(`esri/libs/basisu/${e}`);N=le(()=>import("./basis_transcoder-ada6623d.js"),["./basis_transcoder-ada6623d.js","./_commonjsHelpers-a430e9ea.js"],import.meta.url).then(e=>e.b).then(({default:e})=>e({locateFile:r}).then(a=>(a.initializeBasis(),delete a.then,a)))}return N}let N;var E;(function(r){r[r.ETC1_RGB=0]="ETC1_RGB",r[r.ETC2_RGBA=1]="ETC2_RGBA",r[r.BC1_RGB=2]="BC1_RGB",r[r.BC3_RGBA=3]="BC3_RGBA",r[r.BC4_R=4]="BC4_R",r[r.BC5_RG=5]="BC5_RG",r[r.BC7_M6_RGB=6]="BC7_M6_RGB",r[r.BC7_M5_RGBA=7]="BC7_M5_RGBA",r[r.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",r[r.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",r[r.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",r[r.ATC_RGB=11]="ATC_RGB",r[r.ATC_RGBA=12]="ATC_RGBA",r[r.FXT1_RGB=17]="FXT1_RGB",r[r.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",r[r.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",r[r.ETC2_EAC_R11=20]="ETC2_EAC_R11",r[r.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",r[r.RGBA32=13]="RGBA32",r[r.RGB565=14]="RGB565",r[r.BGR565=15]="BGR565",r[r.RGBA4444=16]="RGBA4444"})(E||(E={}));let p=null,P=null;async function b(){return _(P)&&(P=Ee(),p=await P),P}function Ae(r,e){if(_(p))return r.byteLength;const a=new p.BasisFile(new Uint8Array(r)),t=X(a)?L(a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),e):0;return a.close(),a.delete(),t}function fe(r,e){if(_(p))return r.byteLength;const a=new p.KTX2File(new Uint8Array(r)),t=k(a)?L(a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),e):0;return a.close(),a.delete(),t}function L(r,e,a,t,s){const i=ue(e?u.COMPRESSED_RGBA8_ETC2_EAC:u.COMPRESSED_RGB8_ETC2),o=s&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(a*t*i*o)}function X(r){return r.getNumImages()>=1&&!r.isUASTC()}function k(r){return r.getFaces()>=1&&r.isETC1S()}async function Re(r,e,a){_(p)&&(p=await b());const t=new p.BasisFile(new Uint8Array(a));if(!X(t))return null;t.startTranscoding();const s=z(r,e,t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),(i,o)=>t.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>t.transcodeImage(n,0,i,o,0,0));return t.close(),t.delete(),s}async function we(r,e,a){_(p)&&(p=await b());const t=new p.KTX2File(new Uint8Array(a));if(!k(t))return null;t.startTranscoding();const s=z(r,e,t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),(i,o)=>t.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>t.transcodeImage(n,i,0,0,o,0,-1,-1));return t.close(),t.delete(),s}function z(r,e,a,t,s,i,o,n){const{compressedTextureETC:l,compressedTextureS3TC:h}=r.capabilities,[m,f]=l?t?[E.ETC2_RGBA,u.COMPRESSED_RGBA8_ETC2_EAC]:[E.ETC1_RGB,u.COMPRESSED_RGB8_ETC2]:h?t?[E.BC3_RGBA,u.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[E.BC1_RGB,u.COMPRESSED_RGB_S3TC_DXT1_EXT]:[E.RGBA32,g.RGBA],w=e.hasMipmap?a:Math.min(1,a),T=[];for(let D=0;D<w;D++)T.push(new Uint8Array(o(D,m))),n(D,m,T[D]);const C=T.length>1,I=C?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,q={...e,samplingMode:I,hasMipmap:C,internalFormat:f,width:s,height:i};return new c(r,q,{type:"compressed",levels:T})}const M=W.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Ce=542327876,De=131072,Be=4;function O(r){return r.charCodeAt(0)+(r.charCodeAt(1)<<8)+(r.charCodeAt(2)<<16)+(r.charCodeAt(3)<<24)}function Ge(r){return String.fromCharCode(255&r,r>>8&255,r>>16&255,r>>24&255)}const Me=O("DXT1"),xe=O("DXT3"),Ie=O("DXT5"),Se=31,Pe=0,Fe=1,ye=2,Ne=3,Oe=4,$e=7,ve=20,Ve=21;function He(r,e,a){const{textureData:t,internalFormat:s,width:i,height:o}=J(Ue(a,e.hasMipmap??!1));return e.samplingMode=t.levels.length>1?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,e.hasMipmap=t.levels.length>1,e.internalFormat=s,e.width=i,e.height=o,new c(r,e,t)}function Ue(r,e){const a=new Int32Array(r,0,Se);if(a[Pe]!==Ce)return M.error("Invalid magic number in DDS header"),null;if(!(a[ve]&Be))return M.error("Unsupported format, must contain a FourCC code"),null;const t=a[Ve];let s,i;switch(t){case Me:s=8,i=u.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case xe:s=16,i=u.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ie:s=16,i=u.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return M.error("Unsupported FourCC code:",Ge(t)),null}let o=1,n=a[Oe],l=a[Ne];!(3&n)&&!(3&l)||(M.warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);const h=n,m=l;let f,w;a[ye]&De&&e!==!1&&(o=Math.max(1,a[$e])),o===1||F(n)&&F(l)||(M.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let T=a[Fe]+4;const C=[];for(let I=0;I<o;++I)w=(n+3>>2)*(l+3>>2)*s,f=new Uint8Array(r,T,w),C.push(f),T+=w,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:C},internalFormat:i,width:h,height:m}}class d extends re{constructor(e,a){super(),this._data=e,this.type=se.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new j,this._passParameters=new ne,this.params=a||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:S.REPEAT,t:S.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||y.STRETCH,this.estimatedTexMemRequired=d._estimateTexMemRequired(this._data,this.params),this._startPreload()}_startPreload(){const e=this._data;_(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(V(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const a=!e.paused;if(e.src=e.src,a&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){te(e.src)||V(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,a){if(_(e))return 0;if(B(e)||G(e))return a.encoding===d.KTX2_ENCODING?fe(e,a.mipmap):a.encoding===d.BASIS_ENCODING?Ae(e,a.mipmap):e.byteLength;const{width:t,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?d._getDataDimensions(e):a;return(a.mipmap?4/3:1)*t*s*(a.components||4)||0}dispose(){this._data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:H.TEXTURE_2D,pixelFormat:g.RGBA,dataType:U.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?A.LINEAR_MIPMAP_LINEAR:A.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,a){if(R(this._glTexture))return this._glTexture;if(R(this._loadingPromise))return this._loadingPromise;const t=this._data;return _(t)?(this._glTexture=new c(e,this._createDescriptor(e),null),this._glTexture):typeof t=="string"?this._loadFromURL(e,a,t):t instanceof Image?this._loadFromImageElement(e,a,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,a,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t,a):(B(t)||G(t))&&this.params.encoding===d.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,t)):(B(t)||G(t))&&this.params.encoding===d.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,t)):(B(t)||G(t))&&this.params.encoding===d.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,t)):G(t)?this._loadFromPixelData(e,t):B(t)?this._loadFromPixelData(e,new Uint8Array(t)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e,a,t){if(!(this._data instanceof HTMLVideoElement)||_(this._glTexture)||this._data.readyState<x.HAVE_CURRENT_DATA||t===this._data.currentTime)return t;if(R(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:i,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this._data),this._drawStretchedTexture(e,a,s,i,o,this._glTexture)}else{const{videoWidth:s,videoHeight:i}=this._data,{width:o,height:n}=this._glTexture.descriptor;s!==o||i!==n?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(i,n),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}_loadFromDDSData(e,a){return this._glTexture=He(e,this._createDescriptor(e),a),this._glTexture}_loadFromKTX2(e,a){return this._loadAsync(()=>we(e,this._createDescriptor(e),a).then(t=>(this._glTexture=t,t)))}_loadFromBasis(e,a){return this._loadAsync(()=>Re(e,this._createDescriptor(e),a).then(t=>(this._glTexture=t,t)))}_loadFromPixelData(e,a){ge(this.params.width>0&&this.params.height>0);const t=this._createDescriptor(e);return t.pixelFormat=this.params.components===1?g.LUMINANCE:this.params.components===3?g.RGB:g.RGBA,t.width=this.params.width,t.height=this.params.height,this._glTexture=new c(e,t,a),this._glTexture}_loadFromURL(e,a,t){return this._loadAsync(async s=>{const i=await ie(t,{signal:s});return v(s),this._loadFromImage(e,i,a)})}_loadFromImageElement(e,a,t){return t.complete?this._loadFromImage(e,t,a):this._loadAsync(async s=>{const i=await ae(t,t.src,!1,s);return v(s),this._loadFromImage(e,i,a)})}_loadFromVideoElement(e,a,t){return t.readyState>=x.HAVE_CURRENT_DATA?this._loadFromImage(e,t,a):this._loadFromVideoElementAsync(e,a,t)}_loadFromVideoElementAsync(e,a,t){return this._loadAsync(s=>new Promise((i,o)=>{const n=()=>{t.removeEventListener("loadeddata",l),t.removeEventListener("error",h),Q(m)},l=()=>{t.readyState>=x.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(e,t,a)))},h=f=>{n(),o(f||new Y("Failed to load video"))};t.addEventListener("loadeddata",l),t.addEventListener("error",h);const m=Z(s,()=>h(ee()))}))}_loadFromImage(e,a,t){const s=d._getDataDimensions(a);this.params.width=s.width,this.params.height=s.height;const i=this._createDescriptor(e);return i.pixelFormat=this.params.components===3?g.RGB:g.RGBA,!this._requiresPowerOfTwo(e,i)||F(s.width)&&F(s.height)?(i.width=s.width,i.height=s.height,this._glTexture=new c(e,i,a),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,a,s,i,t),this._glTexture)}_loadAsync(e){const a=new AbortController;this._loadingController=a;const t=e(a.signal);this._loadingPromise=t;const s=()=>{this._loadingController===a&&(this._loadingController=null),this._loadingPromise===t&&(this._loadingPromise=null)};return t.then(s,s),t}_requiresPowerOfTwo(e,a){const t=S.CLAMP_TO_EDGE,s=typeof a.wrapMode=="number"?a.wrapMode===t:a.wrapMode.s===t&&a.wrapMode.t===t;return!_e(e.gl)&&(a.hasMipmap||!s)}_makePowerOfTwoTexture(e,a,t,s,i){const{width:o,height:n}=t,l=$(o),h=$(n);let m;switch(s.width=l,s.height=h,this.params.powerOfTwoResizeMode){case y.PAD:s.textureCoordinateScaleFactor=[o/l,n/h],m=new c(e,s),m.updateData(0,0,0,o,n,a);break;case y.STRETCH:case null:case void 0:m=this._stretchToPowerOfTwo(e,a,s,i());break;default:K(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&m.generateMipmap(),m}_stretchToPowerOfTwo(e,a,t,s){const i=new c(e,t),o=new ce(e,{colorTarget:me.TEXTURE,depthStencilTarget:de.NONE},i),n=new c(e,{target:H.TEXTURE_2D,pixelFormat:t.pixelFormat,dataType:U.UNSIGNED_BYTE,wrapMode:S.CLAMP_TO_EDGE,samplingMode:A.LINEAR,flipped:!!t.flipped,maxAnisotropy:8,preMultiplyAlpha:t.preMultiplyAlpha},a),l=oe(e),h=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,s,o,l,n,i),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:n,framebuffer:o}:(l.dispose(!0),n.dispose(),o.detachColorTexture(),o.dispose()),e.bindFramebuffer(h),i}_drawStretchedTexture(e,a,t,s,i,o){this._passParameters.texture=i,e.bindFramebuffer(t);const n=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height),e.bindTechnique(a,this._passParameters,null),e.bindVAO(s),e.drawArrays(pe.TRIANGLE_STRIP,0,Te(s,"geometry")),e.bindFramebuffer(null),e.setViewport(n.x,n.y,n.width,n.height),this._passParameters.texture=null}unload(){if(R(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:a,sourceTexture:t}=this._powerOfTwoStretchInfo;a.dispose(!0),t.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(R(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),R(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}var x;d.DDS_ENCODING="image/vnd-ms.dds",d.KTX2_ENCODING="image/ktx2",d.BASIS_ENCODING="image/x.basis",function(r){r[r.HAVE_NOTHING=0]="HAVE_NOTHING",r[r.HAVE_METADATA=1]="HAVE_METADATA",r[r.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",r[r.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",r[r.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(x||(x={}));export{d as L,b as c};
