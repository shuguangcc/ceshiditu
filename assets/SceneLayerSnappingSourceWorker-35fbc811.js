import{e as w,n as v}from"./cast-7928d7aa.js";import{t as _,i as L}from"./typedArrayUtil-a8b5b3e9.js";import{f as V}from"./promiseUtils-6684e352.js";import"./Error-653283ae.js";import"./ensureType-cf29afa9.js";import"./string-cdf077e6.js";import{q as l,x as u,u as h}from"./vec3-a020a6f6.js";import{n as d,t as c}from"./vec3f64-2f9cef06.js";import{v as j,b as $,j as P}from"./lineSegment-e6f72ff2.js";import{R as S,g,N as b}from"./sphere-4f5e644f.js";import{q as C}from"./QueryEngineResult-665bf7fb.js";import{G as E}from"./Octree-1a841545.js";import{m as I}from"./edgeProcessing-3ca548e1.js";import"./nextTick-3ee5a785.js";import"./common-c186b691.js";import"./mathUtils-2519596a.js";import"./vec4-790471c0.js";import"./mat4-44a0988f.js";import"./vec4f64-e407da96.js";import"./byteSizeEstimations-f0cab514.js";import"./mat3f64-c6305894.js";import"./mat4f64-1e28eae0.js";import"./quatf64-7fd38d64.js";import"./vec2f64-30dc1443.js";import"./preload-helper-41c905a7.js";import"./Polyline-bf268e7b.js";import"./Extent-69509002.js";import"./Ellipsoid-89682c5e.js";import"./quantizationUtils-33aba427.js";import"./jsonUtils-03c4af61.js";import"./ItemCache-ee28c7ba.js";import"./MemCache-4b976a8b.js";import"./WhereClause-2b5b05b2.js";import"./utils-30a9a7e0.js";import"./generateRendererUtils-a996108f.js";import"./jsonMap-c1f958cf.js";import"./colorRamps-3a8ac20b.js";import"./Color-a42a8267.js";import"./colorUtils-639f4d25.js";import"./enumeration-3c281341.js";import"./Symbol-fc4312a4.js";import"./utils-1f4fcfec.js";import"./unitUtils-47abac71.js";import"./projection-d7b57a6c.js";import"./SimpleObservable-7dcdef1d.js";import"./assets-0b172f07.js";import"./request-d3e98716.js";import"./aaBoundingRect-4a760199.js";import"./zscale-1e1fc911.js";import"./normalizeUtils-ee4bf39f.js";import"./geometry-5a216427.js";import"./typeUtils-eb9416d0.js";import"./featureConversionUtils-01cdde8a.js";import"./OptimizedFeature-3de538c1.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./json-48e3ea08.js";import"./fieldUtils-31bfecd2.js";import"./arcadeOnDemand-c6d1b9f2.js";import"./plane-45609588.js";import"./Util-a48361c6.js";import"./deduplicate-b0bc48cc.js";import"./InterleavedLayout-5e9cf734.js";import"./BufferView-646ba1de.js";import"./vec2-2cef68de.js";import"./types-e1c0a5bf.js";import"./VertexAttribute-9c5c630d.js";import"./enums-64ab819c.js";import"./VertexElementDescriptor-2925c6af.js";const T=1e3;function N(t,o,i){const n=S(),e=g(n);return l(e,e,t,.5),l(e,e,o,.5),n[3]=u(e,t),h(e,e,i),n}let f=class{constructor(){this._idToComponent=new Map,this._components=new E(t=>t.bounds),this._edges=new E(t=>t.bounds),this._tmpLineSegment=j(),this._tmpP1=d(),this._tmpP2=d(),this._tmpP3=d(),this.remoteClient=null}async fetchCandidates(t,o){await Promise.resolve(),V(o),await this._ensureEdgeLocations(t,o);const i=[];return this._edges.forEachNeighbor(n=>(this._addCandidates(t,n,i),i.length<T),t.bounds),{result:{candidates:i}}}async _ensureEdgeLocations(t,o){const i=[];if(this._components.forEachNeighbor(r=>{if(_(r.info)){const{id:m,uid:s}=r;i.push({id:m,uid:s})}return!0},t.bounds),!i.length)return;const n={components:i},e=await this.remoteClient.invoke("fetchAllEdgeLocations",n,L(o,{}));for(const r of e.components)this._setFetchEdgeLocations(r)}async add(t){const o=new a(t.id,t.bounds);return this._idToComponent.set(o.id,o),this._components.add([o]),{result:{}}}async remove(t){const o=this._idToComponent.get(t.id);if(o){const i=[];this._edges.forEachNeighbor(n=>(n.component===o&&i.push(n),!0),o.bounds),this._edges.remove(i),this._components.remove([o]),this._idToComponent.delete(o.id)}return{result:{}}}_setFetchEdgeLocations(t){const o=this._idToComponent.get(t.id);if(_(o)||t.uid!==o.uid)return;const i=I.createView(t.locations),n=new Array(i.count),e=d(),r=d();for(let p=0;p<i.count;p++){i.position0.getVec(p,e),i.position1.getVec(p,r);const x=N(e,r,t.origin),y=new k(o,p,x);n[p]=y}this._edges.add(n);const{objectIds:m,origin:s}=t;o.info={locations:i,objectIds:m,origin:s}}_addCandidates(t,o,i){const{locations:n,origin:e,objectIds:r}=o.component.info,m=n.position0.getVec(o.index,this._tmpP1),s=n.position1.getVec(o.index,this._tmpP2);h(m,m,e),h(s,s,e);const p=r[n.componentIndex.get(o.index)];this._addEdgeCandidate(t,p,m,s,i),this._addVertexCandidate(t,p,m,i),this._addVertexCandidate(t,p,s,i)}_addEdgeCandidate(t,o,i,n,e){if(!(t.types&C.EDGE))return;const r=g(t.bounds),m=$(i,n,this._tmpLineSegment),s=P(m,r,this._tmpP3);if(!b(t.bounds,s))return null;e.push({type:"edge",objectId:o,target:c(s),distance:u(r,s),start:c(i),end:c(n)})}_addVertexCandidate(t,o,i,n){if(!(t.types&C.VERTEX))return;const e=g(t.bounds);if(!b(t.bounds,i))return null;n.push({type:"vertex",objectId:o,target:c(i),distance:u(e,i)})}};f=w([v("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],f);const Ot=f;class a{constructor(o,i){this.id=o,this.bounds=i,this.info=null,this.uid=++a.uid}}a.uid=0;class k{constructor(o,i,n){this.component=o,this.index=i,this.bounds=n}}export{Ot as default};
