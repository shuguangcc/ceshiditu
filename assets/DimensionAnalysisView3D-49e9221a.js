import{e as p,y as d,n as F,m as nt,t as xt,c as dt,X as De}from"./cast-7928d7aa.js";import{j as zt}from"./Collection-78126e82.js";import{s as ee}from"./Error-653283ae.js";import{t as g,r as c,i as ie,s as tt,o as Oe,h as xe,e as Ft,p as Ut}from"./typedArrayUtil-a8b5b3e9.js";import{l as S,w as A,h as mt,U as wt,f as Rt,a as Bt}from"./reactiveUtils-f41a4e00.js";import"./ensureType-cf29afa9.js";import{n as ze}from"./AnalysisView3D-70b48b15.js";import{t as y,r as Re,u as Ae}from"./LengthDimension-d35d103c.js";import{v as He,N as ke,d as Le,E as Ee}from"./unitUtils-47abac71.js";import{m as jt,b as Ve}from"./mathUtils-2519596a.js";import{v as ne,g as Ie}from"./quantityFormatUtils-ba1f6cd1.js";import{g as qt,r as Ge,i as se,x as Fe}from"./mat4-44a0988f.js";import{e as At}from"./mat4f64-1e28eae0.js";import{r as R,O as Nt,J as k,_ as j,P as E,G as oe,z as Ue,q as ct,X as Wt,v as Pt,g as st,e as ae,F as re,s as le,o as pe}from"./vec3-a020a6f6.js";import{n as b,f as W,r as ut}from"./vec3f64-2f9cef06.js";import{c as _,n as Be}from"./sphere-4f5e644f.js";import{v as je}from"./dehydratedFeatures-4eeb381a.js";import{bc as K,bd as qe,be as bt,bf as Q,bg as ot,bh as Ht,bi as Ne,bj as We,bk as Xt,bl as Xe,bm as Ye,bn as Je,bo as Ke,aU as ht,bp as Qe,bq as Ze,aQ as ti,aR as ei,aS as ii,aW as Y,x as ni,t as si,br as Yt,bs as oi,bt as de,aX as ai,aY as ri}from"./index-455b69b8.js";import{l as q,g as li}from"./Segment-97608ed7.js";import{j as pi,y as di}from"./euclideanLengthMeasurementUtils-3ebdcf15.js";import{g as mi,t as ci}from"./promiseUtils-6684e352.js";import{l as G}from"./Color-a42a8267.js";import"./geometry-5a216427.js";import{s as Ct}from"./Cyclical-b66238c6.js";import{u as H}from"./screenUtils-410d12c0.js";import{_ as $t,p as Tt,R as Jt,Y as ui}from"./plane-45609588.js";import{U as hi,i as me,x as ce,R as fi,T as gi,z as _i,D as kt}from"./manipulatorUtils-302eea16.js";import{B as yi,C as ue,z as Lt,o as vi}from"./Factory-d9ba6160.js";import{m as Si,f as Mi,s as wi}from"./MarkerSizing.glsl-c6fa192a.js";import{w as lt}from"./Extent-69509002.js";import{d as Pi}from"./HandleOwner-e1406413.js";import{w as Dt}from"./string-cdf077e6.js";import{_ as bi,a as Ci}from"./VerticesVisualElement-dd38c964.js";import{c as U,n as $i,b as Ti,a as Di}from"./LineVisualElement-69b2e868.js";import{c as z}from"./VisualVariablePassParameters-5807c7dc.js";import{p as Oi}from"./ImageMaterial-0dc3e395.js";import{t as xi}from"./nextTick-3ee5a785.js";import{a as zi,s as Ri,m as Ai,c as Hi}from"./analysisViewUtils-dbd7f679.js";import"./intl-f1e98361.js";import{l as X}from"./vec4f64-e407da96.js";import{r as ki,j as Li}from"./EffectView-d3bf37ed.js";import{r as Ei}from"./RenderTexture-efcfcb1e.js";import{s as Vi}from"./locale-30120714.js";import{u as Ii}from"./messages-be07754e.js";import"./Evented-515b9d9c.js";import"./SimpleObservable-7dcdef1d.js";import"./Promise-dfdee8ba.js";import"./Clonable-ba795b08.js";import"./jsonMap-c1f958cf.js";import"./Ellipsoid-89682c5e.js";import"./vec4-790471c0.js";import"./common-c186b691.js";import"./byteSizeEstimations-f0cab514.js";import"./mat3f64-c6305894.js";import"./quatf64-7fd38d64.js";import"./vec2f64-30dc1443.js";import"./aaBoundingBox-fc742a4e.js";import"./aaBoundingRect-4a760199.js";import"./quantizationUtils-33aba427.js";import"./jsonUtils-03c4af61.js";import"./Polyline-bf268e7b.js";import"./typeUtils-eb9416d0.js";import"./Field-f5fc9f6b.js";import"./enumeration-3c281341.js";import"./fieldType-b1002185.js";import"./Basemap-a8f7f439.js";import"./preload-helper-41c905a7.js";import"./collectionUtils-3831b7c4.js";import"./deprecate-b9088bd3.js";import"./Loadable-48bc1293.js";import"./loadAll-7fd968fe.js";import"./asyncUtils-62e8a185.js";import"./request-d3e98716.js";import"./Portal-8b65c9c4.js";import"./PortalGroup-bfe93c76.js";import"./PortalUser-4c8e1adc.js";import"./PortalItem-aa42c739.js";import"./assets-0b172f07.js";import"./writeUtils-067c4f82.js";import"./layerUtils-034678f6.js";import"./compilerUtils-034cacb8.js";import"./opacityUtils-243aae26.js";import"./CollectionFlattener-3dd1f479.js";import"./TablesMixin-e7a6aab1.js";import"./Layer-f0696768.js";import"./Identifiable-aa6d459d.js";import"./Graphic-b46e2684.js";import"./PopupTemplate-6eb885db.js";import"./fieldUtils-31bfecd2.js";import"./arcadeOnDemand-c6d1b9f2.js";import"./number-347a3a44.js";import"./symbols-fa594797.js";import"./CIMSymbol-1379245a.js";import"./Symbol-fc4312a4.js";import"./symbolLayerUtils3D-1f8d4478.js";import"./persistableUrlUtils-a16d0f55.js";import"./Symbol3DAnchorPosition2D-c0f4a14d.js";import"./workers-898a7c4c.js";import"./Connection-a681777e.js";import"./Queue-3a0c055d.js";import"./projection-d7b57a6c.js";import"./zscale-1e1fc911.js";import"./TileInfo-34f80a8e.js";import"./widget-f7489a3f.js";import"./uuid-73213768.js";import"./dom-5b7af1bf.js";import"./executeQueryJSON-bcd96e1a.js";import"./normalizeUtils-ee4bf39f.js";import"./query-922e6fbf.js";import"./pbfQueryUtils-72f9b45b.js";import"./pbf-e1a6c35b.js";import"./OptimizedFeature-3de538c1.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-d9d8ef40.js";import"./FeatureSet-0573546e.js";import"./colorUtils-639f4d25.js";import"./Query-ff8c2cfb.js";import"./TimeExtent-744afd75.js";import"./RelationshipQuery-db5fcd0c.js";import"./LegendOptions-e65e7a9c.js";import"./utils-725f8b4e.js";import"./BlendLayer-d8293c8d.js";import"./parser-2b40deea.js";import"./mat4f32-77b3d8ac.js";import"./ItemCache-ee28c7ba.js";import"./MemCache-4b976a8b.js";import"./cimSymbolUtils-2e4dde89.js";import"./utils-c81a5c52.js";import"./jsonUtils-c56f8821.js";import"./UniqueValueRenderer-103ec66d.js";import"./diffUtils-1ac65748.js";import"./colorRamps-3a8ac20b.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-c59ab38d.js";import"./lengthUtils-d2d33f94.js";import"./jsonUtils-d7db3dc7.js";import"./styleUtils-4adfed9e.js";import"./DictionaryLoader-2cf5144e.js";import"./LRUCache-14115d91.js";import"./heatmapUtils-84e8c43b.js";import"./featureConversionUtils-01cdde8a.js";import"./TopFeaturesQuery-785f5453.js";import"./FeatureLayer-a9f3e6ec.js";import"./MultiOriginJSONSupport-27362d57.js";import"./LayerFloorInfo-2cd5e8ae.js";import"./FeatureLayerBase-aebdf2da.js";import"./HeightModelInfo-22ad72d7.js";import"./arcgisLayerUrl-0b2b7691.js";import"./OperationalLayer-24e6fa34.js";import"./ElevationInfo-ce9cacc2.js";import"./editsZScale-2015e7db.js";import"./APIKeyMixin-34d76a46.js";import"./ArcGISService-ea748edf.js";import"./CustomParametersMixin-807d2055.js";import"./EditBusLayer-40671d1a.js";import"./FeatureReductionLayer-4077b2ae.js";import"./labelingInfo-5c3a46f6.js";import"./labelUtils-a194a22a.js";import"./defaultsJSON-59981e75.js";import"./OrderedLayer-e7edf19c.js";import"./PortalLayer-f1a64f99.js";import"./RefreshableLayer-1c078c47.js";import"./ScaleRangeLayer-271178b7.js";import"./TemporalLayer-39c07299.js";import"./TimeInfo-c89d0ef4.js";import"./FeatureTemplate-746d033e.js";import"./FeatureType-c83c5f49.js";import"./fieldProperties-7547b373.js";import"./FieldsIndex-aa6dd3fa.js";import"./versionUtils-92993d41.js";import"./styleUtils-da81b13f.js";import"./popupUtils-07fe66a7.js";import"./colorUtils-82440b70.js";import"./mat2d-d0b91e3e.js";import"./Scheduler-8433672d.js";import"./GraphicsLayer-10573c27.js";import"./ViewingMode-5d7d590b.js";import"./enums-0fc02184.js";import"./vec2-2cef68de.js";import"./mat3-3fc68e72.js";import"./mat3f32-d3d088e8.js";import"./vec2f32-461e65a9.js";import"./TileStrategy-4189758f.js";import"./TileStore-787dbea4.js";import"./TileKey-0750ad58.js";import"./rbush-8e36784a.js";import"./quickselect-322ec8e1.js";import"./capabilities-3636c6a4.js";import"./context-util-1e3c8cfc.js";import"./lineSegment-e6f72ff2.js";import"./scaleUtils-b32a50d8.js";import"./ElevationSamplerData-7decf898.js";import"./PhysicallyBasedRendering.glsl-a986c926.js";import"./View.glsl-8b12b8c2.js";import"./ShaderBuilder-93e8045e.js";import"./FloatPassUniform-d2dfc562.js";import"./Float4PassUniform-3a47b7b3.js";import"./RgbaFloatEncoding.glsl-6036ca34.js";import"./Texture2DPassUniform-6e8ae673.js";import"./vec3f32-c9aa289f.js";import"./VertexAttribute-9c5c630d.js";import"./Texture2DDrawUniform-22924c6f.js";import"./basicInterfaces-19ed850e.js";import"./PiUtils.glsl-0c0898f0.js";import"./ReadLinearDepth.glsl-7ff30f7d.js";import"./WaterSurface.glsl-fc8a5726.js";import"./ForwardLinearDepth.glsl-36f9eb3b.js";import"./Matrix3PassUniform-da8eddae.js";import"./Slice.glsl-a612de15.js";import"./Transform.glsl-f15542a7.js";import"./OutputHighlight.glsl-7364b03b.js";import"./MultipassTerrainTest.glsl-e79d40de.js";import"./NormalUtils.glsl-a59958d7.js";import"./AlphaCutoff-96178e0d.js";import"./TransparencyPassType-cd195b0e.js";import"./EvaluateSceneLighting.glsl-3bbc6edf.js";import"./enums-64ab819c.js";import"./Texture-e79b14e7.js";import"./SSAOBlur.glsl-c6f142fc.js";import"./ScreenSpacePass-00f8c8a4.js";import"./SSAO.glsl-6f3b4065.js";import"./FramebufferObject-50e1b68f.js";import"./ShaderTechniqueConfiguration-9f5b4555.js";import"./HUD.glsl-80cf9a21.js";import"./VerticalOffset.glsl-86460edb.js";import"./objectResourceUtils-ef6e3cdf.js";import"./devEnvironmentUtils-5002a058.js";import"./BufferView-646ba1de.js";import"./vec33-ce3aa99b.js";import"./DefaultMaterial_COLOR_GAMMA-9831d979.js";import"./types-e1c0a5bf.js";import"./Version-9baeb7ac.js";import"./quat-5b263584.js";import"./Util-a48361c6.js";import"./Texture-bbae5d9d.js";import"./TextureOnly.glsl-18701a3b.js";import"./InterleavedLayout-5e9cf734.js";import"./MixExternalColor.glsl-25f0049c.js";import"./symbolColorUtils-604c5345.js";import"./ObjectAndLayerIdColor.glsl-73c19386.js";import"./OutputDepth.glsl-179f1d8f.js";import"./VisualVariables.glsl-b8290512.js";import"./DiscardOrAdjustAlphaBlend.glsl-5f837994.js";import"./Normals.glsl-90e28525.js";import"./DefaultMaterial.glsl-b4f4cbc5.js";import"./VertexColor.glsl-db21b96c.js";import"./DefaultTechniqueConfiguration-e8962072.js";import"./RealisticTree.glsl-2b30ed32.js";import"./edgeProcessing-3ca548e1.js";import"./deduplicate-b0bc48cc.js";import"./VertexElementDescriptor-2925c6af.js";import"./projection-aa2a8986.js";import"./Octree-1a841545.js";import"./HUDMaterial.glsl-4bf3c7df.js";import"./sdfPrimitives-a24e9cb2.js";import"./floatRGBA-fa8308d2.js";import"./labelFormatUtils-4d730eaa.js";import"./I3SUtil-3ffd3baa.js";import"./I3SBinaryReader-3d2c2faa.js";import"./LineCallout.glsl-a0056465.js";import"./earcut-58237617.js";import"./QueryEngineResult-665bf7fb.js";import"./WhereClause-2b5b05b2.js";import"./utils-30a9a7e0.js";import"./generateRendererUtils-a996108f.js";import"./utils-1f4fcfec.js";import"./json-48e3ea08.js";import"./MeshComponent-f50df6af.js";import"./RibbonLine.glsl-2a3b4d4e.js";import"./LineStipple.glsl-de782d6a.js";import"./callExpressionWithFeature-a7532499.js";import"./LineMarker.glsl-8f444621.js";import"./NativeLine.glsl-cdbbf172.js";import"./Path.glsl-60b36878.js";import"./ColorMaterial.glsl-8310ffb3.js";import"./Pattern.glsl-d3388745.js";import"./LercDecoder-73115fd2.js";import"./config-1337d16e.js";import"./workerHelper-c6d4a8cb.js";import"./Subtype-5b01b21f.js";import"./datetime-4f774298.js";import"./elevationInfoUtils-427916a5.js";import"./ExportImageParameters-f328a234.js";import"./sublayerUtils-ba7f61bc.js";import"./webStyleSymbolUtils-55ed91cd.js";import"./enums-4b2a86a0.js";import"./TextOverlayItem-a6091360.js";import"./measurementUtils-c86e49dc.js";import"./ShadedColorMaterial.glsl-7dee9441.js";import"./PointVisualElement-685382db.js";import"./RightAngleQuadVisualElement-d5a5e64b.js";import"./ImageMaterial.glsl-2969e37d.js";function Gi(t,e,i){if(g(t))return null;const n=t.dimensionSegment.startRenderSpace,s=t.dimensionSegment.endRenderSpace,o=pi(n,s,t.spatialReference);if(g(o))return null;const a=e===y.Vertical?He(o.value,o.unit,i):ke(o.value,o.unit,i);return ne(o,a)}function ft(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:o}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:o}}function gt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:s},o,a=null){if(g(t)||g(e))return null;const r=fe(c(a)?a.directSegment:new q,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},o),l=c(a)?a.primaryOffsetAxis:b();yt(l,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:r,orientation:s,renderCoordsHelper:o});const m=c(a)?a.dimensionSegment:new q;return Et({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===y.Vertical?(R(m.startRenderSpace,r.startRenderSpace),R(m.endRenderSpace,r.endRenderSpace)):ge(m,{offsetAxis:l,offset:i,relativeToSegment:r,renderCoordsHelper:o}),{directSegment:r,dimensionSegment:m,primaryOffsetAxis:l,spatialReference:o.spatialReference}}function Kt(t,e,i,n){return e===et.Start?(R(t.startRenderSpace,i.startRenderSpace),R(t.endRenderSpace,n.startRenderSpace)):(R(t.startRenderSpace,i.endRenderSpace),R(t.endRenderSpace,n.endRenderSpace)),t}var et;function Fi(t,e,i,n){ct(t.startRenderSpace,e.startRenderSpace,i,n),ct(t.endRenderSpace,e.endRenderSpace,i,n)}function he(t,e,i,n){switch(e){case y.Direct:return fe(t,i,n);case y.Horizontal:case y.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,dimension:a,geometry:r}=i;let l;a.measureType===y.Direct?(l=Ui(r,n)===s.z>o.z,e===y.Horizontal&&(l=!l)):l=!Bi(r);const[m,u]=l?[s,o]:[o,s],h=K(u,ji);return e===y.Horizontal?h.z=m.z:(h.x=m.x,h.y=m.y),n.toRenderCoords(m,t.startRenderSpace),n.toRenderCoords(h,t.endRenderSpace),t}}}function fe(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Ui(t,e){const i=t.directSegment.eval(.5,_.get()),n=e.worldUpAtPosition(i,_.get()),s=t.dimensionSegment.eval(.5,_.get()),o=k(_.get(),s,i);return!oe(o,W)&&E(o,n)>0}function Bi(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=t.directSegment;return Wt(n,e)<Wt(s,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(et||(et={}));const ji=je(0,0,0,null);function qi(t,e,i,n){const{directSegment:s}=i,o=yt(_.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),a=ge(Ni,{offsetAxis:o,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,_.get()),r=k(_.get(),t,a);return E(r,o)*n.unitInMeters}const Ni=new q;function yt(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:o,endRenderSpace:a},directSegment:r,renderCoordsHelper:l}=e,m=r.eval(.5,_.get()),u=l.worldUpAtPosition(m,_.get()),h=l.worldBasisAtPosition(m,Be.Y,_.get());switch(i){case y.Horizontal:R(t,u);break;case y.Vertical:E(o,u)<E(a,u)?k(t,a,o):k(t,o,a),j(t,t,u),j(t,t,u);break;case y.Direct:{const f=ie(e.orientation,0);if(Et({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))qt(at,-jt(f),u),Nt(t,h,at);else{const M=k(_.get(),a,o),w=j(_.get(),M,u);j(w,w,M),qt(at,jt(f),M),Nt(t,w,at)}break}}return oe(t,W)?R(t,h):Ue(t,t)}const at=At();function Et({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return c(t)&&c(e)&&t.x===e.x&&t.y===e.y}function ge(t,e){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:o},relativeToSegment:a,renderCoordsHelper:r}=e,l=n/r.unitInMeters,[m,u]=Wi(s,o,i,l);return ct(t.startRenderSpace,a.startRenderSpace,i,m),ct(t.endRenderSpace,a.endRenderSpace,i,u),t}function Wi(t,e,i,n=0){const s=E(e,i),o=E(t,i),a=Math.abs(s-o)+n;return s>o?[a,n]:[n,a]}function vt(t,e,i){const n=e.directSegment.eval(.5,_.get());return i.worldUpAtPosition(n,t)}function Vt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return k(t,n,i)}function It(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return i.invert?k(t,n,s):k(t,s,n)}function Ot(t,e){const i=t.directSegment.eval(.5,_.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Xi(t,e){return Pt(It(Yi,t))/e**2}const Yi=b();function _e(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(g(e)||g(i))return!1;const n=di(e,i);return c(n)&&ne(n,"meters").value>ye}const ye=1e5;function it(t){return c(t.geometry)}let B=class extends nt{constructor(e){super(e),this._handles=new xt}initialize(){const{computations:e}=this.analysisViewData;for(const i of e)this._addComputation(i);this.addHandles(e.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}))}destroy(){this._handles=tt(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Le(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(S(()=>ft(e),i=>{const{measureType:n}=i;if(_e(i)&&n!==y.Direct){const o=Math.round(Ee(ye,"meters","kilometers"));return ee.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${o} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=gt(i,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Gi(s,n,this._defaultUnit)},A),e)}_removeComputation(e){this._handles.remove(e)}};p([d({constructOnly:!0})],B.prototype,"analysisViewData",void 0),p([d({constructOnly:!0})],B.prototype,"view",void 0),p([d()],B.prototype,"analysis",null),p([d()],B.prototype,"_defaultUnit",null),B=p([F("esri.views.3d.analysis.Dimension.support.DimensionController")],B);const ve={main:new G([255,127,0])};let Ji=class{constructor(){this.color=ve.main,this.opacity=.5,this.radius=5}};class Ki{constructor(){this.color=new G([127,127,127]),this.opacity=.5,this.radius=5}}class Qi{constructor(){this.lineSizeFraction=.8}}let Zi=class{constructor(){this.color=ve.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}};class tn{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}let en=class{constructor(){this.lineSizeFraction=.25}},nn=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}};class sn{constructor(){this.color=new G([255,127,0,.5])}}let on=class{constructor(){this.pointManipulators=new Ji,this.offsetManipulator=new Zi,this.orientationManipulator=new tn,this.markers=new Qi,this.labels=new nn,this.offsetLine=new en,this.constraint=new sn,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Ki,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};const v=new on;class an{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of Re)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case y.Direct:return this.direct;case y.Horizontal:return this.horizontal;case y.Vertical:return this.vertical}}}function rn(t,e){const i=hi(t,G.toUnitRGB(v.pointManipulators.color),v.pointManipulators.opacity,L);return i.available=!1,i.grabCursor="crosshair",i.radius=v.pointManipulators.radius,i.metadata=e.metadata,i.collisionPriority=1,i}function ln(t,e){const i=[ut(-.5,0,0),ut(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=bt(i.map(o=>st(b(),o,n)));return new me({view:t,renderObjects:[{geometry:s,material:e.unfocusedMaterial,stateMask:Q.Unfocused|Q.Selected|L},{geometry:s,material:e.focusedMaterial,stateMask:Q.Focused|L}],collisionType:{type:"line",paths:[i]},radius:Gt(e.lineSizePt)/2,metadata:e.metadata,available:!1,...ce})}function Se(t,{lineSizePt:e,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:o,discScale:a,focusMultiplier:r}=v.orientationManipulator;return{calloutLength:.25*Si*v.markers.lineSizeFraction*H(e)+n,calloutOpacity:s,calloutWidth:o,customStateMask:L,discScale:a,focusMultiplier:r,material:i,metadata:t}}function Qt(t,e){return fi(t,Se(e.metadata,e))}function Zt(t,e){gi(t,Se(t.metadata,e))}function pn(t,e){const i=[ut(-.5,0,0),ut(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=bt(i),o=bt(i.map(a=>st(b(),a,n)));return new me({view:t,renderObjects:[{geometry:o,material:e.unfocusedMaterial,stateMask:Q.Unfocused|L},{geometry:o,material:e.focusedMaterial,stateMask:Q.Focused|L},{geometry:s,material:e.thinOffsetManipulatorMaterial,stateMask:L}],collisionType:{type:"line",paths:[i]},radius:Gt(e.lineSizePt)/2,available:!1,metadata:e.metadata,...ce})}function dn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:s,snappingPipeline:o,view:a}){const r=e?"startPoint":"endPoint";return[ot(t,(m,u,h,f)=>{const M=Lt(m);h=h.next(M).next(Ht(n,[r,"measureType","orientation"])),u.next(M).next(yi(a)).next(i(h,f),o.next).next(w=>{const C=K(w.mapEnd,new lt);s(r==="startPoint"?{startPoint:C}:{endPoint:C})})})]}function mn(t,{computation:e,view:i}){return[ot(t,(n,s,o)=>{if(!it(e)||!n.selected)return;const{geometry:a,dimension:r}=e,l=Lt(n);s.next(l).next(we(i,r,a.dimensionSegment,a.primaryOffsetAxis)),o.next(l).next(Ht(r,["offset"]))})]}function cn(t,{computation:e,view:i}){return[ot(t,(n,s,o)=>{Me({cancel:o,computation:e,settingHeading:!0,steps:s,view:i})})]}function un(t,{computation:e,view:i}){return[ot(t,(n,s,o)=>{Me({cancel:o,computation:e,settingHeading:!1,steps:s,view:i})}),t.events.on("immediate-click",n=>{hn(n,e,i)})]}function hn(t,e,i){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(g(s))return;const{renderCoordsHelper:o}=i,a=gt({...ft(e),orientation:90},o),r=gt({...ft(e),orientation:270},o);if(g(a)||g(r))return;const l=Ot(a,o),m=Ot(r,o),u=Pe(s,i),h=Ct.shortestSignedDiff(u,l),f=Ct.shortestSignedDiff(u,m);n.orientation=Math.abs(h)<Math.abs(f)?90:270,t.stopPropagation()}function Me(t){const{cancel:e,computation:i,settingHeading:n,steps:s,view:o}=t;if(!it(i))return;const{renderCoordsHelper:a}=o,{dimension:r,geometry:l}=i,m=b(),u=Ce(b(),l,l.directSegment,a),h=$e(_.get(),{forHeading:n,geometry:l,renderCoordsHelper:a}),f=$t(u,h,Tt()),M=ie(r.orientation,n?()=>Ot(l,o.renderCoordsHelper):0);s.next(ue(o,f)).next(w=>{w.action==="start"&&R(m,w.renderStart);const C=ui(f),P=_i(m,w.renderEnd,u,C);let V=M-Ve(P);n||(V=fn(V)),r.orientation=V}),e.next(Ht(r,["orientation"]))}function fn(t){const e=Ct.normalize(t)%90;return e<v.orientationSnapThresholdDegrees?t-e:90-e<v.orientationSnapThresholdDegrees?t+(90-e):t}function gn(t,{computation:e,manipulatorMeasureType:i,view:n}){let s=y.Direct,o=0,a=0;return[t.events.on("grab-changed",r=>{if(r.action!=="start"||!it(e))return;const{dimension:l,geometry:m}=e;s=l.measureType,o=l.offset,a=l.orientation;const u=R(_.get(),t.renderLocation);l.measureType=i,l.offset=qi(u,i,m,n.renderCoordsHelper),l.orientation=0}),ot(t,(r,l,m)=>{if(!it(e))return;const{geometry:u,dimension:h}=e,{renderCoordsHelper:f}=n,M=he(Te,i,e,f),w=yt(_.get(),{measureType:i,directSegment:u.directSegment,renderCoordsHelper:f}),C=Lt(r);l.next(C).next(we(n,h,M,w)),m.next(C).next(P=>(h.measureType=s,h.offset=o,h.orientation=a,P))})]}function we(t,e,i,n){const s=ae(_.get(),i.endRenderSpace,i.startRenderSpace);j(s,s,n);const o=$t(i.startRenderSpace,s,Tt()),a=$t(i.startRenderSpace,n,Tt()),r=e.offset;let l,m=0;const u=new Ne;return u.next(ue(t,o)).next(h=>{h.action==="start"&&(m=Jt(a,h.renderStart));const f=(Jt(a,h.renderEnd)-m)*t.renderCoordsHelper.unitInMeters;e.offset=r+f,l=h}),h=>(u.execute(h),l)}function Pe(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,s=vt(_.get(),t,n),o=Vt(_.get(),t),a=j(_.get(),o,s),{viewForward:r}=e.state.camera;E(a,r)>0&&st(a,a,-1);const l=i.eval(.5,_.get());return n.headingAtPosition(l,a)}function _n(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:s}=e,o=It(Z,e),a=re(o,W)?Ge(_t):kt(o,s,W,_t),r=Math.max(le(o),v.offsetManipulator.minLengthMeters/i.unitInMeters);se(a,a,pe(Z,r,r,r)),t.modelTransform=a,t.renderLocation=n.eval(.5,Z)}function yn(t,e,i){be(t,e,i,{forHeading:!0})}function vn(t,e,i){be(t,e,i,{forHeading:!1})}function be(t,e,i,{forHeading:n}){const{dimension:s,geometry:o}=e,{primaryOffsetAxis:a}=o,r=st(Sn,a,s.offset>=0?1:-1),l=$e(Mn,{forHeading:n,geometry:o,renderCoordsHelper:i});j(l,l,r);const m=kt(r,l,W,_t);t.modelTransform=m,t.renderLocation=Ce(Z,o,o.dimensionSegment,i)}const Sn=b(),Mn=b();function wn(t,e,i,n){const{geometry:s}=e,o=he(Te,i,e,n),a=yt(Z,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),r=k(St,o.endRenderSpace,o.startRenderSpace),l=kt(r,a,W,_t),m=le(r);se(l,l,pe(St,m,m,m)),t.modelTransform=l,t.renderLocation=o.eval(.5,St)}function Ce(t,e,i,n){const{startRenderSpace:s,endRenderSpace:o}=i,a=Pn(e,n)?s:o;return R(t,a)}function $e(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?vt(t,i,n):It(t,i,{invert:!0})}function Pn(t,e){const i=Vt(bn,t),n=vt(Cn,t,e);return E(i,n)>0}const bn=b(),Cn=b();function $n(t){return H(t)+v.offsetManipulator.linePaddingPx}function Gt(t){return H(t)+v.offsetManipulator.focusedLinePaddingPx}const L=qe.Custom1,Z=b(),St=b(),_t=At(),Te=new q;var x;function rt(t,e){if(_e(t))return x.Direct;const{geometry:i}=t;if(g(i)||re(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=v,{camera:s}=e.state,o=vt(_.get(),i,e.renderCoordsHelper),a=Vt(_.get(),i),r=st(_.get(),o,E(a,o)),l=ae(_.get(),a,r),m=Pt(l),u=Pt(r),{startRenderSpace:h,endRenderSpace:f}=i.directSegment,M=Math.max(s.computeRenderPixelSizeAt(h)*n,s.computeRenderPixelSizeAt(f)*n)**2;return m<M?x.Vertical:u<M?x.Horizontal:null}function Tn(t,e,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,unconstrainedGeometry:a,view:r}=i,{dimension:l,previousConstraint:m,preConstraintProperties:u}=t;if(g(s)||g(o))return;const h=()=>{"startPoint"in e?l.startPoint=e.startPoint:"endPoint"in e&&(l.endPoint=e.endPoint)};if(g(n))h(),c(m)&&c(u)&&(l.measureType=u.measureType,l.orientation=u.orientation);else switch(l.measureType=y.Direct,n){case x.Horizontal:if(n!==m&&(l.orientation=0),"startPoint"in e){const f=e.startPoint;c(f)&&(f.z=o.z),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;c(f)&&(f.z=s.z),l.endPoint=f}break;case x.Vertical:if(n!==m&&(l.orientation=Pe(a,r)),"startPoint"in e){const f=e.startPoint;c(f)&&(f.x=o.x,f.y=o.y),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;c(f)&&(f.x=s.x,f.y=s.y),l.endPoint=f}break;case x.Direct:n!==m&&c(u)&&(l.orientation=u.orientation),h()}t.previousConstraint=n}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(x||(x={}));function Dn(t,e){const i=new We({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(e==null?void 0:e.distance)??Xt.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??Xt.touchSensitivityMultiplier});return{...S(()=>{var n,s;return((s=(n=t.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{i.featureSources=new zt(n.map(s=>new Xe({layer:s,enabled:!0})))},mt),options:i}}const pt=new Map;function On(t){if(!pt.has(t)){const n=Dn(t,{distance:10}),s=zn(t,n.options);pt.set(t,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=pt.get(t);e.referenceCount++;const i=dt(()=>xn(t,e));return{snappingManager:e.snappingManager,...i}}function xn(t,e){e.referenceCount--,e.referenceCount>0||xi(()=>{e.referenceCount===0&&(e.remove(),pt.delete(t))})}function zn(t,e){return new Ye({view:t,options:e,snappingEnginesFactory:(i,n)=>[new Je({view:t,spatialReference:t.spatialReference,options:n})]})}let $=class extends Pi{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new xt,this._snappingPipeline=new Ke,this._snappingManagerResult=On(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=Mt(),this._focusedOffsetManipulatorMaterial=Mt(),this._thinOffsetManipulatorMaterial=Mt(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:ht(2)}),this._constraintSnappingIndicator=new U({view:t.view,attached:!0,width:1,color:G.toUnitRGBA(v.constraint.color),renderOccluded:z.OccludeAndTransparent,stipplePattern:ht(5)});const e=G.toUnitRGBA(v.disabledPointIndicator.color);e[3]*=v.disabledPointIndicator.opacity,this._stagedStartIndicator=new bi({view:t.view,attached:!1,color:e,size:2*v.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:z.OccludeAndTransparent})}initialize(){this._snappingOperation=new Qe({view:this.view}),this._orientationManipulatorTexture=vi(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new Oi({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:z.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",e=>this._addComputation(e.item)),t.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:i})=>{if(g(i)||g(e))return;const n=K(e,new lt);this._applyPointUpdate(i,{endPoint:n})},wt),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:o}=e;if(n===i.stagedDimension&&o===i.firstGrabbedManipulator){for(const a of[s,i.selectedComputation])if(c(a)){const r=this._computationManipulators.get(a);this._updateManipulators(a,r,e)}}else for(const[a,r]of this._computationManipulators)this._updateManipulators(a,r,e)},A),S(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},mt),S(()=>this.view.state.camera,()=>{c(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>Oe(this._stagedComputation,e=>{const i=e.elevationAlignedStartPoint,n=b();return c(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),e=>{c(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles)}destroy(){this._snappingOperation=tt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(c(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&c(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return g(t)||g(e)||e.dimension!==t?null:e}get _constraintHandles(){return[Rt(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=rt(t,this.view)},{...A,equals:Dt}),S(()=>{const t=this._activeComputation;if(g(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(c(t)&&g(e)){const{measureType:i,orientation:n,computation:s}=t;switch(s.previousConstraint){case x.Horizontal:s.preConstraintProperties={measureType:y.Horizontal,orientation:0};break;case x.Vertical:s.preConstraintProperties={measureType:y.Vertical,orientation:0};break;case x.Direct:s.preConstraintProperties={measureType:y.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(t)&&c(e)&&(e.computation.preConstraintProperties=null)},wt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),g(i))n.attached=!1;else if(i===e)n.attached=!0;else{const{start:s,end:o}=this._computationManipulators.get(i),a=()=>{n.attached=s.grabbing||o.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),o.events.on("grab-changed",a)],t)}}),S(()=>{const e=this._activeComputation;return c(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;c(e)&&c(i)&&i!==x.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!c(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(g(e)){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._snappingContext(e);this.updatingHandles.addPromise(mi(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){c(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const s=this._snappingContext(e);i=this._snappingManager.update({point:t,context:s})}const n=new Ae({startPoint:K(i,new lt),endPoint:null,measureType:y.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(g(i))return;let n=t;if(e==="mouse"){const o=this._snappingContext(e);n=this._snappingManager.update({point:t,context:o})}const s=K(n,new lt);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),o=this._setupRotationManipulator(t),a=this._setupMeasureTypeManipulator(t,y.Direct),r=this._setupMeasureTypeManipulator(t,y.Horizontal),l=this._setupMeasureTypeManipulator(t,y.Vertical),m=new an({start:e,end:i,offset:n,heading:s,rotation:o,direct:a,horizontal:r,vertical:l});this._setupComputationToManipulatorsSync(t,m),this._computationManipulators.set(t,m),this.manipulators.addMany(m.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!g(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const i of e.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([S(()=>t.geometry,()=>this._updateManipulators(t,e),{...A,equals:Dt})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,s=rn(i,{metadata:n}),o=dn(s,{isStart:e.isStart,createSnappingPipelineStep:(a,r)=>this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(r),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles,cancel:a}),dimension:n,onUpdate:a=>{this._applyPointUpdate(t,a)},snappingPipeline:this._snappingPipeline,view:i});return this._computationHandles.add(o,t),s}_setupOffsetManipulator(t){const{view:e}=this,i=ln(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=mn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=Qt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=cn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=Qt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=un(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=pn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),s=gn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(s,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:o}=i,{start:a,end:r,offset:l,heading:m,rotation:u}=e,h=s===t,f=it(t),{dimension:M}=t;for(const P of e.values()){const V=f&&g(n)&&(g(o)||P===o);P===l?(P.available=V,P.selected=h):P.available=V&&h}if(!f)return;c(rt(t,this.view))?e.forEachMeasureTypeManipulator(P=>P.available=!1):e.manipulatorForMeasureType(M.measureType).available=!1;for(const P of[m,u])M.measureType===y.Direct&&M.offset!==0||(P.available=!1);Et(t)?u.available=!1:m.available=!1;const{geometry:w}=t;a.renderLocation=w.directSegment.startRenderSpace,r.renderLocation=w.directSegment.endRenderSpace;const{renderCoordsHelper:C}=this.view;_n(l,w,C),m.available&&yn(m,t,C),u.available&&vn(u,t,C),e.forEachMeasureTypeManipulator((P,V)=>{P.available&&wn(P,t,V,C)})}_updateManipulatorStyle(t){const e=$n(t),i=Gt(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:o,rotation:a}of this._computationManipulators.values())s.radius=i/2,Zt(o,n),Zt(a,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_snappingContext(t){return new Ze({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new ti(new ei("point",ii(!0,!1,this.view.spatialReference))),visualizer:new Ci})}_applyPointUpdate(t,e){const{view:i}=this,n=ft(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=gt(n,i.renderCoordsHelper);if(g(s))return;const o=rt({...n,geometry:s},i);Tn(t,e,{...n,constraint:o,unconstrainedGeometry:s,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(g(t.geometry))return;t.geometry.directSegment.eval(.5,te);const e=this.view.state.camera.computeRenderPixelSizeAt(te);t.dimension.offset=v.initialOffsetPx*e}get testInfo(){const t=e=>this.analysisViewData.computations.find(i=>i.dimension===e);return{getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return c(i)?rt(i,this.view):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function Mt(){const{color:t,opacity:e}=v.offsetManipulator;return new Y({color:[...G.toUnitRGB(t),e],width:1,renderOccluded:z.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}p([d({constructOnly:!0})],$.prototype,"analysis",void 0),p([d({constructOnly:!0})],$.prototype,"analysisViewData",void 0),p([d({constructOnly:!0})],$.prototype,"manipulators",void 0),p([d({constructOnly:!0})],$.prototype,"parentTool",void 0),p([d({constructOnly:!0,nonNullable:!0})],$.prototype,"view",void 0),p([d({readOnly:!0})],$.prototype,"updating",null),p([d()],$.prototype,"firstGrabbedManipulator",null),p([d()],$.prototype,"hasGrabbedManipulators",null),p([d()],$.prototype,"_stagedDimension",void 0),p([d()],$.prototype,"_activeComputation",null),p([d()],$.prototype,"_stagedComputation",null),$=p([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],$);const te=b();var N;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(N||(N={}));let D=class extends zi{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=v.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=ni(this.view.state.viewingMode),this._intersector.options.store=si.MIN,this._lengthDimensionSubTool=new $({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([De(this._lengthDimensionSubTool),dt(()=>this._clearPointerMoveTimeout()),S(()=>this.state,t=>{t===N.Created&&this.finishToolCreation()},A),Rt(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},A),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),A)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?c(this._activeSubTool)?N.Creating:N.Created:N.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Yt.cancel===t.key){if(c(this._activeSubTool)&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Yt.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){c(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(g(this._activeSubTool))return;const e=this._intersectScreen(t);g(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);g(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){c(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=oi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=_.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){c(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=xe(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>{t.manipulator.state|=L}),this._prevPointerMoveTimeout=ci.setTimeout(()=>{this.manipulators.forEach(t=>{t.manipulator.state&=~L})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};p([d({constructOnly:!0})],D.prototype,"view",void 0),p([d({constructOnly:!0})],D.prototype,"analysis",void 0),p([d({readOnly:!0})],D.prototype,"state",null),p([d({readOnly:!0})],D.prototype,"updating",null),p([d({readOnly:!0})],D.prototype,"cursor",null),p([d({constructOnly:!0})],D.prototype,"analysisViewData",void 0),p([d()],D.prototype,"selectedDimension",null),p([d()],D.prototype,"automaticManipulatorSelection",void 0),p([d()],D.prototype,"_activeSubTool",void 0),p([d()],D.prototype,"_lengthDimensionSubTool",void 0),D=p([F("esri.views.3d.analysis.Dimension.DimensionTool")],D);let Rn=class extends $i{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=z.OccludeAndTransparent,this._width=1,this._color=ki(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=c(i),this.applyProps(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=Fe(An,n),this._normal=i;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return c(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,c(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return c(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,c(this._material)&&this._material.setParameters({width:e})}get color(){return c(this._material)?this._material.parameters.color:this._color}set color(e){this._color=Li(e),c(this._material)&&this._material.setParameters({color:this._color})}get placement(){return c(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,c(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return c(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,c(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new de({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of ai(this.geometry,this.normal)){const n=ri(i);e.addGeometry(n,Ft(this._material))}}forEachExternalMaterial(e){this._hasExternalMaterial||e(Ft(this._material))}};const An=At();class Hn{constructor(e){this.destroyed=!1,this._handles=new xt,this._messages=null,this._labelSegment=new q;const{analysis:i,computation:n,view:s,messages:o}=e;this.analysis=i,this.computation=n,this.view=s,this._messages=o;const a=e.visible,r={view:s,attached:a},{fontSize:l,textColor:m,textBackgroundColor:u}=i.style;this._visualElements=new In({marker:new Rn(r,e.markerMaterial),dimension:new U(r,e.dimensionLineMaterial),startOffset:new U(r,e.offsetLineMaterial),endOffset:new U(r,e.offsetLineMaterial),dimensionSmall:new U(r,e.smallDimensionLineMaterial),startOffsetSmall:new U(r,e.smallOffsetLineMaterial),endOffsetSmall:new U(r,e.smallOffsetLineMaterial),label:new li({view:s,attached:a,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:H(l),textColor:m.clone(),backgroundColor:u.clone()})}),this._handles.add([S(()=>n.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,i.style),c(n.geometry)&&this._updateLines(n.geometry)},{...mt,equals:Dt}),S(()=>n.length,h=>this._updateLabelContent(h),mt)])}set visible(e){for(const i of this._visualElements.values())i.attached=e}destroy(){this.destroyed=!0,this._handles=tt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const i=Kt(Ln,et.Start,e.directSegment,e.dimensionSegment),n=Kt(En,et.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const s=this._visualElements;if(g(i)){for(const C of s.values())C.visible=!1;return}const o=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Vn)),a=Xi(i,o),r=a<(H(n.lineSize)*v.smallScreenLengthLineSizeFactor)**2,l=!r;s.marker.visible=l,s.dimension.visible=l,s.startOffset.visible=l,s.endOffset.visible=l,s.dimensionSmall.visible=r,s.startOffsetSmall.visible=r,s.endOffsetSmall.visible=r;const m=H(n.fontSize)*v.labels.minScreenLengthFontSizeFactor,{label:u}=s;if(a<m**2)return void(u.visible=!1);u.visible=!0;const{dimensionSegment:h,primaryOffsetAxis:f}=i,{offset:M}=this.computation.dimension,w=(Math.sign(M)>=0?1:-1)*kn(n)*o;Fi(this._labelSegment,h,f,w),u.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=H(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;g(e)||g(this._messages)?i.text="":i.text=Ie(this._messages,e,e.unit)}}function kn(t){return 1.5*H(t.fontSize)+v.labels.marginPx+H(t.lineSize/2)}const Ln=new q,En=new q,Vn=b();class In{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Gn=class{constructor(e,i){this._textures=e,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const i=Mi(this._textures,e),n=new Ei(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(e,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:i})=>{i.dispose(),e.release()}),this._texturesByPrimitive.clear()}},I=class extends nt{constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new de({width:1,anchor:wi.Tip,color:X,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:z.OccludeAndTransparent}),this._dimensionLineMaterial=new Y({width:1,color:X,renderOccluded:z.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new Y({width:1,color:X,renderOccluded:z.OccludeAndTransparent,stipplePattern:ht(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new Y({width:1,color:X,renderOccluded:z.OccludeAndTransparent}),this._smallOffsetLineMaterial=new Y({width:1,color:X,renderOccluded:z.OccludeAndTransparent,stipplePattern:ht(5),stippleScaleWithLineWidth:!0})}get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}initialize(){const{textures:t}=this.view.sharedSymbolResources;if(c(t)){const{textureRepository:i}=this.view._stage.renderView,n=new Gn(t,i),s=n.acquire("triangle");this.addHandles(dt(()=>n.destroy())),this._markerMaterial.setParameters({textureId:s.id})}for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(dt(()=>{this.view._stage.remove(i),i.dispose()}));const{computations:e}=this.analysisViewData;for(const i of e)this._addComputation(i);this.addHandles([e.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}),S(()=>G.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},A),S(()=>this.analysis.style.lineSize,i=>{const n=H(i);this._markerMaterial.setParameters({width:n*v.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const s=Math.max(n*v.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:s})},A),S(()=>({camera:this.view.state.camera,style:Fn(this.analysis)}),({camera:i,style:n})=>{for(const[s,o]of this._dimensionVisualizations)o.updateCameraDependentElements(i,s.geometry,n),o.updateLabelStyle(n)}),S(()=>this.visible,i=>{for(const n of this._dimensionVisualizations.values())n.visible=i})]),this.addHandles([Vi(()=>this._updateMessageBundle()),Rt(()=>!this.loadingMessages,()=>{for(const i of this._dimensionVisualizations.values())i.updateUnitsMessages(this._messages)},wt)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:z.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Hn({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);g(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Ii("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Fn(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:s}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}p([d({constructOnly:!0})],I.prototype,"analysisViewData",void 0),p([d({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),p([d()],I.prototype,"analysis",null),p([d()],I.prototype,"visible",null),p([d()],I.prototype,"loadingMessages",void 0),I=p([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],I);let J=class extends nt{constructor(t){super(t),this.dimension=null,this.length=null}};p([d({constructOnly:!0,nonNullable:!0})],J.prototype,"dimension",void 0),p([d()],J.prototype,"length",void 0),J=p([F("esri.views.3d.analysis.LengthDimensionResult")],J);const Un=J;let O=class extends nt{constructor(t){super(t),this.geometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Un({dimension:e}),...i}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),A),S(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),A)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};p([d({constructOnly:!0,nonNullable:!0})],O.prototype,"result",void 0),p([d({constructOnly:!0,nonNullable:!0})],O.prototype,"projectAndAlignPoint",void 0),p([d()],O.prototype,"dimension",null),p([d()],O.prototype,"length",null),p([d()],O.prototype,"geometry",void 0),p([d()],O.prototype,"elevationAlignedStartPoint",void 0),p([d()],O.prototype,"elevationAlignedEndPoint",void 0),p([d()],O.prototype,"preConstraintProperties",void 0),p([d()],O.prototype,"previousConstraint",void 0),O=p([F("esri.views.3d.analysis.LengthDimensionComputation")],O);const Bn=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new zt}createLengthDimensions(i){throw new Error("Method not implemented.")}};return p([d({constructOnly:!0})],e.prototype,"view",void 0),p([d({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),p([d()],e.prototype,"tool",void 0),p([d({readOnly:!0})],e.prototype,"results",null),p([d()],e.prototype,"selectedDimension",void 0),p([d()],e.prototype,"interactive",void 0),p([d()],e.prototype,"visible",void 0),e=p([F("esri.views.analysis.DimensionAnalysisView")],e),e};let T=class extends Bn(ze(nt)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new zt,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(g(t))return null;const{spatialReference:e,elevationProvider:i}=this.view,n=Ti(t,e,i);return g(n)&&Di(this.analysis,t.spatialReference,ee.getLogger(this.declaredClass)),n},this.addHandles([Ri(this,D),Bt(()=>this.analysis.dimensions,"after-add",t=>this._onDimensionAdd(t.item),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),Bt(()=>this.analysis.dimensions,"after-remove",t=>this._onDimensionRemove(t.item))]),this._analysisVisualization=new I({analysisViewData:this,view:this.view}),this._analysisController=new B({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Ut(this._placementTask),this._analysisVisualization=tt(this._analysisVisualization),Ai(this)}get updating(){var t;return((t=this._analysisVisualization)==null?void 0:t.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return g(t)?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=Ut(this._placementTask),this._placementTask=Hi(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:i}=this;if(i.has(t))return;const n=new O({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),i.set(t,n)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:i}=this,n=e.findIndex(o=>o.dimension===t),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),i.delete(t),tt(s)}_onDimensionsClear(){this.computations.drain(t=>t.destroy()),this._dimensionsToComputations.clear()}};p([d({readOnly:!0})],T.prototype,"type",void 0),p([d()],T.prototype,"tool",void 0),p([d()],T.prototype,"updating",null),p([d({readOnly:!0})],T.prototype,"results",null),p([d({readOnly:!0})],T.prototype,"computations",void 0),p([d()],T.prototype,"selectedDimension",void 0),p([d()],T.prototype,"selectedComputation",null),p([d()],T.prototype,"_analysisVisualization",void 0),p([d()],T.prototype,"_analysisController",void 0),p([d()],T.prototype,"_dimensionsToComputations",void 0),p([d()],T.prototype,"_placementTask",void 0),T=p([F("esri.views.3d.analysis.DimensionAnalysisView3D")],T);const Mp=T;export{Mp as default};
