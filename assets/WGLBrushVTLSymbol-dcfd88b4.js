import{f as K}from"./mathUtils-2519596a.js";import{r as V,t as W}from"./typedArrayUtil-a8b5b3e9.js";import{e as ot}from"./mat3f32-d3d088e8.js";import{r as lt}from"./EffectView-d3bf37ed.js";import{Z as A,_ as at,$ as Z}from"./definitions-2d0dd0cd.js";import{I as C}from"./enums-4ca4641f.js";import{M as j}from"./number-954e4ab6.js";import{E as ft,b as ct}from"./FramebufferObject-50e1b68f.js";import{L as $,I as k,E as O,F as ut,C as z}from"./enums-64ab819c.js";import{r as B,l as N,n as J}from"./StyleDefinition-7d58136b.js";import{n as dt,t as pt}from"./vec2f32-461e65a9.js";import{e as tt}from"./config-1337d16e.js";import{M as et}from"./GeometryUtils-c093d234.js";class Q{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(r,t){}draw(r,t,e){}drawMany(r,t,e){for(const l of t)l.visible&&this.draw(r,l,e)}}class St extends Q{constructor(){super(...arguments),this._color=lt(1,0,0,1),this._patternMatrix=ot(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(r,t){const{context:e,painter:l,styleLayerUID:o,requestRender:i,allowDelayedRender:U}=r;this._loadWGLResources(r);const y=r.displayLevel,f=r.styleLayer,P=f.backgroundMaterial,_=l.vectorTilesMaterialManager,v=f.getPaintValue("background-color",y),m=f.getPaintValue("background-opacity",y),S=f.getPaintValue("background-pattern",y),D=S!==void 0,E=v[3]*m,I=1|window.devicePixelRatio,h=r.spriteMosaic;let x,T;const c=I>at?2:1,d=r.drawPhase===C.HITTEST,p=this._programOptions;p.id=d,p.pattern=D;const n=_.getMaterialProgram(e,P,p);if(U&&V(i)&&!n.isCompiled)i();else{if(e.bindVAO(this._vao),e.useProgram(n),D){const s=h.getMosaicItemPosition(S,!0);if(V(s)){const{tl:u,br:a,page:M}=s;x=a[0]-u[0],T=a[1]-u[1];const g=h.getPageSize(M);V(g)&&(h.bind(e,$.LINEAR,M,A),n.setUniform4f("u_tlbr",u[0],u[1],a[0],a[1]),n.setUniform2fv("u_mosaicSize",g),n.setUniform1i("u_texture",A))}n.setUniform1f("u_opacity",m)}else this._color[0]=E*v[0],this._color[1]=E*v[1],this._color[2]=E*v[2],this._color[3]=E,n.setUniform4fv("u_color",this._color);if(n.setUniform1f("u_depth",f.z||0),d){const s=j(o+1);n.setUniform4fv("u_id",s)}for(const s of t){if(n.setUniform1f("u_coord_range",s.rangeX),n.setUniformMatrix3fv("u_dvsMat3",s.transforms.dvs),D){const u=Math.max(2**(Math.round(y)-s.key.level),1),a=c*s.width*u,M=a/K(x),g=a/K(T);this._patternMatrix[0]=M,this._patternMatrix[4]=g,n.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}e.setStencilFunction(k.EQUAL,0,255),e.drawArrays(O.TRIANGLE_STRIP,0,4)}}}_loadWGLResources(r){if(this._vao)return;const{context:t,styleLayer:e}=r,l=e.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),i=ft.createVertex(t,ut.STATIC_DRAW,o),U=new ct(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:i});this._vao=U}}let Dt=class extends Q{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(r,t){const{context:e,displayLevel:l,requiredLevel:o,state:i,drawPhase:U,painter:y,spriteMosaic:f,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=r;if(!t.some(p=>{var n;return((n=p.layerData.get(P))==null?void 0:n.circleIndexCount)??!1}))return;const m=r.styleLayer,S=m.circleMaterial,D=y.vectorTilesMaterialManager,E=1.2,I=m.getPaintValue("circle-translate",l),h=m.getPaintValue("circle-translate-anchor",l),x=U===C.HITTEST,T=this._programOptions;T.id=x;const c=D.getMaterialProgram(e,S,T);if(v&&V(_)&&!c.isCompiled)return void _();e.useProgram(c),c.setUniformMatrix3fv("u_displayMat3",h===B.VIEWPORT?i.displayMat3:i.displayViewMat3),c.setUniform2fv("u_circleTranslation",I),c.setUniform1f("u_depth",m.z),c.setUniform1f("u_antialiasingWidth",E);let d=-1;if(x){const p=j(P+1);c.setUniform4fv("u_id",p)}for(const p of t){if(!p.layerData.has(P))continue;p.key.level!==d&&(d=p.key.level,S.setDataUniforms(c,l,m,d,f));const n=p.layerData.get(P);if(!n.circleIndexCount)continue;n.prepareForRendering(e);const s=n.circleVertexArrayObject;W(s)||(e.bindVAO(s),c.setUniformMatrix3fv("u_dvsMat3",p.transforms.dvs),o!==p.key.level?e.setStencilFunction(k.EQUAL,p.stencilRef,255):e.setStencilFunction(k.GREATER,255,255),e.drawElements(O.TRIANGLES,n.circleIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.circleIndexStart),p.triangleCount+=n.circleIndexCount/3)}}};const it=1/65536;class wt extends Q{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(r,t){const{displayLevel:e,drawPhase:l,renderPass:o,spriteMosaic:i,styleLayerUID:U}=r;let y=!1;for(const c of t)if(c.layerData.has(U)){const d=c.layerData.get(U);if(d.fillIndexCount>0||d.outlineIndexCount>0){y=!0;break}}if(!y)return;const f=r.styleLayer,P=f.getPaintProperty("fill-pattern"),_=P!==void 0,v=_&&P.isDataDriven;let m;if(_&&!v){const c=P.getValue(e);m=i.getMosaicItemPosition(c,!0)}const S=!_&&f.getPaintValue("fill-antialias",e);let D=!0,E=1;if(!_){const c=f.getPaintProperty("fill-color"),d=f.getPaintProperty("fill-opacity");if(!(c!=null&&c.isDataDriven)&&!(d!=null&&d.isDataDriven)){const p=f.getPaintValue("fill-color",e);E=f.getPaintValue("fill-opacity",e)*p[3],E>=1&&(D=!1)}}if(D&&o==="opaque")return;let I;l===C.HITTEST&&(I=j(U+1));const h=f.getPaintValue("fill-translate",e),x=f.getPaintValue("fill-translate-anchor",e);(D||o!=="translucent")&&this._drawFill(r,U,f,t,h,x,_,m,v,I);const T=!f.hasDataDrivenOutlineColor&&f.outlineUsesFillColor&&E<1;S&&o!=="opaque"&&!T&&this._drawOutline(r,U,f,t,h,x,I)}_drawFill(r,t,e,l,o,i,U,y,f,P){if(U&&!f&&W(y))return;const{context:_,displayLevel:v,state:m,drawPhase:S,painter:D,pixelRatio:E,spriteMosaic:I,requestRender:h,allowDelayedRender:x}=r,T=e.fillMaterial,c=D.vectorTilesMaterialManager,d=E>at?2:1,p=S===C.HITTEST,n=this._fillProgramOptions;n.id=p,n.pattern=U;const s=c.getMaterialProgram(_,T,n);if(x&&V(h)&&!s.isCompiled)return void h();if(_.useProgram(s),V(y)){const{page:a}=y,M=I.getPageSize(a);V(M)&&(I.bind(_,$.LINEAR,a,A),s.setUniform2fv("u_mosaicSize",M),s.setUniform1i("u_texture",A))}s.setUniformMatrix3fv("u_displayMat3",i===B.VIEWPORT?m.displayMat3:m.displayViewMat3),s.setUniform2fv("u_fillTranslation",o),s.setUniform1f("u_depth",e.z+it),p&&s.setUniform4fv("u_id",P);let u=-1;for(const a of l){if(!a.layerData.has(t))continue;a.key.level!==u&&(u=a.key.level,T.setDataUniforms(s,v,e,u,I));const M=a.layerData.get(t);if(!M.fillIndexCount)continue;M.prepareForRendering(_);const g=M.fillVertexArrayObject;if(!W(g)){if(_.bindVAO(g),s.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),_.setStencilFunction(k.EQUAL,a.stencilRef,255),U){const L=Math.max(2**(Math.round(v)-a.key.level),1),w=a.rangeX/(d*a.width*L);s.setUniform1f("u_patternFactor",w)}if(f){const L=M.patternMap;if(!L)continue;for(const[w,G]of L){const F=I.getPageSize(w);V(F)&&(I.bind(_,$.LINEAR,w,A),s.setUniform2fv("u_mosaicSize",F),s.setUniform1i("u_texture",A),_.drawElements(O.TRIANGLES,G[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*G[0]))}}else _.drawElements(O.TRIANGLES,M.fillIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*M.fillIndexStart);a.triangleCount+=M.fillIndexCount/3}}}_drawOutline(r,t,e,l,o,i,U){const{context:y,displayLevel:f,state:P,drawPhase:_,painter:v,pixelRatio:m,spriteMosaic:S,requestRender:D,allowDelayedRender:E}=r,I=e.outlineMaterial,h=v.vectorTilesMaterialManager,x=.75/m,T=_===C.HITTEST,c=this._outlineProgramOptions;c.id=T;const d=h.getMaterialProgram(y,I,c);if(E&&V(D)&&!d.isCompiled)return void D();y.useProgram(d),d.setUniformMatrix3fv("u_displayMat3",i===B.VIEWPORT?P.displayMat3:P.displayViewMat3),d.setUniform2fv("u_fillTranslation",o),d.setUniform1f("u_depth",e.z+it),d.setUniform1f("u_outline_width",x),T&&d.setUniform4fv("u_id",U);let p=-1;for(const n of l){if(!n.layerData.has(t))continue;n.key.level!==p&&(p=n.key.level,I.setDataUniforms(d,f,e,p,S));const s=n.layerData.get(t);if(s.prepareForRendering(y),!s.outlineIndexCount)continue;const u=s.outlineVertexArrayObject;W(u)||(y.bindVAO(u),d.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),y.setStencilFunction(k.EQUAL,n.stencilRef,255),y.drawElements(O.TRIANGLES,s.outlineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.outlineIndexStart),n.triangleCount+=s.outlineIndexCount/3)}}}class Vt extends Q{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(r,t){const{context:e,displayLevel:l,state:o,drawPhase:i,painter:U,pixelRatio:y,spriteMosaic:f,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=r;if(!t.some(g=>{var L;return((L=g.layerData.get(P))==null?void 0:L.lineIndexCount)??!1}))return;const m=r.styleLayer,S=m.lineMaterial,D=U.vectorTilesMaterialManager,E=m.getPaintValue("line-translate",l),I=m.getPaintValue("line-translate-anchor",l),h=m.getPaintProperty("line-pattern"),x=h!==void 0,T=x&&h.isDataDriven;let c,d;if(x&&!T){const g=h.getValue(l);c=f.getMosaicItemPosition(g)}let p=!1;if(!x){const g=m.getPaintProperty("line-dasharray");if(d=g!==void 0,p=d&&g.isDataDriven,d&&!p){const L=g.getValue(l),w=m.getDashKey(L,m.getLayoutValue("line-cap",l));c=f.getMosaicItemPosition(w)}}const n=1/y,s=i===C.HITTEST,u=this._programOptions;u.id=s,u.pattern=x,u.sdf=d;const a=D.getMaterialProgram(e,S,u);if(v&&V(_)&&!a.isCompiled)return void _();if(e.useProgram(a),a.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),a.setUniformMatrix3fv("u_displayMat3",I===B.VIEWPORT?o.displayMat3:o.displayViewMat3),a.setUniform2fv("u_lineTranslation",E),a.setUniform1f("u_depth",m.z),a.setUniform1f("u_antialiasing",n),s){const g=j(P+1);a.setUniform4fv("u_id",g)}if(c&&V(c)){const{page:g}=c,L=f.getPageSize(g);V(L)&&(f.bind(e,$.LINEAR,g,A),a.setUniform2fv("u_mosaicSize",L),a.setUniform1i("u_texture",A))}let M=-1;for(const g of t){if(!g.layerData.has(P))continue;g.key.level!==M&&(M=g.key.level,S.setDataUniforms(a,l,m,M,f));const L=2**(l-M)/y;a.setUniform1f("u_zoomFactor",L);const w=g.layerData.get(P);if(!w.lineIndexCount)continue;w.prepareForRendering(e);const G=w.lineVertexArrayObject;if(!W(G)){if(e.bindVAO(G),a.setUniformMatrix3fv("u_dvsMat3",g.transforms.dvs),e.setStencilFunction(k.EQUAL,g.stencilRef,255),T||p){const F=w.patternMap;if(!F)continue;for(const[Y,R]of F){const q=f.getPageSize(Y);V(q)&&(f.bind(e,$.LINEAR,Y,A),a.setUniform2fv("u_mosaicSize",q),a.setUniform1i("u_texture",A),e.drawElements(O.TRIANGLES,R[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*R[0]))}}else e.drawElements(O.TRIANGLES,w.lineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*w.lineIndexStart);g.triangleCount+=w.lineIndexCount/3}}}}const mt=1/65536;class At extends Q{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=dt()}dispose(){}drawMany(r,t){const{drawPhase:e,styleLayerUID:l}=r,o=r.styleLayer;let i;e===C.HITTEST&&(i=j(l+1)),this._drawIcons(r,o,t,i),this._drawText(r,o,t,i)}_drawIcons(r,t,e,l){const{context:o,displayLevel:i,drawPhase:U,painter:y,spriteMosaic:f,state:P,styleLayerUID:_,requestRender:v,allowDelayedRender:m}=r,S=t.iconMaterial,D=y.vectorTilesMaterialManager;let E,I=!1;for(const M of e)if(M.layerData.has(_)&&(E=M.layerData.get(_),E.iconPerPageElementsMap.size>0)){I=!0;break}if(!I)return;const h=t.getPaintValue("icon-translate",i),x=t.getPaintValue("icon-translate-anchor",i);let T=t.getLayoutValue("icon-rotation-alignment",i);T===N.AUTO&&(T=t.getLayoutValue("symbol-placement",i)===J.POINT?N.VIEWPORT:N.MAP);const c=T===N.MAP,d=t.getLayoutValue("icon-keep-upright",i)&&c,p=E.isIconSDF,n=U===C.HITTEST,s=this._iconProgramOptions;s.id=n,s.sdf=p;const u=D.getMaterialProgram(o,S,s);if(m&&V(v)&&!u.isCompiled)return void v();o.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",T===N.MAP?P.displayViewMat3:P.displayMat3),u.setUniformMatrix3fv("u_displayMat3",x===B.VIEWPORT?P.displayMat3:P.displayViewMat3),u.setUniform2fv("u_iconTranslation",h),u.setUniform1f("u_depth",t.z),u.setUniform1f("u_mapRotation",et(P.rotation)),u.setUniform1f("u_keepUpright",d?1:0),u.setUniform1f("u_level",10*i),u.setUniform1i("u_texture",A),u.setUniform1f("u_fadeDuration",tt/1e3),n&&u.setUniform4fv("u_id",l);let a=-1;for(const M of e){if(!M.layerData.has(_)||(M.key.level!==a&&(a=M.key.level,S.setDataUniforms(u,i,t,a,f)),E=M.layerData.get(_),E.iconPerPageElementsMap.size===0))continue;E.prepareForRendering(o),E.updateOpacityInfo();const g=E.iconVertexArrayObject;if(!W(g)){o.bindVAO(g),u.setUniformMatrix3fv("u_dvsMat3",M.transforms.dvs),u.setUniform1f("u_time",(performance.now()-E.lastOpacityUpdate)/1e3);for(const[L,w]of E.iconPerPageElementsMap)this._renderIconRange(r,u,w,L,M)}}}_renderIconRange(r,t,e,l,o){const{context:i,spriteMosaic:U}=r;this._spritesTextureSize[0]=U.getWidth(l)/4,this._spritesTextureSize[1]=U.getHeight(l)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),U.bind(i,$.LINEAR,l,A),i.setStencilTestEnabled(!0),i.setStencilFunction(k.GREATER,255,255),i.setStencilWriteMask(0),i.drawElements(O.TRIANGLES,e[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),o.triangleCount+=e[1]/3}_drawText(r,t,e,l){const{context:o,displayLevel:i,drawPhase:U,glyphMosaic:y,painter:f,pixelRatio:P,spriteMosaic:_,state:v,styleLayerUID:m,requestRender:S,allowDelayedRender:D}=r,E=t.textMaterial,I=f.vectorTilesMaterialManager;let h,x=!1;for(const b of e)if(b.layerData.has(m)&&(h=b.layerData.get(m),h.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const T=t.getPaintProperty("text-opacity");if(T&&!T.isDataDriven&&T.getValue(i)===0)return;const c=t.getPaintProperty("text-color"),d=!c||c.isDataDriven||c.getValue(i)[3]>0,p=t.getPaintProperty("text-halo-width"),n=t.getPaintProperty("text-halo-color"),s=(!p||p.isDataDriven||p.getValue(i)>0)&&(!n||n.isDataDriven||n.getValue(i)[3]>0);if(!d&&!s)return;const u=24/8;let a=t.getLayoutValue("text-rotation-alignment",i);a===N.AUTO&&(a=t.getLayoutValue("symbol-placement",i)===J.POINT?N.VIEWPORT:N.MAP);const M=a===N.MAP,g=t.getLayoutValue("text-keep-upright",i)&&M,L=U===C.HITTEST,w=.8*u/P;this._glyphTextureSize||(this._glyphTextureSize=pt(y.width/4,y.height/4));const G=t.getPaintValue("text-translate",i),F=t.getPaintValue("text-translate-anchor",i),Y=this._sdfProgramOptions;Y.id=L;const R=I.getMaterialProgram(o,E,Y);if(D&&V(S)&&!R.isCompiled)return void S();o.useProgram(R),R.setUniformMatrix3fv("u_displayViewMat3",a===N.MAP?v.displayViewMat3:v.displayMat3),R.setUniformMatrix3fv("u_displayMat3",F===B.VIEWPORT?v.displayMat3:v.displayViewMat3),R.setUniform2fv("u_textTranslation",G),R.setUniform1f("u_depth",t.z+mt),R.setUniform2fv("u_mosaicSize",this._glyphTextureSize),R.setUniform1f("u_mapRotation",et(v.rotation)),R.setUniform1f("u_keepUpright",g?1:0),R.setUniform1f("u_level",10*i),R.setUniform1i("u_texture",Z),R.setUniform1f("u_antialiasingWidth",w),R.setUniform1f("u_fadeDuration",tt/1e3),L&&R.setUniform4fv("u_id",l);let q=-1;for(const b of e){if(!b.layerData.has(m)||(b.key.level!==q&&(q=b.key.level,E.setDataUniforms(R,i,t,q,_)),h=b.layerData.get(m),h.glyphPerPageElementsMap.size===0))continue;h.prepareForRendering(o),h.updateOpacityInfo();const X=h.textVertexArrayObject;if(W(X))continue;o.bindVAO(X),R.setUniformMatrix3fv("u_dvsMat3",b.transforms.dvs),o.setStencilTestEnabled(!0),o.setStencilFunction(k.GREATER,255,255),o.setStencilWriteMask(0);const rt=(performance.now()-h.lastOpacityUpdate)/1e3;R.setUniform1f("u_time",rt),h.glyphPerPageElementsMap.forEach((nt,st)=>{this._renderGlyphRange(o,nt,st,y,R,s,d,b)})}}_renderGlyphRange(r,t,e,l,o,i,U,y){l.bind(r,$.LINEAR,e,Z),i&&(o.setUniform1f("u_halo",1),r.drawElements(O.TRIANGLES,t[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),y.triangleCount+=t[1]/3),U&&(o.setUniform1f("u_halo",0),r.drawElements(O.TRIANGLES,t[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),y.triangleCount+=t[1]/3)}}export{At as M,Dt as c,St as d,wt as m,Q as t,Vt as u};
