import{U as q}from"./request-d3e98716.js";import{h as F}from"./string-cdf077e6.js";import{s as O}from"./Error-653283ae.js";import{r as P,h as S}from"./typedArrayUtil-a8b5b3e9.js";import{j as N}from"./promiseUtils-6684e352.js";import{l as E}from"./reactiveUtils-f41a4e00.js";import{W as z,X as H,Y as D}from"./index-455b69b8.js";import{l as y,U as b}from"./Octree-1a841545.js";import{_ as $}from"./preload-helper-41c905a7.js";import{a as j}from"./assets-0b172f07.js";import{l as G}from"./ViewingMode-5d7d590b.js";import{h as K}from"./Matrix3PassUniform-da8eddae.js";import{E as Q}from"./objectResourceUtils-ef6e3cdf.js";import{r as X}from"./context-util-1e3c8cfc.js";import{I as Y,N as C,O as T}from"./enums-64ab819c.js";import"./cast-7928d7aa.js";import"./ensureType-cf29afa9.js";import"./nextTick-3ee5a785.js";import"./Basemap-a8f7f439.js";import"./Collection-78126e82.js";import"./Evented-515b9d9c.js";import"./SimpleObservable-7dcdef1d.js";import"./collectionUtils-3831b7c4.js";import"./deprecate-b9088bd3.js";import"./Loadable-48bc1293.js";import"./Promise-dfdee8ba.js";import"./loadAll-7fd968fe.js";import"./asyncUtils-62e8a185.js";import"./Extent-69509002.js";import"./Ellipsoid-89682c5e.js";import"./Portal-8b65c9c4.js";import"./locale-30120714.js";import"./PortalGroup-bfe93c76.js";import"./jsonMap-c1f958cf.js";import"./PortalUser-4c8e1adc.js";import"./PortalItem-aa42c739.js";import"./messages-be07754e.js";import"./writeUtils-067c4f82.js";import"./layerUtils-034678f6.js";import"./Color-a42a8267.js";import"./colorUtils-639f4d25.js";import"./mathUtils-2519596a.js";import"./vec3-a020a6f6.js";import"./vec3f64-2f9cef06.js";import"./common-c186b691.js";import"./vec4-790471c0.js";import"./compilerUtils-034cacb8.js";import"./enumeration-3c281341.js";import"./opacityUtils-243aae26.js";import"./CollectionFlattener-3dd1f479.js";import"./TablesMixin-e7a6aab1.js";import"./Layer-f0696768.js";import"./geometry-5a216427.js";import"./Polyline-bf268e7b.js";import"./typeUtils-eb9416d0.js";import"./Identifiable-aa6d459d.js";import"./Graphic-b46e2684.js";import"./PopupTemplate-6eb885db.js";import"./Clonable-ba795b08.js";import"./fieldUtils-31bfecd2.js";import"./arcadeOnDemand-c6d1b9f2.js";import"./number-347a3a44.js";import"./symbols-fa594797.js";import"./CIMSymbol-1379245a.js";import"./Symbol-fc4312a4.js";import"./screenUtils-410d12c0.js";import"./symbolLayerUtils3D-1f8d4478.js";import"./aaBoundingBox-fc742a4e.js";import"./aaBoundingRect-4a760199.js";import"./persistableUrlUtils-a16d0f55.js";import"./Symbol3DAnchorPosition2D-c0f4a14d.js";import"./jsonUtils-03c4af61.js";import"./Cyclical-b66238c6.js";import"./workers-898a7c4c.js";import"./Connection-a681777e.js";import"./Queue-3a0c055d.js";import"./intl-f1e98361.js";import"./projection-d7b57a6c.js";import"./unitUtils-47abac71.js";import"./mat4-44a0988f.js";import"./zscale-1e1fc911.js";import"./TileInfo-34f80a8e.js";import"./widget-f7489a3f.js";import"./uuid-73213768.js";import"./dom-5b7af1bf.js";import"./HandleOwner-e1406413.js";import"./byteSizeEstimations-f0cab514.js";import"./executeQueryJSON-bcd96e1a.js";import"./normalizeUtils-ee4bf39f.js";import"./query-922e6fbf.js";import"./pbfQueryUtils-72f9b45b.js";import"./pbf-e1a6c35b.js";import"./OptimizedFeature-3de538c1.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-d9d8ef40.js";import"./FeatureSet-0573546e.js";import"./Field-f5fc9f6b.js";import"./fieldType-b1002185.js";import"./Query-ff8c2cfb.js";import"./TimeExtent-744afd75.js";import"./RelationshipQuery-db5fcd0c.js";import"./LegendOptions-e65e7a9c.js";import"./utils-725f8b4e.js";import"./BlendLayer-d8293c8d.js";import"./parser-2b40deea.js";import"./mat4f32-77b3d8ac.js";import"./ItemCache-ee28c7ba.js";import"./MemCache-4b976a8b.js";import"./cimSymbolUtils-2e4dde89.js";import"./utils-c81a5c52.js";import"./jsonUtils-c56f8821.js";import"./UniqueValueRenderer-103ec66d.js";import"./diffUtils-1ac65748.js";import"./colorRamps-3a8ac20b.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-c59ab38d.js";import"./lengthUtils-d2d33f94.js";import"./jsonUtils-d7db3dc7.js";import"./styleUtils-4adfed9e.js";import"./DictionaryLoader-2cf5144e.js";import"./LRUCache-14115d91.js";import"./heatmapUtils-84e8c43b.js";import"./vec4f64-e407da96.js";import"./featureConversionUtils-01cdde8a.js";import"./TopFeaturesQuery-785f5453.js";import"./FeatureLayer-a9f3e6ec.js";import"./MultiOriginJSONSupport-27362d57.js";import"./LayerFloorInfo-2cd5e8ae.js";import"./FeatureLayerBase-aebdf2da.js";import"./HeightModelInfo-22ad72d7.js";import"./arcgisLayerUrl-0b2b7691.js";import"./OperationalLayer-24e6fa34.js";import"./ElevationInfo-ce9cacc2.js";import"./editsZScale-2015e7db.js";import"./APIKeyMixin-34d76a46.js";import"./ArcGISService-ea748edf.js";import"./CustomParametersMixin-807d2055.js";import"./EditBusLayer-40671d1a.js";import"./FeatureReductionLayer-4077b2ae.js";import"./labelingInfo-5c3a46f6.js";import"./labelUtils-a194a22a.js";import"./defaultsJSON-59981e75.js";import"./OrderedLayer-e7edf19c.js";import"./PortalLayer-f1a64f99.js";import"./RefreshableLayer-1c078c47.js";import"./ScaleRangeLayer-271178b7.js";import"./TemporalLayer-39c07299.js";import"./TimeInfo-c89d0ef4.js";import"./FeatureTemplate-746d033e.js";import"./FeatureType-c83c5f49.js";import"./fieldProperties-7547b373.js";import"./FieldsIndex-aa6dd3fa.js";import"./versionUtils-92993d41.js";import"./styleUtils-da81b13f.js";import"./popupUtils-07fe66a7.js";import"./colorUtils-82440b70.js";import"./mat2d-d0b91e3e.js";import"./Scheduler-8433672d.js";import"./GraphicsLayer-10573c27.js";import"./enums-0fc02184.js";import"./vec2-2cef68de.js";import"./vec2f64-30dc1443.js";import"./mat3-3fc68e72.js";import"./mat3f32-d3d088e8.js";import"./vec2f32-461e65a9.js";import"./TileStrategy-4189758f.js";import"./TileStore-787dbea4.js";import"./TileKey-0750ad58.js";import"./rbush-8e36784a.js";import"./quickselect-322ec8e1.js";import"./capabilities-3636c6a4.js";import"./sphere-4f5e644f.js";import"./mat3f64-c6305894.js";import"./mat4f64-1e28eae0.js";import"./quatf64-7fd38d64.js";import"./lineSegment-e6f72ff2.js";import"./plane-45609588.js";import"./scaleUtils-b32a50d8.js";import"./ElevationSamplerData-7decf898.js";import"./PhysicallyBasedRendering.glsl-a986c926.js";import"./View.glsl-8b12b8c2.js";import"./ShaderBuilder-93e8045e.js";import"./FloatPassUniform-d2dfc562.js";import"./Float4PassUniform-3a47b7b3.js";import"./RgbaFloatEncoding.glsl-6036ca34.js";import"./Texture2DPassUniform-6e8ae673.js";import"./vec3f32-c9aa289f.js";import"./VertexAttribute-9c5c630d.js";import"./Texture2DDrawUniform-22924c6f.js";import"./basicInterfaces-19ed850e.js";import"./PiUtils.glsl-0c0898f0.js";import"./ReadLinearDepth.glsl-7ff30f7d.js";import"./WaterSurface.glsl-fc8a5726.js";import"./ForwardLinearDepth.glsl-36f9eb3b.js";import"./Slice.glsl-a612de15.js";import"./Transform.glsl-f15542a7.js";import"./OutputHighlight.glsl-7364b03b.js";import"./MultipassTerrainTest.glsl-e79d40de.js";import"./NormalUtils.glsl-a59958d7.js";import"./AlphaCutoff-96178e0d.js";import"./TransparencyPassType-cd195b0e.js";import"./EvaluateSceneLighting.glsl-3bbc6edf.js";import"./VisualVariablePassParameters-5807c7dc.js";import"./VertexElementDescriptor-2925c6af.js";import"./FramebufferObject-50e1b68f.js";import"./Texture-e79b14e7.js";import"./Util-a48361c6.js";import"./SSAOBlur.glsl-c6f142fc.js";import"./ScreenSpacePass-00f8c8a4.js";import"./SSAO.glsl-6f3b4065.js";import"./ShaderTechniqueConfiguration-9f5b4555.js";import"./HUD.glsl-80cf9a21.js";import"./VerticalOffset.glsl-86460edb.js";import"./DefaultTechniqueConfiguration-e8962072.js";import"./edgeProcessing-3ca548e1.js";import"./deduplicate-b0bc48cc.js";import"./InterleavedLayout-5e9cf734.js";import"./BufferView-646ba1de.js";import"./types-e1c0a5bf.js";import"./DefaultMaterial_COLOR_GAMMA-9831d979.js";import"./vec33-ce3aa99b.js";import"./Version-9baeb7ac.js";import"./quat-5b263584.js";import"./projection-aa2a8986.js";import"./HUDMaterial.glsl-4bf3c7df.js";import"./sdfPrimitives-a24e9cb2.js";import"./floatRGBA-fa8308d2.js";import"./Texture-bbae5d9d.js";import"./TextureOnly.glsl-18701a3b.js";import"./ObjectAndLayerIdColor.glsl-73c19386.js";import"./VisualVariables.glsl-b8290512.js";import"./dehydratedFeatures-4eeb381a.js";import"./quantizationUtils-33aba427.js";import"./labelFormatUtils-4d730eaa.js";import"./I3SUtil-3ffd3baa.js";import"./I3SBinaryReader-3d2c2faa.js";import"./symbolColorUtils-604c5345.js";import"./LineCallout.glsl-a0056465.js";import"./earcut-58237617.js";import"./QueryEngineResult-665bf7fb.js";import"./WhereClause-2b5b05b2.js";import"./utils-30a9a7e0.js";import"./generateRendererUtils-a996108f.js";import"./utils-1f4fcfec.js";import"./json-48e3ea08.js";import"./MeshComponent-f50df6af.js";import"./MarkerSizing.glsl-c6fa192a.js";import"./RibbonLine.glsl-2a3b4d4e.js";import"./OutputDepth.glsl-179f1d8f.js";import"./LineStipple.glsl-de782d6a.js";import"./MixExternalColor.glsl-25f0049c.js";import"./DiscardOrAdjustAlphaBlend.glsl-5f837994.js";import"./callExpressionWithFeature-a7532499.js";import"./LineMarker.glsl-8f444621.js";import"./NativeLine.glsl-cdbbf172.js";import"./VertexColor.glsl-db21b96c.js";import"./Normals.glsl-90e28525.js";import"./Path.glsl-60b36878.js";import"./ColorMaterial.glsl-8310ffb3.js";import"./Pattern.glsl-d3388745.js";import"./EffectView-d3bf37ed.js";import"./LercDecoder-73115fd2.js";import"./config-1337d16e.js";import"./DefaultMaterial.glsl-b4f4cbc5.js";import"./workerHelper-c6d4a8cb.js";import"./Subtype-5b01b21f.js";import"./datetime-4f774298.js";import"./elevationInfoUtils-427916a5.js";import"./ExportImageParameters-f328a234.js";import"./sublayerUtils-ba7f61bc.js";import"./webStyleSymbolUtils-55ed91cd.js";import"./devEnvironmentUtils-5002a058.js";import"./enums-4b2a86a0.js";import"./RealisticTree.glsl-2b30ed32.js";var U,L,w,M,g,R;(function(i){i[i.Binary=0]="Binary",i[i.JSON=1]="JSON"})(U||(U={})),function(i){i[i.TreeIndex=0]="TreeIndex",i[i.TreeStats=1]="TreeStats",i[i.TreeData=2]="TreeData",i[i.BrickBundles=3]="BrickBundles",i[i.Section=4]="Section",i[i.VariableStats=5]="VariableStats"}(L||(L={})),function(i){i[i.None=1]="None",i[i.Front=2]="Front",i[i.Back=3]="Back"}(w||(w={})),function(i){i[i.Low=0]="Low",i[i.Medium=1]="Medium",i[i.High=2]="High"}(M||(M={})),function(i){i[i.None=0]="None",i[i.StaticSections=1]="StaticSections",i[i.Slices=2]="Slices",i[i.DynamicSections=4]="DynamicSections",i[i.GhostShell=8]="GhostShell",i[i.Isosurface=16]="Isosurface",i[i.Quality=32]="Quality",i[i.SunLocation=64]="SunLocation",i[i.StaticSectionSelection=128]="StaticSectionSelection",i[i.ExaggerationAndOffset=256]="ExaggerationAndOffset",i[i.CurrentTime=512]="CurrentTime",i[i.CurrentVariable=1024]="CurrentVariable",i[i.DeleteIsosurface=2048]="DeleteIsosurface",i[i.ContainerVisibility=4096]="ContainerVisibility",i[i.RenderMode=8192]="RenderMode",i[i.Optimization=16384]="Optimization",i[i.VariableStyles=32768]="VariableStyles",i[i.VolumeStyles=65536]="VolumeStyles"}(g||(g={})),function(i){i[i.Isosurfaces=0]="Isosurfaces",i[i.DynamicSections=1]="DynamicSections",i[i.StaticSections=2]="StaticSections"}(R||(R={}));function J(i){return new Promise(t=>$(()=>import("./vxlLayer-3e26151a.js"),[],import.meta.url).then(e=>e.v).then(({default:e})=>{const r=e({locateFile:Z,preinitializedWebGLContext:i,onRuntimeInitialized:()=>t(r)})})).catch(t=>{throw t})}function Z(i){return j(`esri/libs/vxl/${i}`)}const v=O.getLogger("esri.layers.VoxelWasmPerSceneView");var l;(function(i){i[i.Lifetime=1]="Lifetime",i[i.RequestResponse=2]="RequestResponse",i[i.Rendering=3]="Rendering",i[i.Error=4]="Error"})(l||(l={}));class so{constructor(t){this._halfIntTexturesAvailable=!1,this._textureFloatLinearAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._shaderOutput=K.Color,this._renderSlot=Q.VOXEL,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._captureFrustum=!1,this._frustum=null,this._frustumRenderableId=-1,this._renderCoordsHelper=null,this._view=t,this._initialize()}get canRender(){return!!this._vxl&&this._view.viewingMode==="local"}_dbg(t,e){this._dbgFlags.has(t)&&(t===l.Error?v.error(e):v.warn(e))}_removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this._dbg(l.Lifetime,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}_initialize(){this._dbg(l.Lifetime,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=E(()=>this._view.ready,t=>{t&&this._view.viewingMode==="local"?(this._dbg(l.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(l.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},{initial:!0}),this._qualityWatchHandle=E(()=>{var t;return(t=this._view)==null?void 0:t.qualityProfile},t=>{this._dbg(l.Rendering,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this._toWasmQuality(t))},{initial:!0}),this._timeExtentWatchHandle=E(()=>{var t;return(t=this._view)==null?void 0:t.timeExtent},()=>{var t;if(this._vxl){const e=this._getTimeArgs((t=this._view)==null?void 0:t.timeExtent);this._dbg(l.Rendering,"sceneView timeExtent changed to useTime="+e.useTime+" st="+e.startTime+" et="+e.endTime),this._vxl.set_scene_time_extent(e.startTime,e.endTime,e.useTime),this._renderPluginContext.requestRender()}},{initial:!0}),this._stationaryWatchHandle=E(()=>{var t;return(t=this._view)==null?void 0:t.stationary},t=>{this._vxl&&t&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})}initializeRenderContext(t){this._dbg(l.Lifetime,"--initializeRenderContext--");const e=t.renderContext.rctx;e.type===X.WEBGL2?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear,this._initializeWasm(e.gl)):this._dbg(l.Error,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this._dbg(l.Lifetime,"--uninitializeRenderContext--")}_restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this._dbg(l.Error,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const e=this._renderTargetToRestore.viewport;this._rctx.setViewport(e.x,e.y,e.width,e.height)}_bindPreviousDepthToSlot(t,e){const r=!!this._rctx,s=!!this._renderTargetToRestore;if(!r||!s)return 0;const o=this._renderTargetToRestore.fbo.depthStencilTexture;return o?(e===0?this._rctx.bindTexture(null,t,!0):this._rctx.bindTexture(o,t,!0),1):(this._dbg(l.Error,"no depth/stencil texture exists!"),0)}_modifyResourceCount(t,e,r){if(!this._rctx)return void this._dbg(l.Error,"modifyAllocation callback has no rendering context!");const s=t;r===1?this._rctx.instanceCounter.increment(s,e):this._rctx.instanceCounter.decrement(s,e)}_setBlendState(t,e,r,s){this._rctx?(this._rctx.setBlendingEnabled(t===1),this._rctx.setBlendFunction(e,r),this._rctx.setBlendEquation(s)):this._dbg(l.Error,"setBlendState callback has no rendering context!")}_setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this._dbg(l.Error,"setFrontFace callback has no rendering context!")}_setDepthStencilStateFunction(t,e,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(t===1),this._rctx.setDepthWriteEnabled(e===1),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(Y.ALWAYS,0,255),this._rctx.setStencilOpSeparate(C.FRONT,T.KEEP,T.INCR,T.KEEP),this._rctx.setStencilOpSeparate(C.BACK,T.KEEP,T.DECR,T.KEEP)):this._dbg(l.Error,"setDepthStencilStateFunction callback has no rendering context!")}_setRasterizerState(t){if(this._rctx)switch(t){case w.None:this._rctx.setFaceCullingEnabled(!1);break;case w.Back:this._rctx.setCullFace(C.BACK),this._rctx.setFaceCullingEnabled(!0);break;case w.Front:this._rctx.setCullFace(C.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(l.Error,"setRasterizerState callback has no rendering context!")}_setViewport(t,e,r,s){this._rctx?this._rctx.setViewport(t,e,r,s):this._dbg(l.Error,"setViewport callback has no rendering context!")}_updateMemoryUsage(){this._layers.forEach((t,e)=>{if(t.needMemoryUsageUpdate){const r=this._vxl.estimate_memory_usage(e);r>=0&&(t.needMemoryUsageUpdate=!1,t.layerView.setUsedMemory(r))}})}_syncRequestsResponses(){this._layers.forEach((t,e)=>{const r=[];t.responses.forEach((n,p)=>{r.push(p),this._dbg(l.RequestResponse,"responding for requestID:"+p+" size:"+n.size),this._vxl.respond(e,p,n),n.requestType!==L.TreeIndex&&n.requestType!==L.Section||(t.needMemoryUsageUpdate=!0)});const s=t.responses;for(const n of r)s.delete(n);const o=this._vxl.get_new_requests(e),a=t.abortController.signal;for(const n in o){t.outstandingRequestCount+=1,t.outstandingRequestCount===1&&t.layerView.updatingFlagChanged();const p=o[n],c={responseType:"array-buffer",signal:a};this._dbg(l.RequestResponse,"making requestID:"+n+" url:"+p.url),q(p.url,c).then(m=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),this._dbg(l.RequestResponse,"have response for requestID:"+n);let u=0;if(m.data.byteLength>0){u=this._vxl._malloc(m.data.byteLength);const d=new Uint8Array(this._vxl.HEAPU8.buffer,u,m.data.byteLength),x=new Uint8Array(m.data);for(let f=0;f<m.data.byteLength;++f)d[f]=x[f]}s.set(+n,{responseType:p.responseType,ptr:u,size:m.data.byteLength,success:!0,requestType:p.requestType})}).catch(m=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),N(m)||(this._dbg(l.Error,`requestID:${n} failed, error=${m.toString()}`),s.set(+n,{responseType:p.responseType,ptr:0,size:0,success:!1,requestType:p.requestType}))})}})}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}getLayerTimes(t){const e=[];return this._layers.forEach((r,s)=>{if(r.layerView.wasmLayerId===t.wasmLayerId){const o=this._vxl.get_layer_epoch_times(s,t.layer.currentVariableId);for(let a=0;a<o.length;++a)e.push(o[a])}}),e}getCurrentLayerTimeIndex(t){let e=0;return this._layers.forEach((r,s)=>{r.layerView.wasmLayerId===t.wasmLayerId&&(e=this._vxl.get_layer_current_time_id(s))}),e}setEnabled(t,e){this._layers.forEach((r,s)=>{r.layerView.wasmLayerId===t.wasmLayerId&&(this._vxl.set_enabled(s,e),r.needMemoryUsageUpdate=!0,this._renderPluginContext.requestRender())})}setStaticSections(t,e){const r={mask:g.StaticSections,staticSections:e};return this._doMaskedUIUpdate(t,r,!0)}setCurrentVariable(t,e){const r={mask:g.CurrentVariable,currentVariable:e};return this._doMaskedUIUpdate(t,r,!0)}setRenderMode(t,e){const r={mask:g.RenderMode,renderMode:e};return this._doMaskedUIUpdate(t,r,!0)}setVerticalExaggerationAndOffset(t,e,r,s){const o={mask:g.ExaggerationAndOffset,volStyleDesc:{volumeId:e,verticalExaggeration:r,verticalOffset:s}};return this._doMaskedUIUpdate(t,o,!0)}setVariableStyles(t,e){const r={mask:g.VariableStyles,variableStyles:e};return this._doMaskedUIUpdate(t,r,!0)}setVolumeStyles(t,e){const r={mask:g.VolumeStyles,volumeStyles:e};return this._doMaskedUIUpdate(t,r,!0)}setEnableDynamicSections(t,e){const r={mask:g.ContainerVisibility,containerIsVisible:e,container:R.DynamicSections};return this._doMaskedUIUpdate(t,r,!0)}setEnableIsosurfaces(t,e){const r={mask:g.ContainerVisibility,containerIsVisible:e,container:R.Isosurfaces};return this._doMaskedUIUpdate(t,r,!0)}setEnableSections(t,e){const r={mask:g.ContainerVisibility,containerIsVisible:e,container:R.StaticSections};return this._doMaskedUIUpdate(t,r,!0)}_doMaskedUIUpdate(t,e,r){if(!this._vxl)return!1;let s=!1;return this._layers.forEach((o,a)=>{if(o.layerView.wasmLayerId===t.wasmLayerId){const n={str:JSON.stringify(e),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(n)&&(s=this._vxl.handle_masked_ui_update(a,n.ptr,n.byteCount)===1,n.isReusable||this._vxl._free(n.ptr))}}),s&&r&&this._renderPluginContext.requestRender(),s}_addTriangleToWasmBuffer(t,e,r,s,o){return t[3*e+0]=r[0],t[3*e+1]=r[1],t[3*e+2]=r[2],t[3*(e+=1)+0]=s[0],t[3*e+1]=s[1],t[3*e+2]=s[2],t[3*(e+=1)+0]=o[0],t[3*e+1]=o[1],t[3*e+2]=o[2],e+=1}_addNormalToWasmBuffer(t,e,r){return t[3*e+0]=r[0],t[3*e+1]=r[1],t[3*e+2]=r[2],e+=1}_doCaptureFrustum(){if(!this._vxl)return;const t=36,e=t/3,r=this._vxl._malloc(3*t*Float32Array.BYTES_PER_ELEMENT),s=new Float32Array(this._vxl.HEAPF32.buffer,r,3*t),o=this._vxl._malloc(3*e*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(this._vxl.HEAPF32.buffer,o,t),n=this._frustum.points[y.NEAR_BOTTOM_LEFT],p=this._frustum.points[y.NEAR_BOTTOM_RIGHT],c=this._frustum.points[y.NEAR_TOP_RIGHT],m=this._frustum.points[y.NEAR_TOP_LEFT],u=this._frustum.points[y.FAR_BOTTOM_LEFT],d=this._frustum.points[y.FAR_BOTTOM_RIGHT],x=this._frustum.points[y.FAR_TOP_RIGHT],f=this._frustum.points[y.FAR_TOP_LEFT];let h=0,_=0;const I=this._frustum.planes[b.NEAR];h=this._addTriangleToWasmBuffer(s,h,c,p,n),_=this._addNormalToWasmBuffer(a,_,I),h=this._addTriangleToWasmBuffer(s,h,n,m,c),_=this._addNormalToWasmBuffer(a,_,I);const V=this._frustum.planes[b.FAR];h=this._addTriangleToWasmBuffer(s,h,u,d,x),_=this._addNormalToWasmBuffer(a,_,V),h=this._addTriangleToWasmBuffer(s,h,x,f,u),_=this._addNormalToWasmBuffer(a,_,V);const B=this._frustum.planes[b.TOP];h=this._addTriangleToWasmBuffer(s,h,x,c,m),_=this._addNormalToWasmBuffer(a,_,B),h=this._addTriangleToWasmBuffer(s,h,m,f,x),_=this._addNormalToWasmBuffer(a,_,B);const W=this._frustum.planes[b.BOTTOM];h=this._addTriangleToWasmBuffer(s,h,n,p,d),_=this._addNormalToWasmBuffer(a,_,W),h=this._addTriangleToWasmBuffer(s,h,d,u,n),_=this._addNormalToWasmBuffer(a,_,W);const k=this._frustum.planes[b.LEFT];h=this._addTriangleToWasmBuffer(s,h,m,n,u),_=this._addNormalToWasmBuffer(a,_,k),h=this._addTriangleToWasmBuffer(s,h,u,f,m),_=this._addNormalToWasmBuffer(a,_,k);const A=this._frustum.planes[b.RIGHT];h=this._addTriangleToWasmBuffer(s,h,c,x,d),_=this._addNormalToWasmBuffer(a,_,A),h=this._addTriangleToWasmBuffer(s,h,d,p,c),_=this._addNormalToWasmBuffer(a,_,A),this._frustumRenderableId!==-1&&this._vxl.remove_generic_mesh(this._frustumRenderableId),this._frustumRenderableId=this._vxl.add_generic_mesh(r,3*t,o,t,255,0,0,64),this._vxl._free(r),this._vxl._free(o),this._captureFrustum=!1,this._renderPluginContext.requestRender()}captureFrustum(){this._renderCoordsHelper===null&&(this._renderCoordsHelper=z.create(G.Local,H(!1,this._view.spatialReference))),this._frustum===null&&(this._frustum=new D(this._renderCoordsHelper)),this._captureFrustum=!0,this._renderPluginContext!==null&&this._renderPluginContext.requestRender()}toggleFullVolumeExtentDraw(t){this._vxl&&this._layers.forEach((e,r)=>{e.layerView.wasmLayerId===t.wasmLayerId&&(this._vxl.toggle_full_volume_extent_draw(r),this._renderPluginContext.requestRender())})}addVoxelLayer(t){if(!this._vxl){const r={layerView:t,resolveCallback:null,rejectCallback:null},s=new Promise((o,a)=>{r.resolveCallback=o,r.rejectCallback=a});return this._newLayers.push(r),s}const e=this._addVoxelLayer(t);return e<0?Promise.reject(-1):Promise.resolve(e)}removeVoxelLayer(t){if(!this._vxl){const s=this._newLayers.findIndex(a=>t.uid===a.layerView.uid);s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const o=this._newLayers.length;return o===0&&(this._dbg(l.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),o}let e=-1;this._layers.forEach((s,o)=>{s.layerView.wasmLayerId===t.wasmLayerId&&(e=o,s.abortController.abort(),this._vxl.remove_layer(e))}),e>=0&&this._layers.delete(e);const r=this._layers.size;return r===0&&(this._dbg(l.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}_getBlockSize(t){for(const e of this._wasmMemBlockSizes)if(t<e)return e;return-1}_allocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const e=this._getBlockSize(t.byteCount);return e<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(e),t.ptr===0&&(t.ptr=this._vxl._malloc(e),this._wasmMemBlocks.set(e,t.ptr))),t.ptr!==0&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let e=-Number.MAX_VALUE,r=Number.MAX_VALUE,s=!1;return P(t)&&(t.isAllTime?s=!0:(P(t.start)&&(s=!0,e=t.start.getTime()/1e3),P(t.end)&&(s=!0,r=t.end.getTime()/1e3))),{startTime:e,endTime:r,useTime:s}}_addVoxelLayer(t){var p;const e=t.layer;let r=-1;const s=e.getConfiguration();if(s.length<1)return-1;const o={str:s,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(o))return-1;const a=this._getTimeArgs((p=this._view)==null?void 0:p.timeExtent),n=this._view.spatialReference.isWGS84&&e.spatialReference.isWGS84?111319.49079327357:1;if(r=this._vxl.add_layer(e.serviceRoot,o.ptr,o.byteCount,n,n,a.startTime,a.endTime,a.useTime,this._toWasmQuality(this._view.qualityProfile)),o.isReusable||this._vxl._free(o.ptr),r>=0){const c=new AbortController;if(this._layers.set(r,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:c,needMemoryUsageUpdate:!1}),!this._halfIntTexturesAvailable||F("mac")){const m=[];let u="";for(const d of t.layer.variables)d.renderingFormat.type!=="Int16"&&d.renderingFormat.type!=="UInt16"||(m.push(d.name),d.id===t.layer.currentVariableId&&(u=d.name));u!==""&&v.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${u}' in this browser`),m.length>0&&v.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${m.toString()}' in this browser`)}if(!this._textureFloatLinearAvailable){const m=[];let u="";for(const d of t.layer.variables)d.renderingFormat.type==="Float32"&&(m.push(d.name),d.id===t.layer.currentVariableId&&(u=d.name));u!==""&&v.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${u}' in this browser`),m.length>0&&v.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${m.toString()}' in this browser`)}return F("esri-mobile")&&v.warnOnce("Mobile support differs across devices. Voxel layer might not display as expected."),r}return-1}prepareRender(t){if(!this._vxl)return;const e=t.bindParameters.camera.viewForward,r=t.bindParameters.camera.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],e[0],e[1],e[2]);const s=this._vxl.cull();this._dbg(l.RequestResponse,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=this._newLayers.length===0,this._updateMemoryUsage()}render(t){if(!this._vxl||t.output!==this._shaderOutput||t.bindParameters.slot!==this._renderSlot)return;for(const r of this._newLayers){const s=this._addVoxelLayer(r.layerView);s===-1?r.rejectCallback(-1):r.resolveCallback(s)}if(this._newLayers=[],this._layers.size===0)return void this._dbg(l.Error,"No voxel layers but RenderPlugin instance is being asked to render!");this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._lastFrameWasStationary=this._view.stationary,this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0),this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,t.bindParameters.lighting.mainLight.direction[0],t.bindParameters.lighting.mainLight.direction[1],t.bindParameters.lighting.mainLight.direction[2]);const e=this._renderTargetToRestore.viewport;e.width===this._viewportWidth&&e.height===this._viewportHeight||(this._viewportWidth=e.width,this._viewportHeight=e.height,this._vxl.set_viewport(e.width,e.height),this._layers.forEach(r=>{r.needMemoryUsageUpdate=!0})),e.x===0&&e.y===0||this._dbg(l.Error,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.bindParameters.camera),this._captureFrustum&&(this._frustum.update(t.bindParameters.camera),this._doCaptureFrustum()),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}destroy(){this._dbg(l.Lifetime,"--destroy--"),this._removeRenderPlugin(),this._readyWatchHandle=S(this._readyWatchHandle),this._qualityWatchHandle=S(this._qualityWatchHandle),this._timeExtentWatchHandle=S(this._timeExtentWatchHandle),this._stationaryWatchHandle=S(this._stationaryWatchHandle),this._vxl&&(this._layers.forEach(t=>{t.abortController.abort()}),this._wasmMemBlocks.forEach(t=>{t!==0&&this._vxl._free(t)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}_initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=J(t).then(e=>{var f;if(this._vxl=e,this._vxlPromise=null,this._newLayers.length<=0)return this._dbg(l.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const r=this._getTimeArgs((f=this._view)==null?void 0:f.timeExtent),s=this._vxl.addFunction(this._restoreFramebuffer.bind(this),"v"),o=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),a=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),n=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),p=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),c=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),m=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),u=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),d=this._halfIntTexturesAvailable&&!F("mac"),x=this._textureFloatLinearAvailable;this._vxl.initialize_voxel_wasm(s,o,a,n,p,c,m,u,r.startTime,r.endTime,r.useTime,d,x),this._renderPluginContext&&this._renderPluginContext.requestRender()}).catch(()=>{for(const e of this._newLayers)e.rejectCallback(-2);this._dbg(l.Error," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()})),this._vxlPromise)}pickDepth(t,e,r){if(!this._vxl||!this._rctx||this._layers.size===0)return null;const s=r.viewport[3]-e;if(t<0||t>r.viewport[2]||e<0||e>r.viewport[3])return this._dbg(l.Error,`pickDepth: outOfRange, screenXY=[${t}, ${s}], vp=[${r.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const o=r.viewForward,a=r.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],o[0],o[1],o[2]),this.updateWasmCamera(r),this._vxl.begin_frame();const n=this._vxl.pick_depth(t,s);return this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),n.success?n.distanceToCamera:null}_toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}export{so as default};
