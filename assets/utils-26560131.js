import{e as v}from"./mat3f32-d3d088e8.js";import{e as V,d as D}from"./EffectView-d3bf37ed.js";import{a as N}from"./Error-653283ae.js";import{E as w,S as E}from"./enums-4ca4641f.js";import{U as x}from"./MaterialKey-406a59ab.js";import{r as R}from"./typedArrayUtil-a8b5b3e9.js";import{b as f}from"./Utils-b2b4cf0c.js";import{r as F,s as C}from"./definitions-2d0dd0cd.js";import{C as r}from"./enums-64ab819c.js";import{u as O}from"./screenUtils-410d12c0.js";import{u as H}from"./heatmapUtils-84e8c43b.js";import{l as U}from"./Color-a42a8267.js";class j extends V{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectView=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach(t=>t.clips=e)}get computedEffects(){var e;return((e=this._effectView)==null?void 0:e.effects)??null}get effect(){var e;return((e=this._effectView)==null?void 0:e.effect)??""}set effect(e){(this._effectView||e)&&(this._effectView||(this._effectView=new D),this._effectView.effect=e,this.requestRender())}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._effectView&&(this._effectView.transitionStep(e,t),this._effectView.transitioning&&this.requestRender())}doRender(e){const t=this.createRenderParams(e);this.renderChildren(t)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,t=this.children.length){if(!e||this.contains(e))return e;this._needsSort=!0;const a=e.parent;return a&&a!==this&&a.removeChild(e),t>=this.children.length?this.children.push(e):this.children.splice(t,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}endTransitions(){super.endTransitions(),this._effectView&&(this._effectView.endTransitions(),this.requestRender())}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const t=this.children.splice(e,1)[0];return this._childrenSet.delete(t),this!==this.stage&&(t.clips=null),t.stage=null,t.parent=null,t}sortChildren(e){this._needsSort&&(this.children.sort(e),this._needsSort=!1)}beforeRender(e){super.beforeRender(e);for(const t of this.children)t.beforeRender(e)}afterRender(e){super.afterRender(e);for(const t of this.children)t.afterRender(e)}_createTransforms(){return{dvs:v()}}onAttach(){super.onAttach();const e=this.stage;for(const t of this.children)t.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const t of this.children)t.processRender(e)}createRenderParams(e){return{...e,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition}}}class u{static getStorageSpec(e){return null}static createOrUpdateRendererSchema(e,t){return R(e)&&e.type==="default"?e:{type:"default"}}static getVariation(e){return{}}static getVariationHash(e){return 0}}u.type="default",u.programSpec=null;let S=class extends u{static getStorageSpec({attributes:e}){return{visualVariables:!1,attributes:e??null}}static _createRendererSchema(){return{type:"dot-density",colors:new Float32Array(32),dotValue:-1,dotSize:-1,dotScale:-1,dotBlending:!1,backgroundColor:new Float32Array(4),activeDots:new Float32Array(8),seed:-1}}static createOrUpdateRendererSchema(e,t){const{attributes:a,dotValue:p,referenceScale:m,dotSize:l,dotBlendingEnabled:d,seed:i,backgroundColor:h}=t,c=R(e)&&e.type==="dot-density"?e:this._createRendererSchema();c.dotValue=p,c.dotSize=l,c.dotScale=m,c.dotBlending=d,c.seed=i;const{colors:b,activeDots:g,backgroundColor:o}=c;for(let s=0;s<F;s++){const T=s>=a.length?null:a[s].color;f(b,T,4*s)}for(let s=0;s<8;s++)g[s]=s<t.attributes.length?1:0;return f(o,h),c}static getVariation(e){return{ddDotBlending:e.dotBlending}}static getVariationHash(e){return e.dotBlending?1:0}};S.type="dot-density",S.programSpec={shader:"materials/fill",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:r.SHORT},{location:1,name:"a_id",count:3,type:r.UNSIGNED_BYTE},{location:2,name:"a_bitset",count:1,type:r.UNSIGNED_BYTE},{location:3,name:"a_inverseArea",count:1,type:r.FLOAT}]}};class y extends u{static getStorageSpec({field:e,valueExpression:t}){return{visualVariables:!1,attributes:e||t?[{field:e,valueExpression:t}]:null}}static _createRendererSchema(){return{type:"heatmap",radius:-1,referenceScale:-1,isFieldActive:0,minDensity:-1,densityRange:-1,kernel:null,gradient:null,gradientHash:"invalid"}}static createOrUpdateRendererSchema(e,t){const{radius:a,minDensity:p,maxDensity:m,referenceScale:l,field:d,valueExpression:i,colorStops:h}=t,c=m-p,b=d||i?1:0,g=h.map(({color:T,ratio:A})=>`${A}:${T.toString()}`).join();let o,s=!0;return R(e)&&e.type==="heatmap"?(o=e,s=g!==e.gradientHash):o=this._createRendererSchema(),o.radius=O(a),o.minDensity=p,o.densityRange=c,o.referenceScale=l,o.isFieldActive=b,s&&(o.gradient=H(h),o.gradientHash=g),o}}y.type="heatmap",y.programSpec={shader:"materials/icon/heatmapAccumulate",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:r.SHORT},{location:1,name:"a_vertexOffset",count:2,type:r.SHORT},{location:4,name:"a_id",count:4,type:r.UNSIGNED_BYTE}]}};class _ extends u{static getStorageSpec({attributes:e}){return{visualVariables:!0,attributes:e??null}}static _createRendererSchema(){return{type:"pie-chart",colors:new Float32Array(4*C),defaultColor:new Float32Array(4),othersColor:new Float32Array(4),outlineColor:new Float32Array(4),holePercentage:0,sectorThreshold:0,outlineWidth:1,numberOfFields:10}}static createOrUpdateRendererSchema(e,t){const{attributes:a,defaultColor:p,holePercentage:m,othersCategory:l,outline:d}=t,i=R(e)&&e.type==="pie-chart"?e:this._createRendererSchema();for(let h=0;h<C;h++){const c=h>=a.length?new U([0,0,0,0]):a[h].color;f(i.colors,c,4*h)}return f(i.defaultColor,p),f(i.othersColor,l==null?void 0:l.color),f(i.outlineColor,d==null?void 0:d.color),i.outlineWidth=O((d==null?void 0:d.width)||0),i.holePercentage=m,i.sectorThreshold=(l==null?void 0:l.threshold)||0,i.numberOfFields=a.length,i}static getVariation(e){return{numberOfFields:e.numberOfFields}}static getVariationHash(e){return e.numberOfFields}}_.type="pie-chart",_.programSpec={shader:"materials/pie",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:r.SHORT},{location:1,name:"a_vertexOffset",count:2,type:r.SHORT},{location:2,name:"a_texCoords",count:2,type:r.UNSIGNED_SHORT},{location:3,name:"a_bitSetAndDistRatio",count:2,type:r.UNSIGNED_SHORT},{location:4,name:"a_id",count:4,type:r.UNSIGNED_BYTE},{location:5,name:"a_color",count:4,type:r.UNSIGNED_BYTE,normalized:!0},{location:6,name:"a_outlineColor",count:4,type:r.UNSIGNED_BYTE,normalized:!0},{location:7,name:"a_sizeAndOutlineWidth",count:4,type:r.UNSIGNED_BYTE},{location:8,name:"a_zoomRange",count:2,type:r.UNSIGNED_SHORT}]},hittestAttributes:["a_vertexOffset","a_texCoords"]};function J(n,e){if(n.type!==e)throw new N("material-view-model:unexpected-renderer-schema",`expected to find renderer schema of type "${e}" but found type "${n.type}"`)}function Q(n){switch(n==null?void 0:n.type){case"dot-density":return S;case"heatmap":return y;case"pie-chart":return _;default:return u}}function X(n){const{geometryType:e,symbologyType:t}=x.load(n);switch(e){case w.FILL:if(t===E.DOT_DENSITY)return S;break;case w.MARKER:switch(t){case E.HEATMAP:return y;case E.PIE_CHART:return _}}return u}export{Q as c,u as e,j as i,X as p,J as s};
