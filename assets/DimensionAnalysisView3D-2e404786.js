import{eP as er,a$ as tr,lN as ir,lO as nr,cY as sr,u as f,mP as rr,B as g,c_ as Ft,C as Nt,a4 as ge,J as y,mQ as ar,mR as or,cR as I,mp as $,lE as lr,cE as et,mS as tn,lL as nn,dM as sn,jr as z,d0 as de,bE as V,mx as zn,ma as tt,d1 as Vn,c5 as Ai,mT as se,mU as Ye,mV as rn,cF as Se,cu as gi,e as h,y as p,b as F,f as _e,t as ei,a as _t,l as E,be as k,lX as dr,s as Hn,dS as M,mW as cr,mX as it,cm as bt,mY as pt,mZ as _i,m_ as T,m$ as hr,cl as In,n0 as Gn,al as ce,gd as W,n1 as ur,fE as Xe,mG as yi,cj as vi,ck as rt,mH as an,mL as pr,n2 as mr,n3 as fr,n4 as gr,n5 as _r,hZ as jt,lS as x,cv as ai,lT as Je,eI as yt,n6 as Fn,n7 as we,m9 as me,by as Nn,n8 as on,n9 as yr,cn as vr,na as Sr,nb as wr,nc as Pr,bw as qt,bA as Si,nd as Ne,dt as kn,m5 as xr,m4 as he,ne as ln,d as Q,mk as oi,bY as br,gh as Ct,c6 as re,gc as jn,iD as qn,mq as xe,eO as wi,g7 as Er,bh as Mr,bt as qe,mo as Un,nf as li,eq as $r,lU as Le,dA as dn,ng as Cr,eE as Or,et as cn,nh as Tr,bd as at,h as Ut,mD as vt,mC as Et,mB as mt,ni as Rr,nj as Dr,nk as Pi,nl as xi,k3 as ze,mm as Ar,d3 as Li,dF as Lr,cH as nt,bg as zr,a1 as Vr,_ as Ot,nm as Hr,lI as Wn,mt as Ir,b3 as Gr,di as hn,hm as Fr,bk as Nr,bp as Wt,nn as kr,bb as Bn,ft as Zn,aw as St,A as zi,no as bi,aE as Yn,dV as jr,bl as Vi,np as Ei,dK as qr,D as Ur,nq as Wr,nr as Br,bV as Zr,ns as Xn,mb as Yr,mc as Xr,nt as Jr,nu as Kr,nv as dt,lV as Qr,m0 as ea,bq as un}from"./index-74d49a87.js";import{n as Jn,g as $e,b as ta,c as ia,a as na}from"./LineVisualElement-904de9f6.js";import{t as R,r as sa,u as ra}from"./LengthDimension-ab6848c2.js";import{a as aa,v as Kn,f as Ve,i as oa,c as la,u as G,g as da,b as ca}from"./Segment-a1fa4b06.js";import{N as ha,i as Qn,e as ft,x as es,U as ua,D as pa,a as Mt,V as Hi,w as Ii,C as ma,b as ts,v as pn,c as fa,s as ga,m as _a,d as ya}from"./analysisViewUtils-e5cbe5fd.js";import{B as va,C as is,z as Gi,o as Sa}from"./Factory-8247a6e0.js";import{g as wa,h as Pa,E as A,Z as mn}from"./elevationInfoUtils-3c9457ff.js";import{t as ns,S as xa}from"./RightAngleQuadVisualElement-ba7b8aa2.js";import{d as ba,S as fn}from"./PointVisualElement-da80c55c.js";import{y as Ea,p as Ma}from"./colorUtils-c0f43caf.js";import{c as $a}from"./ImageMaterial-2cbfab0b.js";import{b as j,L as di,m as Ca,V as Oa,g as Ta,w as Ra}from"./EditGeometryOperations-023b3d76.js";import{D as gn}from"./QueryEngineResult-10a77c28.js";import{i as Da}from"./dehydratedFeatureComparison-4083c3a5.js";import{r as Aa}from"./RenderTexture-32de94fb.js";function La(i){const e=er(i),t=e===ir?nr:e;return tr(i,t)?t:i}var Ke;function za(i,e){const{spatialReference:t}=i;return sr(t,e.spatialReference)?(Tt[0]=i.x,Tt[1]=i.y,Tt[2]=i.hasZ?i.z:0,Rt[0]=e.x,Rt[1]=e.y,Rt[2]=e.hasZ?e.z:0,ss(Tt,Rt,t)):null}function ss(i,e,t){const n=Va(i,e,t,Ke.Direct);return f(n)?aa(n.direct,n.unit):null}function Va(i,e,t,n){const s=La(t),r=rr(s);if(g(r))return null;const a=e[2]-i[2];if(n===Ke.Vertical)return{verticalSigned:a,unit:r};if(!Ft(i,t,ci,s)||!Ft(e,t,Dt,s))return null;if(n===Ke.Direct)return{direct:Nt(Dt,ci),unit:r};if(ge(At,i[0],i[1],e[2]),!Ft(At,t,At,s))return null;const l=Nt(At,Dt);return n===Ke.Horizontal?{horizontal:l,unit:r}:{direct:Nt(Dt,ci),horizontal:l,vertical:Math.abs(a),unit:r}}(function(i){i[i.Direct=0]="Direct",i[i.Horizontal=1]="Horizontal",i[i.Vertical=2]="Vertical"})(Ke||(Ke={}));const Tt=y(),Rt=y(),ci=y(),Dt=y(),At=y();function Ha(i,e,t){if(g(i))return null;const n=i.dimensionSegment.startRenderSpace,s=i.dimensionSegment.endRenderSpace,r=ss(n,s,i.spatialReference);if(g(r))return null;const a=e===R.Vertical?ar(r.value,r.unit,t):or(r.value,r.unit,t);return Kn(r,a)}function Bt(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,dimension:{offset:n,measureType:s,orientation:r}}=i;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:n,measureType:s,orientation:r}}function Zt({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,offset:t,measureType:n,orientation:s},r,a=null){if(g(i)||g(e))return null;const l=as(f(a)?a.directSegment:new Ve,{elevationAlignedStartPoint:i,elevationAlignedEndPoint:e},r),o=f(a)?a.primaryOffsetAxis:y();ti(o,{measureType:n,elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const d=f(a)?a.dimensionSegment:new Ve;return Fi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e})&&n===R.Vertical?(I(d.startRenderSpace,l.startRenderSpace),I(d.endRenderSpace,l.endRenderSpace)):os(d,{offsetAxis:o,offset:t,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:d,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function _n(i,e,t,n){return e===wt.Start?(I(i.startRenderSpace,t.startRenderSpace),I(i.endRenderSpace,n.startRenderSpace)):(I(i.startRenderSpace,t.endRenderSpace),I(i.endRenderSpace,n.endRenderSpace)),i}var wt;function Ia(i,e,t,n){se(i.startRenderSpace,e.startRenderSpace,t,n),se(i.endRenderSpace,e.endRenderSpace,t,n)}function rs(i,e,t,n){switch(e){case R.Direct:return as(i,t,n);case R.Horizontal:case R.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=t;let o;a.measureType===R.Direct?(o=Ga(l,n)===s.z>r.z,e===R.Horizontal&&(o=!o)):o=!Fa(l);const[d,c]=o?[s,r]:[r,s],u=Ye(c,Na);return e===R.Horizontal?u.z=d.z:(u.x=d.x,u.y=d.y),n.toRenderCoords(d,i.startRenderSpace),n.toRenderCoords(u,i.endRenderSpace),i}}}function as(i,e,t){return t.toRenderCoords(e.elevationAlignedStartPoint,i.startRenderSpace),t.toRenderCoords(e.elevationAlignedEndPoint,i.endRenderSpace),i}function Ga(i,e){const t=i.directSegment.eval(.5,$.get()),n=e.worldUpAtPosition(t,$.get()),s=i.dimensionSegment.eval(.5,$.get()),r=z($.get(),s,t);return!zn(r,tt)&&V(r,n)>0}function Fa(i){const{startRenderSpace:e,endRenderSpace:t}=i.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=i.directSegment;return rn(n,e)<rn(s,t)}(function(i){i[i.Start=0]="Start",i[i.End=1]="End"})(wt||(wt={}));const Na=Se(0,0,0,null);function ka(i,e,t,n){const{directSegment:s}=t,r=ti($.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),a=os(ja,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,$.get()),l=z($.get(),i,a);return V(l,r)*n.unitInMeters}const ja=new Ve;function ti(i,e){const{measureType:t,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,d=l.eval(.5,$.get()),c=o.worldUpAtPosition(d,$.get()),u=o.worldBasisAtPosition(d,lr.Y,$.get());switch(t){case R.Horizontal:I(i,c);break;case R.Vertical:V(r,c)<V(a,c)?z(i,a,r):z(i,r,a),de(i,i,c),de(i,i,c);break;case R.Direct:{const m=et(e.orientation,0);if(Fi({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))tn(Lt,-nn(m),c),sn(i,u,Lt);else{const _=z($.get(),a,r),S=de($.get(),_,c);de(S,S,_),tn(Lt,nn(m),_),sn(i,S,Lt)}break}}return zn(i,tt)?I(i,u):Vn(i,i)}const Lt=Ai();function Fi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e}){return f(i)&&f(e)&&i.x===e.x&&i.y===e.y}function os(i,e){const{offsetAxis:t,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=n/l.unitInMeters,[d,c]=qa(s,r,t,o);return se(i.startRenderSpace,a.startRenderSpace,t,d),se(i.endRenderSpace,a.endRenderSpace,t,c),i}function qa(i,e,t,n=0){const s=V(e,t),r=V(i,t),a=Math.abs(s-r)+n;return s>r?[a,n]:[n,a]}function ii(i,e,t){const n=e.directSegment.eval(.5,$.get());return t.worldUpAtPosition(n,i)}function Ni(i,e){const{startRenderSpace:t,endRenderSpace:n}=e.directSegment;return z(i,n,t)}function ki(i,e,t={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return t.invert?z(i,n,s):z(i,s,n)}function Mi(i,e){const t=i.directSegment.eval(.5,$.get());return e.headingAtPosition(t,i.primaryOffsetAxis)}function Ua(i,e){return gi(ki(Wa,i))/e**2}const Wa=y();function ls(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=i;if(g(e)||g(t))return!1;const n=za(e,t);return f(n)&&Kn(n,"meters").value>ds}const ds=1e5;function Pt(i){return f(i.geometry)}let Ce=class extends _e{constructor(e){super(e),this._handles=new ei}initialize(){const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles(e.on("change",({added:t,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of t)this._addComputation(s)}))}destroy(){this._handles=_t(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return oa(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(E(()=>Bt(e),t=>{const{measureType:n}=t;if(ls(t)&&n!==R.Direct){const r=Math.round(dr(ds,"meters","kilometers"));return Hn.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${r} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=Zt(t,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Ha(s,n,this._defaultUnit)},k),e)}_removeComputation(e){this._handles.remove(e)}};h([p({constructOnly:!0})],Ce.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],Ce.prototype,"view",void 0),h([p()],Ce.prototype,"analysis",null),h([p()],Ce.prototype,"_defaultUnit",null),Ce=h([F("esri.views.3d.analysis.Dimension.support.DimensionController")],Ce);const cs={main:new M([255,127,0])};let Ba=class{constructor(){this.color=cs.main,this.opacity=.5,this.radius=5}},Za=class{constructor(){this.color=new M([127,127,127]),this.opacity=.5,this.radius=5}},Ya=class{constructor(){this.lineSizeFraction=.8}},Xa=class{constructor(){this.color=cs.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}},Ja=class{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}},Ka=class{constructor(){this.lineSizeFraction=.25}},Qa=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}},eo=class{constructor(){this.color=new M([255,127,0,.5])}},to=class{constructor(){this.pointManipulators=new Ba,this.offsetManipulator=new Xa,this.orientationManipulator=new Ja,this.markers=new Ya,this.labels=new Qa,this.offsetLine=new Ka,this.constraint=new eo,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Za,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};const D=new to;class io{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of sa)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case R.Direct:return this.direct;case R.Horizontal:return this.horizontal;case R.Vertical:return this.vertical}}}function no(i,e){const t=ha(i,M.toUnitRGB(D.pointManipulators.color),D.pointManipulators.opacity,fe);return t.available=!1,t.grabCursor="crosshair",t.radius=D.pointManipulators.radius,t.metadata=e.metadata,t.collisionPriority=1,t}function so(i,e){const t=[W(-.5,0,0),W(.5,0,0)],{lengthFraction:n}=D.offsetManipulator,s=it(e.unfocusedMaterial,t.map(a=>bt(y(),a,n))),r=s.instantiate({material:e.focusedMaterial});return new Qn({view:i,renderObjects:[new ft(s,pt.Unfocused|pt.Selected|fe),new ft(r,pt.Focused|fe)],collisionType:{type:"line",paths:[t]},radius:ji(e.lineSizePt)/2,metadata:e.metadata,available:!1,...es})}function hs(i,{lineSizePt:e,material:t}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:r,discScale:a,focusMultiplier:l}=D.orientationManipulator;return{calloutLength:.25*ur*D.markers.lineSizeFraction*ce(e)+n,calloutOpacity:s,calloutWidth:r,customStateMask:fe,discScale:a,focusMultiplier:l,material:t,metadata:i}}function yn(i,e){return ua(i,hs(e.metadata,e))}function vn(i,e){pa(i,hs(i.metadata,e))}function ro(i,e){const t=[W(-.5,0,0),W(.5,0,0)],{lengthFraction:n}=D.offsetManipulator,s=it(e.thinOffsetManipulatorMaterial,t),r=it(e.unfocusedMaterial,t.map(l=>bt(y(),l,n))),a=r.instantiate({material:e.focusedMaterial});return new Qn({view:i,renderObjects:[new ft(r,pt.Unfocused|fe),new ft(a,pt.Focused|fe),new ft(s,fe)],collisionType:{type:"line",paths:[t]},radius:ji(e.lineSizePt)/2,available:!1,metadata:e.metadata,...es})}function ao(i,{isStart:e,createSnappingPipelineStep:t,dimension:n,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[Mt(i,(o,d,c,u)=>{const m=Gi(o),{snappingStep:_,cancelSnapping:S}=t(u);c=c.next(m).next(Ii(n,[a,"measureType","orientation"])).next(S),d.next(m).next(va(r)).next(..._).next(P=>{const w=Ye(P.mapEnd,new Xe);s(a==="startPoint"?{startPoint:w}:{endPoint:w})})})]}function oo(i,{computation:e,view:t}){return[Mt(i,(n,s,r)=>{if(!Pt(e)||!n.selected)return;const{geometry:a,dimension:l}=e,o=Gi(n);s.next(o).next(ps(t,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(Ii(l,["offset"]))})]}function lo(i,{computation:e,view:t}){return[Mt(i,(n,s,r)=>{us({cancel:r,computation:e,settingHeading:!0,steps:s,view:t})})]}function co(i,{computation:e,view:t}){return[Mt(i,(n,s,r)=>{us({cancel:r,computation:e,settingHeading:!1,steps:s,view:t})}),i.events.on("immediate-click",n=>{ho(n,e,t)})]}function ho(i,e,t){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void i.stopPropagation();if(g(s))return;const{renderCoordsHelper:r}=t,a=Zt({...Bt(e),orientation:90},r),l=Zt({...Bt(e),orientation:270},r);if(g(a)||g(l))return;const o=Mi(a,r),d=Mi(l,r),c=ms(s,t),u=_i.shortestSignedDiff(c,o),m=_i.shortestSignedDiff(c,d);n.orientation=Math.abs(u)<Math.abs(m)?90:270,i.stopPropagation()}function us(i){const{cancel:e,computation:t,settingHeading:n,steps:s,view:r}=i;if(!Pt(t))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=t,d=y(),c=gs(y(),o,o.directSegment,a),u=_s($.get(),{forHeading:n,geometry:o,renderCoordsHelper:a}),m=yi(c,u,vi()),_=et(l.orientation,n?()=>Mi(o,r.renderCoordsHelper):0);s.next(is(r,m)).next(S=>{S.action==="start"&&I(d,S.renderStart);const P=pr(m),w=ma(d,S.renderEnd,c,P);let L=_-mr(w);n||(L=uo(L)),l.orientation=L}),e.next(Ii(l,["orientation"]))}function uo(i){const e=_i.normalize(i)%90;return e<D.orientationSnapThresholdDegrees?i-e:90-e<D.orientationSnapThresholdDegrees?i+(90-e):i}function po(i,{computation:e,manipulatorMeasureType:t,view:n}){let s=R.Direct,r=0,a=0;return[i.events.on("grab-changed",l=>{if(l.action!=="start"||!Pt(e))return;const{dimension:o,geometry:d}=e;s=o.measureType,r=o.offset,a=o.orientation;const c=I($.get(),i.renderLocation);o.measureType=t,o.offset=ka(c,t,d,n.renderCoordsHelper),o.orientation=0}),Mt(i,(l,o,d)=>{if(!Pt(e))return;const{geometry:c,dimension:u}=e,{renderCoordsHelper:m}=n,_=rs(ys,t,e,m),S=ti($.get(),{measureType:t,directSegment:c.directSegment,renderCoordsHelper:m}),P=Gi(l);o.next(P).next(ps(n,u,_,S)),d.next(P).next(w=>(u.measureType=s,u.offset=r,u.orientation=a,w))})]}function ps(i,e,t,n){const s=rt($.get(),t.endRenderSpace,t.startRenderSpace);de(s,s,n);const r=yi(t.startRenderSpace,s,vi()),a=yi(t.startRenderSpace,n,vi()),l=e.offset;let o,d=0;const c=new ts;return c.next(is(i,r)).next(u=>{u.action==="start"&&(d=an(a,u.renderStart));const m=(an(a,u.renderEnd)-d)*i.renderCoordsHelper.unitInMeters;e.offset=l+m,o=u}),u=>(c.execute(u),o)}function ms(i,e){const{directSegment:t}=i,{renderCoordsHelper:n}=e,s=ii($.get(),i,n),r=Ni($.get(),i),a=de($.get(),r,s),{viewForward:l}=e.state.camera;V(a,l)>0&&bt(a,a,-1);const o=t.eval(.5,$.get());return n.headingAtPosition(o,a)}function mo(i,e,t){const{dimensionSegment:n,primaryOffsetAxis:s}=e,r=ki(gt,e),a=T(r,tt)?hr(Yt):Hi(r,s,tt,Yt),l=Math.max(In(r),D.offsetManipulator.minLengthMeters/t.unitInMeters);Gn(a,a,ge(gt,l,l,l)),i.modelTransform=a,i.renderLocation=n.eval(.5,gt)}function fo(i,e,t){fs(i,e,t,{forHeading:!0})}function go(i,e,t){fs(i,e,t,{forHeading:!1})}function fs(i,e,t,{forHeading:n}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=bt(_o,a,s.offset>=0?1:-1),o=_s(yo,{forHeading:n,geometry:r,renderCoordsHelper:t});de(o,o,l);const d=Hi(l,o,tt,Yt);i.modelTransform=d,i.renderLocation=gs(gt,r,r.dimensionSegment,t)}const _o=y(),yo=y();function vo(i,e,t,n){const{geometry:s}=e,r=rs(ys,t,e,n),a=ti(gt,{measureType:t,directSegment:s.directSegment,renderCoordsHelper:n}),l=z(hi,r.endRenderSpace,r.startRenderSpace),o=Hi(l,a,tt,Yt),d=In(l);Gn(o,o,ge(hi,d,d,d)),i.modelTransform=o,i.renderLocation=r.eval(.5,hi)}function gs(i,e,t,n){const{startRenderSpace:s,endRenderSpace:r}=t,a=So(e,n)?s:r;return I(i,a)}function _s(i,{forHeading:e,geometry:t,renderCoordsHelper:n}){return e?ii(i,t,n):ki(i,t,{invert:!0})}function So(i,e){const t=Ni(wo,i),n=ii(Po,i,e);return V(t,n)>0}const wo=y(),Po=y();function xo(i){return ce(i)+D.offsetManipulator.linePaddingPx}function ji(i){return ce(i)+D.offsetManipulator.focusedLinePaddingPx}const fe=cr.Custom1,gt=y(),hi=y(),Yt=Ai(),ys=new Ve;function bo(i){let e,t,n=[],s=!1;function r(...a){return s&&e===this&&Eo(a,n)||(t=i.apply(this,a),e=this,n=a,s=!0),t}return r}function Eo(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}var K;function Mo(i,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:i.elevationAlignedStartPoint,elevationAlignedEndPoint:i.elevationAlignedEndPoint,geometry:i.geometry}}function $o(i,e){if(ls(i))return K.Direct;if(!i.enabled)return null;const{geometry:t}=i;if(g(t)||T(t.directSegment.startRenderSpace,t.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=D,{camera:s}=e.state,r=ii($.get(),t,e.renderCoordsHelper),a=Ni($.get(),t),l=bt($.get(),r,V(a,r)),o=rt($.get(),a,l),d=gi(o),c=gi(l),{startRenderSpace:u,endRenderSpace:m}=t.directSegment,_=Math.max(s.computeRenderPixelSizeAt(u)*n,s.computeRenderPixelSizeAt(m)*n)**2;return d<_?K.Vertical:c<_?K.Horizontal:null}function Co(i,e,{constraint:t,view:n}){const{unconstrainedGeometry:s}=i;if(g(s))return;const{renderCoordsHelper:r,spatialReference:a}=n,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,d=r.fromRenderCoords(l,new Xe,a),c=r.fromRenderCoords(o,new Xe,a);let u;u=e==="start"?{startPoint:d}:{endPoint:c},vs(i,u,{constraint:t,elevationAlignedStartPoint:i.elevationAlignedStartPoint,elevationAlignedEndPoint:i.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function vs(i,e,t){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=t,{dimension:o,previousConstraint:d,preConstraintProperties:c}=i;if(g(s)||g(r))return;const u=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(g(n))u(),f(d)&&f(c)&&(o.measureType=c.measureType,o.orientation=c.orientation);else switch(o.measureType=R.Direct,n){case K.Horizontal:if(n!==d&&(o.orientation=0),"startPoint"in e){const m=e.startPoint;f(m)&&(m.z=r.z),o.startPoint=m}else if("endPoint"in e){const m=e.endPoint;f(m)&&(m.z=s.z),o.endPoint=m}break;case K.Vertical:if(n!==d&&(o.orientation=ms(a,l)),"startPoint"in e){const m=e.startPoint;f(m)&&(m.x=r.x,m.y=r.y),o.startPoint=m}else if("endPoint"in e){const m=e.endPoint;f(m)&&(m.x=s.x,m.y=s.y),o.endPoint=m}break;case K.Direct:n!==d&&f(c)&&(o.orientation=c.orientation),u()}i.previousConstraint=n,i.unconstrainedGeometry=a}(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.Direct=2]="Direct"})(K||(K={}));let Oo=class extends ns{constructor(e){super(e),this._ray=_r(),this._isWorldDown=!1,this._start=y(),this._end=W(1,0,0),this._width=1,this._color=jt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=jt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=X.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=x.OccludeAndTransparent,this._fadedExtensions=Pn,this._laserline=new ba({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,I(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),rt(this._end,e,this._end),ai(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,T(this._start,e)||(I(this._start,e),ai(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,T(this._end,e)||(I(this._end,e),ai(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Je(e,this._color)||(yt(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Je(e,this._innerColor)||(yt(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=f(e)!==f(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(g(e)||g(this._stippleOffColor)||!Je(e,this._stippleOffColor))&&(this._stippleOffColor=f(e)?Fn(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&f(this._laserlineStyle)&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,f(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===x.OccludeAndTransparentStencil?x.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=et(e,Pn),this.recreateGeometry()}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=we(this.object3dResources.resources))==null||t.material.setParameters(e),(n=we(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new me(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const s=this._createGeometry(e);n.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new me(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);this._updateVerticesDraped(t);const n=new Nn(t,{boundingInfo:t.boundingInfo});return n.computeBoundingSphere(n.transformation,n.boundingSphere),n}_createGeometry(e){const t=this.extensionType===X.FADED,n=t?[y(),y(),y(),y()]:[y(),y()];return it(e,n,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=we(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===X.FADED?this._updateLineSegmentFinite(Sn):this._updateLineSegmentInfinite(this._extensionType,Sn)}_updateLineSegmentFinite(e){return on(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const n=this.view.state.camera;switch(yr(this._ray,ye),e){case X.LINE:ye.c0=-Number.MAX_VALUE;break;case X.RAY:case X.GROUND_RAY:{const a=this._ray.origin,l=et(this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&vr(ye.ray.direction,ye.ray.direction),this._extensionType===X.GROUND_RAY&&l!=null&&(ye.c1=Math.abs(o-l));break}}if(!Sr(n.frustum,ye))return this._updateLineSegmentFinite(t);const s=wr(ye,be),r=Pr(ye,To);return on(s,r,t)}_updateVertexAttributesObject3D(e,t){var r;const n=(r=e.geometries[0].getMutableAttribute(qt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=a[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,t){var r;const n=(r=e.getMutableAttribute(qt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=Si;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===X.FADED?(yield Ne(e,-this.fadedExtensions.start,be),yield Ne(e,0,be),yield Ne(e,1,be),yield Ne(e,1+this.fadedExtensions.end,be)):(yield Ne(e,0,be),yield Ne(e,1,be))}};const ye=fr(),be=y(),To=y(),Sn=gr();var X;(function(i){i[i.LINE=0]="LINE",i[i.RAY=1]="RAY",i[i.GROUND_RAY=2]="GROUND_RAY",i[i.FADED=3]="FADED"})(X||(X={}));const wn=1/3,Pn={start:wn,end:wn};let Ro=class extends ns{constructor(e){super(e),this._location=y(),this._direction=W(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=jt(1,0,1,1),this._renderOccluded=x.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){T(this._location,e)||(I(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){T(this._direction,e)||(I(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){Vn(this._direction,rt(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Je(e,this._color)||(yt(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new me(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const[s,r]=this._createGeometries(e);t.addGeometry(s),t.addGeometry(r),n.push(s),n.push(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new me(this.materialParameters),t=E(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);this._updateVerticesDraped(t);const n=t.map(s=>new Nn(s,{boundingInfo:s.boundingInfo}));for(const s of n)s.computeBoundingSphere(s.transformation,s.boundingSphere);return n}_createGeometries(e){return[it(e,[y(),y()]),it(e,[y(),y()])]}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=we(this.object3dResources.resources))==null||t.material.setParameters(e),(n=we(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=we(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Vt),kn(le,this.location,this.direction),t.projectToScreen(le,ke),xr(ke,he(ke,ke,Vt)),this._updateVertexAttributesObject3D(t,e,0,Vt,ke,1),this._updateVertexAttributesObject3D(t,e,1,Vt,ke,-1)}_updateVertexAttributesObject3D(e,t,n,s,r,a){var u;const l=t.geometries[n],o=(u=l.getMutableAttribute(qt.POSITION))==null?void 0:u.data;if(!o)return;const{start:d,end:c}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(ln(d),le),o[0]=le[0],o[1]=le[1],o[2]=le[2],e.unprojectFromScreen(ln(c),le),o[3]=le[0],o[4]=le[1],o[5]=le[2],t.geometryVertexAttrsUpdated(l)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:n}}}=this,{location:s,width:r,length:a,offset:l}=this,o=Do;o.spatialReference=Q(t.renderer.spatialReference),o.x=s[0],o.y=s[1];const d=t.overlayPixelSizeInMapUnits(o)*n,c=r*d,u=a*d,m=l*d;this._updateVertexAttributesDraped(e[0],c,u,m,-1),this._updateVertexAttributesDraped(e[1],c,u,m,1)}_updateVertexAttributesDraped(e,t,n,s,r){var u;const a=(u=e.getMutableAttribute(qt.POSITION))==null?void 0:u.data;if(!a)return;const{location:l,direction:o}=this,{start:d,end:c}=this._computeStartEnd(o,l,r,s,t,n);a[0]=d[0],a[1]=d[1],a[2]=Si,a[3]=c[0],a[4]=c[1],a[5]=Si,e.invalidateBoundingInfo()}_computeStartEnd(e,t,n,s,r,a){const l=oi(xn,br(xn,e[1]*n,e[0]*-n),s+r/2),o=Ct(zt,Ct(zt,Ct(zt,t,oi(zt,e,a/2)),l),l);return{start:o,end:Ct(bn,o,oi(bn,e,-a))}}};const le=y(),xn=re(),zt=re(),bn=re(),Vt=jn(),ke=jn(),Do=Se(0,0,void 0,null);let ie=class extends qn{constructor(){super(...arguments),this.enabled=!0}};h([p({type:Boolean})],ie.prototype,"enabled",void 0),ie=h([F("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],ie);let C=class extends qn{constructor(e){super(e),this.lineSnapper=new ie,this.parallelLineSnapper=new ie,this.rightAngleSnapper=new ie,this.rightAngleTriangleSnapper=new ie,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new M([255,127,0]),this.orangeTransparent=new M([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"lineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"parallelLineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"rightAngleSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"rightAngleTriangleSnapper",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],C.prototype,"shortLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],C.prototype,"distance",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"pointThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"intersectionParallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"parallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C.prototype,"verticalLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"touchSensitivityMultiplier",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"pointOnLineThreshold",void 0),h([p({type:M,nonNullable:!0})],C.prototype,"orange",void 0),h([p({type:M,nonNullable:!0})],C.prototype,"orangeTransparent",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"lineHintWidthReference",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"lineHintWidthTarget",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C.prototype,"lineHintFadedExtensions",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"parallelLineHintWidth",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],C.prototype,"parallelLineHintLength",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],C.prototype,"parallelLineHintOffset",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],C.prototype,"rightAngleHintSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],C.prototype,"rightAngleHintOutlineSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],C.prototype,"satisfiesConstraintScreenThreshold",void 0),C=h([F("esri.views.interactive.snapping.Settings.Defaults")],C);const b=new C;var H;(function(i){i[i.FEATURE=1]="FEATURE",i[i.SELF=2]="SELF",i[i.ALL=3]="ALL"})(H||(H={}));function Md(i){return i}function Ss(i){return xe(i)}function Ao(i,e,t){return W(i,e,t)}function O(i,e,t){return g(i)?null:ht(t.coordinateHelper.vectorToDehydratedPoint(i,Lo),e,t)}function ht(i,e,t){if(g(i))return null;if(g(e))return W(i.x,i.y,i.z??0);if(e.type==="2d")return W(i.x,i.y,0);const{elevationInfo:n}=t,s=wa(e,i,n,A)??0;return W(i.x,i.y,s)}function En(i,e,{z:t,m:n,spatialReference:s,elevationInfo:r}){if(t==null&&n==null){const o=Se(i[0],i[1],void 0,s);return n!=null&&(o.m=n,o.hasM=!0),o}if(g(e)||e.type==="2d"){const o=Se(i[0],i[1],t,s);return n!=null&&(o.m=n,o.hasM=!0),o}const a=Pa(e,i,s,A,r)??0,l=Se(i[0],i[1],a,s);return n!=null&&(l.m=n,l.hasM=!0),l}function Mn(i,e){return Se(i[0],i[1],i[2],e)}const Lo=Se(0,0,0,null),$n={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Cn={toggle:"Control"};function He(i,e){const t=i.x-e.x,n=i.y-e.y;return t*t+n*n}function zo(i,e){return Math.sqrt(He(i,e))}function qi(i,e){e.sort((t,n)=>wi(t.targetPoint,i)-wi(n.targetPoint,i))}var q;function $d({point:i,distance:e,types:t,coordinateHelper:{spatialReference:n}},s,r){return{point:Se(i[0],i[1],i[2],n.toJSON()),mode:s,distance:e,types:t,query:f(r)?r.toJSON():{where:"1=1"}}}function Xt(i,e,t){return{left:O(i.leftVertex.pos,e,t),right:O(i.rightVertex.pos,e,t)}}function Cd(i){return i.createQuery()}function Vo(i,e=()=>{}){const t=E(()=>({view:i.view,snappingOptions:i.snappingOptions}),({view:n,snappingOptions:s})=>{const r="snapping-toggle",a=Er.TOOL;if(i.removeHandles(r),n&&f(s)){const l=[n.on("key-down",o=>{o.key!==Cn.toggle||o.repeat||(s.enabledToggled=!0,e())},a),n.on("key-up",o=>{o.key===Cn.toggle&&(s.enabledToggled=!1,e())},a),n.on("pointer-move",o=>{const d=o.native.ctrlKey;s.enabledToggled!==d&&(s.enabledToggled=d,e())},a)];i.addHandles(l,r)}},k);i.addHandles(t)}(function(i){i[i.TARGET=0]="TARGET",i[i.REFERENCE=1]="REFERENCE",i[i.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(q||(q={}));let $t=class{constructor(e,t){this.isDraped=e,this.domain=t}},ws=class Ps extends $t{constructor(e,t,n=H.ALL){super(t,n),this.intersectionPoint=e}equals(e){return e instanceof Ps&&T(this.intersectionPoint,e.intersectionPoint)}},J=class xs extends $t{constructor(e,t,n,s,r=H.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=n,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof xs&&this.type===e.type&&T(this.lineStart,e.lineStart)&&T(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return Nt(this.lineStart,this.lineEnd)}},bs=class Es extends $t{constructor(e,t,n,s=H.ALL){super(n,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof Es&&T(this.lineStart,e.lineStart)&&T(this.lineEnd,e.lineEnd)}},Ho=class Ms extends $t{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof Ms&&T(this.point,e.point)}},Ui=class $s extends $t{constructor(e,t,n,s,r=H.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=n}equals(e){return e instanceof $s&&T(this.previousVertex,e.previousVertex)&&T(this.centerVertex,e.centerVertex)&&T(this.nextVertex,e.nextVertex)}},Io=class{draw(e,t){const n=this._getUniqueHints(e),s=this.sortUniqueHints(n),r=[];for(const a of s)a instanceof ws&&r.push(this.visualizeIntersectionPoint(a,t)),a instanceof J&&r.push(this.visualizeLine(a,t)),a instanceof bs&&r.push(this.visualizeParallelSign(a,t)),a instanceof Ui&&r.push(this.visualizeRightAngleQuad(a,t)),a instanceof Ho&&r.push(this.visualizePoint(a,t));return Mr(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const t=[];for(const n of e){let s=!0;for(const r of t)if(n.equals(r)){s=!1;break}s&&t.push(n)}return t}},Go=class extends Io{sortUniqueHints(e){return e.sort((t,n)=>(n instanceof J?n.length:0)-(t instanceof J?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:n,view:s}=t;return qe(new fn({view:s,primitive:"circle",geometry:Mn(e.intersectionPoint,n),elevationInfo:e.isDraped?mn:A,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:M.toUnitRGBA(b.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.point,e.domain,t);return qe(new fn({view:n,primitive:"circle",geometry:Mn(r,s),elevationInfo:this._hintElevationInfo(e,t),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:M.toUnitRGBA(b.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.lineStart,e.domain,t),a=this._alignPoint(e.lineEnd,e.domain,t);return qe(this._createLineSegmentHint(e.type,r,a,s,this._hintElevationInfo(e,t),n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:n,spatialReference:s}=t,{isDraped:r}=e,a=this._hintElevationInfo(e,t),l=this._alignPoint(e.lineStart,e.domain,t),o=this._alignPoint(e.lineEnd,e.domain,t),d=Ee(l,s,a,n,r),c=Ee(o,s,a,n,r),u=Un(c,d,c,.5),m=new Ro({view:n,attached:!1,offset:b.parallelLineHintOffset,length:b.parallelLineHintLength,width:b.parallelLineHintWidth,color:M.toUnitRGBA(b.orange),location:u,renderOccluded:r?x.OccludeAndTransparent:x.Opaque,isDraped:r,renderGroup:li.SnappingHint});return m.setDirectionFromPoints(d,u),m.attached=!0,qe(m)}visualizeRightAngleQuad(e,t){const{view:n,spatialReference:s}=t,r=this._hintElevationInfo(e,t),{isDraped:a}=e,l=this._alignPoint(e.previousVertex,e.domain,t),o=this._alignPoint(e.centerVertex,e.domain,t),d=this._alignPoint(e.nextVertex,e.domain,t),c=Ee(l,s,r,n,a),u=Ee(o,s,r,n,a),m=Ee(d,s,r,n,a);return qe(new xa({view:n,attached:!0,color:a?M.toUnitRGBA(b.orangeTransparent):M.toUnitRGBA(b.orange),renderOccluded:a?x.OccludeAndTransparent:x.Transparent,outlineRenderOccluded:a?x.OccludeAndTransparent:x.Opaque,outlineColor:M.toUnitRGBA(b.orange),outlineSize:b.rightAngleHintOutlineSize,size:b.rightAngleHintSize,isDraped:a,geometry:{previous:c,center:u,next:m},renderGroup:li.SnappingHint}))}_createLineSegmentHint(e,t,n,s,r,a,l=!1,o=!0,d=!0){const c=Ee(t,s,r,a,l),u=Ee(n,s,r,a,l),m=new Oo({view:a,extensionType:X.FADED,start:c,end:u,isDraped:l,color:M.toUnitRGBA(b.orange),renderOccluded:l?x.OccludeAndTransparent:x.Opaque,renderGroup:li.SnappingHint});switch(e){case q.TARGET:m.width=b.lineHintWidthTarget,m.fadedExtensions={start:0,end:b.lineHintFadedExtensions};break;case q.REFERENCE_EXTENSION:m.width=b.lineHintWidthReference,m.fadedExtensions={start:0,end:0};break;case q.REFERENCE:m.width=b.lineHintWidthReference,m.fadedExtensions={start:o?b.lineHintFadedExtensions:0,end:d?b.lineHintFadedExtensions:0}}return m.attached=!0,m}_alignPoint(e,t,n){const s=this._getSelfSnappingZ(t,n);return g(s)?e:Ao(e[0],e[1],s)}_hintElevationInfo(e,t){return f(this._getSelfSnappingZ(e.domain,t))?Q(t.selfSnappingZ).elevationInfo:e.isDraped?mn:A}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===H.SELF&&f(t)?t.value:null}};function Ee(i,e,t,n,s,r=y()){if(s){const a=n.basemapTerrain.overlayManager.renderer.spatialReference;Ft(i,e,r,a)}else la(i,e,t,n,r);return r}const v={main:new M([255,127,0]),selected:new M([255,255,255]),staged:new M([12,207,255]),outline:new M([0,0,0,.5]),selectedOutline:new M([255,255,255])},Qe=.3;function xt(i,e){const t=i.clone();return t.a*=e,t}function Fo(i,e){const t=i.clone(),n=Ea(t);n.s*=e;const s=Ma(n);return t.r=s.r,t.g=s.g,t.b=s.b,t}function ee(i,e){if(e)for(const t in e)i[t]=e[t]}let No=class{constructor(e){this.color=v.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=x.Opaque,ee(this,e)}},ui=class{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=v.main,this.outlineColor=v.outline,this.renderOccluded=x.Opaque,this.hoverOutlineColor=v.selectedOutline,ee(this,e)}apply(e,t){const n=this[e];t.setParameters({color:Pe(n),transparent:e!=="color"||n.a<1,renderOccluded:this.renderOccluded})}},ko=class{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=xt(v.main,.5),this.hoverColor=v.main,this.renderOccluded=x.Transparent,this.minSquaredEdgeLength=900,ee(this,e)}apply(e,t){const n=this[e];t.setParameters({color:Pe(n),transparent:n.a<1,renderOccluded:this.renderOccluded})}},jo=class{constructor(e){this.vertex=new ui({color:v.main,outlineColor:v.outline}),this.edge=new ui({color:Fo(xt(v.main,2/3),.5),outlineColor:xt(v.outline,.5),size:8,collisionPadding:8}),this.selected=new ui({color:v.selected,outlineColor:v.outline}),this.edgeOffset=new ko,ee(this,e)}},$i=class{constructor(e){this.color=v.selected,this.width=1.5,this.stipplePattern=Le(5),this.stippleOffColor=v.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=v.selected,this.renderOccluded=x.OccludeAndTransparent,ee(this,e)}apply(e){e.color=Pe(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Pe(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Pe(this.innerColor),e.renderOccluded=this.renderOccluded}},qo=class{constructor(e){this.color=v.selected,this.size=4,this.outlineSize=1,this.outlineColor=v.outline,this.shape="square",ee(this,e)}apply(e){e.color=Pe(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Pe(this.outlineColor),e.primitive=this.shape}},Jt=class{constructor(e){this.innerColor=v.selected,this.innerWidth=1,this.glowColor=v.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=Qe,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=v.main,ee(this,e)}apply(e,t=1){const n={glowColor:M.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:M.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=n:e.laserlineStyle=n}},Uo=class{constructor(e){this.outline=new $i({color:v.outline,renderOccluded:x.OccludeAndTransparentStencil,stippleOffColor:v.selected,stipplePattern:Le(5),width:1.5,innerWidth:0}),this.staged=new $i({color:v.selected,renderOccluded:x.OccludeAndTransparentStencil,innerColor:v.staged,stippleOffColor:v.outline,stipplePattern:Le(5),width:1.5}),this.shadowStyle=new Jt({globalAlpha:Qe,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:1}),ee(this,e)}},Wo=class{constructor(e){this.outline=new qo({color:v.selected,outlineColor:v.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Jt({globalAlpha:Qe,glowColor:v.main,glowFalloff:1.5,glowWidth:6,innerColor:v.selected,innerWidth:1,radius:2}),ee(this,e)}};class Bo extends $i{constructor(e){super(),this.extensionType=X.GROUND_RAY,ee(this,e)}}let Zo=class{constructor(e){this.lineGraphics=new Uo,this.pointGraphics=new Wo,this.heightPlane=new Jt({globalAlpha:Qe,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:1}),this.heightBox=new Jt({globalAlpha:Qe,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:0,heightFillColor:v.main}),this.zVerticalLine=new Bo({color:xt(v.main,5*Qe/3),falloff:2,innerColor:xt(v.selected,0),renderOccluded:x.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:X.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,ee(this,e)}},Yo=class{constructor(e){this.visualElements=new Zo,this.reshapeManipulators=new jo,this.zManipulator=new No,ee(this,e)}colorToVec4(e){return Pe(e)}};function Pe(i){return $r(M.toUnitRGBA(i))}const je=new Yo;function Xo(i,e,t,n,s){const r=dn(3*i.length),a=dn(r.length);i.forEach((d,c)=>{r[3*c+0]=d[0],r[3*c+1]=d[1],r[3*c+2]=d.length>2?d[2]:0});const l=Cr(r,e,0,a,0,r,0,r.length/3,t,n,s),o=l!=null;return{numVertices:i.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}let Jo=class extends Jn{constructor(e){super(e),this.view=null,this._renderOccluded=x.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=je.colorToVec4(je.reshapeManipulators.vertex.color),this._size=je.reshapeManipulators.vertex.size,this._outlineColor=je.colorToVec4(je.reshapeManipulators.vertex.outlineColor),this._outlineSize=je.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Je(e,this._color)||(yt(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Je(e,this._outlineColor)||(yt(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(g(e)||e.length===0)return[];const t=.5,n=.5,s=Xo(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Or.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const d=ge(Ko,l[3*o+0],l[3*o+1],l[3*o+2]),c=On(this._vertexMaterial,t,d),u=On(this._vertexOutlineMaterial,n,d);r.push({vertexGeometry:c,vertexOutlineGeometry:u})}return r}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:n,vertexOutlineGeometry:s}of t)e.addGeometry(n),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new pn({...this._vertexMaterialParameters,writeDepth:!0,cullFace:cn.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new pn({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:cn.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Ko=y();function On(i,e,t){return Tr(i,e,16,16,{offset:t})}let Oe=class extends _e{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};h([p({constructOnly:!0})],Oe.prototype,"layer",void 0),h([p()],Oe.prototype,"enabled",void 0),h([p()],Oe.prototype,"updating",void 0),h([p()],Oe.prototype,"availability",void 0),Oe=h([F("esri.views.interactive.snapping.FeatureSnappingLayerSource")],Oe);const Cs=Oe;let B=class extends _e{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new at,this.distance=b.distance,this.touchSensitivityMultiplier=b.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};h([p()],B.prototype,"enabled",void 0),h([p()],B.prototype,"enabledToggled",void 0),h([p()],B.prototype,"selfEnabled",void 0),h([p()],B.prototype,"featureEnabled",void 0),h([p({type:at.ofType(Cs)})],B.prototype,"featureSources",void 0),h([p()],B.prototype,"distance",void 0),h([p()],B.prototype,"touchSensitivityMultiplier",void 0),h([p({readOnly:!0})],B.prototype,"effectiveEnabled",null),h([p({readOnly:!0})],B.prototype,"effectiveSelfEnabled",null),h([p({readOnly:!0})],B.prototype,"effectiveFeatureEnabled",null),B=h([F("esri.views.interactive.snapping.SnappingOptions")],B);const Os=B;function Qo(i,e){const t=new Os({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(e==null?void 0:e.distance)??b.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??b.touchSensitivityMultiplier});return{...E(()=>{var n,s;return((s=(n=i.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{t.featureSources=new at(n.map(s=>new Cs({layer:s,enabled:!0})))},Ut),options:t}}function Ci({start:i,end:e,type:t},n,s){const r=[],a=he(Ie,e,i),l=he(ot,i,n),o=vt(a),d=2*Et(a,l),c=d*d-4*o*(vt(l)-s*s);if(c===0){const u=-d/(2*o);(t===ae.PLANE||u>=0)&&r.push(mt(re(),i,a,u))}else if(c>0){const u=Math.sqrt(c),m=(-d+u)/(2*o);(t===ae.PLANE||m>=0)&&r.push(mt(re(),i,a,m));const _=(-d-u)/(2*o);(t===ae.PLANE||_>=0)&&r.push(mt(re(),i,a,_))}return r}function Oi(i,e){const t=i.start,n=i.end,s=he(Ie,n,t),r=ge(ot,-s[1],s[0],0),a=e.start,l=e.end,o=z(Bi,l,a),d=V(o,r),c=ge(As,t[0],t[1],0),u=z(Ls,c,a),m=V(u,r);if(Math.abs(d)<ne)return[];const _=se(zs,a,o,m/d);if(e.type===j.RAY){const S=z(Qt,_,a);if(V(S,o)<-ne)return[]}if(i.type===ae.HALF_PLANE){const S=Rr(Qt,_,t);if(Et(S,s)<-ne)return[]}return[xe(_)]}function Ti(i,e){return Ri(Kt(Zi,e[2],i),e)}function Ts(i,e){const n=Ds(Kt(Zi,0,i),Kt(il,0,e)),s=[];for(const r of n)s.push(Dr(r));return s}function Rs(i,e){return Wi(i,Kt(Zi,i[2],e))}function el(i,e,t){const n=he(Ie,i,e),s=t/Ar(n),r=mt(y(),e,n,s);return r[2]=i[2],r}function Wi(i,{start:e,end:t,type:n}){const s=z(Ie,i,e),r=z(ot,t,e),a=V(s,r)/V(r,r);return se(y(),e,r,n===j.RAY?Math.max(a,0):a)}function Tn({start:i,end:e,type:t},n,s){const r=[],a=rt(Ie,e,i),l=he(ot,i,n),o=vt(a),d=2*Et(a,l),c=d*d-4*o*(vt(l)-s*s);if(c===0){const u=-d/(2*o);(t===j.LINE||u>=0)&&r.push(se(y(),i,a,u))}else if(c>0){const u=Math.sqrt(c),m=(-d+u)/(2*o);(t===j.LINE||m>=0)&&r.push(se(y(),i,a,m));const _=(-d-u)/(2*o);(t===j.LINE||_>=0)&&r.push(se(y(),i,a,_))}return r}function Ds(i,e){const t=i.start,n=i.end,s=e.start,r=e.end,a=z(Ie,n,t),l=z(ot,r,s),o=z(Bi,s,t),d=de(As,a,l),c=V(o,d);if(!Pi(c,0,ne))return[];const u=xi(d);if(Pi(u,0,ne))return[];const m=de(Ls,o,l),_=V(m,d)/u,S=se(zs,t,a,_);if(i.type===j.RAY){const P=z(Qt,S,t);if(V(a,P)<-ne)return[]}if(e.type===j.RAY){const P=z(Qt,S,s);if(V(l,P)<-ne)return[]}return[xe(S)]}function Ri({start:i,end:e,type:t},n){const s=z(Ie,n,i),r=z(ot,e,i),a=de(Bi,r,s);if(xi(a)/xi(r)<ne)switch(t){case j.LINE:return[xe(n)];case j.RAY:return V(r,s)<-ne?[]:[xe(n)]}return[]}function Rn(i,e,t){return Pi(ze(t,i),e*e,ne)?[xe(t)]:[]}function Kt(i,e,{start:t,end:n,type:s}){return ge(i.start,t[0],t[1],e),ge(i.end,n[0],n[1],e),i.type=tl[s],i}var ae;(function(i){i[i.PLANE=0]="PLANE",i[i.HALF_PLANE=1]="HALF_PLANE"})(ae||(ae={}));const tl={[ae.PLANE]:j.LINE,[ae.HALF_PLANE]:j.RAY},ne=1e-6,Ie=y(),ot=y(),Bi=y(),As=y(),Ls=y(),zs=y(),Qt=y(),Zi={start:y(),end:y(),type:j.LINE},il={start:y(),end:y(),type:j.LINE};let Ge=class{intersect(e){return al(this,e)}},nl=class extends Ge{constructor(e){super(),this.point=e}equals(e){return We(e)&&T(this.point,e.point)}closestTo(){return Ss(this.point)}},Vs=class extends Ge{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return Re(e)&&this.type===e.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){const t=Wi(e,this.lineLike);return t}},sl=class extends Vs{constructor(e,t){super(e,t,j.LINE)}},Hs=class Is extends Ge{constructor(e,t,n){super(),this.intersection=e,this.first=t,this.second=n}equals(e){return e instanceof Is&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return Ss(this.intersection)}},pi=class Gs extends Ge{constructor(e,t,n){super(),this.basePoint=e,this.first=t,this.second=n}equals(e){return e instanceof Gs&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const t=this.basePoint;return W(t[0],t[1],e[2])}},Fs=class extends Ge{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return Be(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=el(e,this.center,this.radius);return t}},Yi=class extends Ge{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.planeLike={start:e,end:t,type:n}}equals(e){return De(e)&&this.type===e.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){return Rs(e,this.planeLike)}closestEndTo(e){const{start:t,end:n}=this;return Math.sign(Et(he(ll,n,t),he(dl,e,t)))>0?n:t}};class Ns extends Yi{constructor(e,t){super(e,t,ae.HALF_PLANE)}}let ks=class extends Yi{constructor(e,t){super(e,t,ae.PLANE)}},js=class extends Ge{constructor(e,t,n){super(),this.start=e,this.end=t,this.getZ=n,this.planeLike={start:e,end:t,type:ae.HALF_PLANE}}equals(e){return Ae(e)&&T(this.start,e.start)&&T(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return rl(this,e)}addIfOnTheGround(e,t){for(const n of t){const s=et(this.getZ(n[0],n[1],n[2]),0);Math.abs(n[2]-s)<ne&&(n[2]=s,e.push(n))}}};function rl(i,e){const t=Rs(e,i.planeLike);return t[2]=we(i.getZ(e[0],e[1],e[2]))??qs,t}function al(i,e){let t=[];if(We(i)){const{point:n}=i;Re(e)?t=Ri(e.lineLike,n):Be(e)?t=Rn(e.center,e.radius,n):De(e)?t=Ti(e.planeLike,n):Ae(e)&&(t=ct(e,i))}else if(Re(i)){const{lineLike:n}=i;We(e)?t=Ri(n,e.point):Re(e)?t=Ds(n,e.lineLike):Be(e)?t=Tn(n,e.center,e.radius):De(e)?t=Oi(e.planeLike,n):Ae(e)&&(t=ct(e,i))}else if(Be(i)){const{center:n,radius:s}=i;if(Re(e))t=Tn(e.lineLike,n,s);else if(We(e))t=Rn(n,s,e.point);else{if(De(e))return Ci(e.planeLike,n,s).map(r=>new pi(r,i,e));Ae(e)&&(t=ct(e,i))}}else if(De(i)){const{planeLike:n}=i;if(De(e))return Ts(n,e.planeLike).map(s=>new pi(s,i,e));if(We(e))t=Ti(n,e.point);else if(Re(e))t=Oi(n,e.lineLike);else{if(Be(e))return Ci(n,e.center,e.radius).map(s=>new pi(s,i,e));Ae(e)&&(t=ct(e,i))}}else Ae(i)&&(t=ct(i,e));return ol(t,i,e)}function ct(i,e){const{planeLike:t,getZ:n}=i,s=[];if(We(e))i.addIfOnTheGround(s,Ti(t,e.point));else if(Re(e))i.addIfOnTheGround(s,Oi(t,e.lineLike));else if(Be(e))for(const[r,a]of Ci(t,e.center,e.radius)){const l=n(r,a,0);f(l)&&s.push(W(r,a,l))}else if(De(e)||Ae(e))for(const[r,a]of Ts(t,e.planeLike)){const l=we(n(r,a,0))??qs;s.push(W(r,a,l))}return s}function ol(i,e,t){return i.map(n=>new Hs(n,e,t))}function We(i){return i instanceof nl}function Re(i){return i instanceof Vs}function Be(i){return i instanceof Fs}function De(i){return i instanceof Yi}function Ae(i){return i instanceof js}const ll=re(),dl=re(),qs=0;let lt=class{constructor(e,t,n,s){this.targetPoint=e,this.constraint=t,this.isDraped=n,this.domain=s}},Xi=class extends lt{constructor({targetPoint:e,objectId:t,constraint:n,isDraped:s}){super(e,n,s,H.FEATURE),this.objectId=t}},cl=class extends Xi{constructor(e){super({...e,isDraped:!0,constraint:new js(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new J(q.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},hl=class extends Xi{constructor(e){super({...e,constraint:new sl(e.edgeStart,e.edgeEnd)})}get hints(){return[new J(q.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}};class Us extends lt{constructor({targetPoint:e,constraint:t,previousVertex:n,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,t,l,H.SELF),this.previousVertex=n,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===st.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===st.CENTER?this.targetPoint:this.otherVertex;return[new J(q.TARGET,t,n,this.isDraped,this.domain),new J(q.REFERENCE,e,t,this.isDraped,this.domain),new Ui(this.previousVertex,t,n,this.isDraped,this.domain)]}}var st;(function(i){i[i.NEXT=0]="NEXT",i[i.CENTER=1]="CENTER"})(st||(st={}));let ue=class extends Li{get updating(){return Lr(this.snappingSources,({snappingSource:e})=>e.updating)||this.updatingHandles.updating}get snappingSources(){const e=this._get("snappingSources")||new Map,t=new Map;if(f(this.options)&&f(this.options.featureSources))for(const n of this.options.featureSources.items){const s=n.layer.uid,r=e.get(s);if(r){e.delete(s),t.set(s,r);continue}if(!n.layer.loaded){this.updatingHandles.addPromise(n.layer.load());continue}const a=this._createSourceInfo(n);f(a)&&t.set(s,a)}for(const[,n]of e)n.destroy();return t}constructor(e){super(e),this.options=null,this._domain=H.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),nt),f(this.view)&&this.handles.add([this.view.on("layerview-create",e=>this._updateLayerView(e.layer,e.layerView)),this.view.on("layerview-destroy",e=>this._updateLayerView(e.layer,null))])}_updateLayerView(e,t){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===e&&(n.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,n,s){var d;if(!(t&this._domain)||g(this.options)||!this.options.effectiveFeatureEnabled)return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,n),l={distance:a,mode:((d=Q(this.view))==null?void 0:d.type)??"2d",point:e,coordinateHelper:n.coordinateHelper,types:this._types};for(const[,{snappingSource:c,layerView:u}]of this.snappingSources)!c.layerSource.enabled||f(u)&&u.suspended||r.push(c.fetchCandidates(l,s).then(m=>m.filter(_=>!this._candidateIsExcluded(c,_,n.excludeFeature))));const o=(await zr(r)).flat();return this._addRightAngleCandidates(o,e,a,n),Vr(s),qi(e,o),o}_addRightAngleCandidates(e,t,n,s){var u,m,_,S,P,w,L,Fe;const r=f(s.vertexHandle)?(m=(u=s.vertexHandle.rightEdge)==null?void 0:u.rightVertex)==null?void 0:m.pos:f(s.editGeometryOperations)&&s.editGeometryOperations.data.type==="polygon"?(S=Q((_=s.editGeometryOperations.data.components[0])==null?void 0:_.getFirstVertex()))==null?void 0:S.pos:null,a=f(s.vertexHandle)?(w=(P=s.vertexHandle.leftEdge)==null?void 0:P.leftVertex)==null?void 0:w.pos:f(s.editGeometryOperations)?(Fe=Q((L=s.editGeometryOperations.data.components[0])==null?void 0:L.getLastVertex()))==null?void 0:Fe.pos:null,{view:l}=this,o=O(r,l,s),d=O(a,l,s),c=e.length;for(let oe=0;oe<c;oe++)this._addRightAngleCandidate(e[oe],d,t,n,e),this._addRightAngleCandidate(e[oe],o,t,n,e)}_addRightAngleCandidate(e,t,n,s,r){if(g(t)||!pl(e))return;const a=e.constraint.closestTo(t),l=(a[0]-n[0])/s.x,o=(a[1]-n[1])/s.y,{start:d,end:c}=e.constraint;if(l*l+o*o<=1){const u=new Us({targetPoint:a,otherVertex:t,otherVertexType:st.NEXT,previousVertex:ze(a,d)>ze(a,c)?d:c,constraint:new Ns(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(u)}}_computeScreenSizeDistanceParameters(e,t){let n=f(this.options)?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return g(this.view)?{x:n,y:n,z:n,distance:n}:this.view.type==="2d"?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,s){const{spatialReference:r}=s;n.renderCoordsHelper.toRenderCoords(e,r,Dn);const a=n.state.camera.computeScreenPixelSizeAt(Dn),l=a*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,o=t*l,d=G(e,r,A,n),c=d?mi(d,e,l,0,0,n,s):0,u=d?mi(d,e,0,l,0,n,s):0,m=d?mi(d,e,0,0,l,n,s):0;return{x:c===0?0:o/c,y:u===0?0:o/u,z:m===0?0:o/m,distance:a*t}}get _types(){return gn.EDGE|gn.VERTEX}_candidateIsExcluded(e,t,n){if(g(n))return!1;const s=this._getCandidateObjectId(t);if(g(s))return!1;const r=e.layerSource.layer;return r.type==="graphics"?n.uid===s:n.sourceLayer===r&&!(!n.attributes||!("objectIdField"in r))&&n.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof Xi?e.objectId:null}_createSourceInfo(e){const t=this._createFeatureSnappingSourceType(e);if(g(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const n=f(this.view)?this.view.allLayerViews.find(s=>s.layer===e.layer):null;return new ul(t.source,n)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}_createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;if(g(t)||t.type!=="3d")return null;const n=this._getSourceModule("scene");return f(n.module)?{source:new n.module.SceneLayerSnappingSource({layerSource:e,view:t})}:{loading:n.loader}}_createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":{const n=this._getSourceModule("featureService");return f(n.module)?{source:new n.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(e.layer.geometryType==="mesh")return null;const n=this._getSourceModule("featureCollection");return f(n.module)?{source:new n.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:n.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const t=this._getSourceModule("graphics");return f(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_createFeatureSnappingSourceMapNotesLayer(e){const t=this._getSourceModule("notes");return f(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>f(e.layer.sublayers)?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_getSourceModule(e){const t=this._sourceModules[e];if(g(t.loader)){const n=this._loadSourceModule(e).then(s=>{t.module=s});return t.loader=n,{module:t.module,loader:n}}return{module:t.module,loader:t.loader}}_loadSourceModule(e){const t=this.updatingHandles;switch(e){case"featureService":return t.addPromise(Ot(()=>import("./FeatureServiceSnappingSource-fc675202.js"),["./FeatureServiceSnappingSource-fc675202.js","./index-74d49a87.js","./index-45742df3.css","./elevationInfoUtils-3c9457ff.js","./queryEngineUtils-aca21275.js","./VertexSnappingCandidate-3ec17136.js","./TileTreeDebugger-44eb22f0.js","./LineVisualElement-904de9f6.js","./LengthDimension-ab6848c2.js","./Segment-a1fa4b06.js","./analysisViewUtils-e5cbe5fd.js","./ImageMaterial-2cbfab0b.js","./Factory-8247a6e0.js","./RightAngleQuadVisualElement-ba7b8aa2.js","./VisualElementResources-12bd7834.js","./PointVisualElement-da80c55c.js","./colorUtils-c0f43caf.js","./EditGeometryOperations-023b3d76.js","./QueryEngineResult-10a77c28.js","./WhereClause-d3d68e94.js","./executionError-fb3f283a.js","./utils-2505602d.js","./generateRendererUtils-dce0e007.js","./projectionSupport-23b402d8.js","./json-48e3ea08.js","./utils-7cfc8659.js","./dehydratedFeatureComparison-4083c3a5.js","./RenderTexture-32de94fb.js"],import.meta.url));case"featureCollection":return t.addPromise(Ot(()=>import("./FeatureCollectionSnappingSource-9f48d89f.js"),["./FeatureCollectionSnappingSource-9f48d89f.js","./index-74d49a87.js","./index-45742df3.css","./elevationInfoUtils-3c9457ff.js","./queryEngineUtils-aca21275.js","./VertexSnappingCandidate-3ec17136.js","./symbologySnappingCandidates-ea3ae5fa.js","./LineVisualElement-904de9f6.js","./LengthDimension-ab6848c2.js","./Segment-a1fa4b06.js","./analysisViewUtils-e5cbe5fd.js","./ImageMaterial-2cbfab0b.js","./Factory-8247a6e0.js","./RightAngleQuadVisualElement-ba7b8aa2.js","./VisualElementResources-12bd7834.js","./PointVisualElement-da80c55c.js","./colorUtils-c0f43caf.js","./EditGeometryOperations-023b3d76.js","./QueryEngineResult-10a77c28.js","./WhereClause-d3d68e94.js","./executionError-fb3f283a.js","./utils-2505602d.js","./generateRendererUtils-dce0e007.js","./projectionSupport-23b402d8.js","./json-48e3ea08.js","./utils-7cfc8659.js","./dehydratedFeatureComparison-4083c3a5.js","./RenderTexture-32de94fb.js"],import.meta.url));case"graphics":case"notes":return t.addPromise(Ot(()=>import("./GraphicsSnappingSource-cc5965f5.js"),["./GraphicsSnappingSource-cc5965f5.js","./index-74d49a87.js","./index-45742df3.css","./normalizeUtilsSync-e634818e.js","./FeatureStore-7c5009b6.js","./BoundsStore-b6bb441e.js","./PooledRBush-83d0be85.js","./optimizedFeatureQueryEngineAdapter-dc9b72d8.js","./centroid-d1553553.js","./utils-7cfc8659.js","./projectionSupport-23b402d8.js","./json-48e3ea08.js","./QueryEngine-a3138f9c.js","./QueryEngineResult-10a77c28.js","./WhereClause-d3d68e94.js","./executionError-fb3f283a.js","./utils-2505602d.js","./generateRendererUtils-dce0e007.js","./QueryEngineCapabilities-42e44ded.js","./timeSupport-6a05419e.js","./elevationInfoUtils-3c9457ff.js","./queryEngineUtils-aca21275.js","./VertexSnappingCandidate-3ec17136.js","./symbologySnappingCandidates-ea3ae5fa.js","./LineVisualElement-904de9f6.js","./LengthDimension-ab6848c2.js","./Segment-a1fa4b06.js","./analysisViewUtils-e5cbe5fd.js","./ImageMaterial-2cbfab0b.js","./Factory-8247a6e0.js","./RightAngleQuadVisualElement-ba7b8aa2.js","./VisualElementResources-12bd7834.js","./PointVisualElement-da80c55c.js","./colorUtils-c0f43caf.js","./EditGeometryOperations-023b3d76.js","./dehydratedFeatureComparison-4083c3a5.js","./RenderTexture-32de94fb.js"],import.meta.url));case"scene":return t.addPromise(Ot(()=>import("./SceneLayerSnappingSource-b56dc682.js"),["./SceneLayerSnappingSource-b56dc682.js","./index-74d49a87.js","./index-45742df3.css","./VertexSnappingCandidate-3ec17136.js","./LineVisualElement-904de9f6.js","./LengthDimension-ab6848c2.js","./Segment-a1fa4b06.js","./elevationInfoUtils-3c9457ff.js","./analysisViewUtils-e5cbe5fd.js","./ImageMaterial-2cbfab0b.js","./Factory-8247a6e0.js","./RightAngleQuadVisualElement-ba7b8aa2.js","./VisualElementResources-12bd7834.js","./PointVisualElement-da80c55c.js","./colorUtils-c0f43caf.js","./EditGeometryOperations-023b3d76.js","./QueryEngineResult-10a77c28.js","./WhereClause-d3d68e94.js","./executionError-fb3f283a.js","./utils-2505602d.js","./generateRendererUtils-dce0e007.js","./projectionSupport-23b402d8.js","./json-48e3ea08.js","./utils-7cfc8659.js","./dehydratedFeatureComparison-4083c3a5.js","./RenderTexture-32de94fb.js"],import.meta.url))}}};h([p({constructOnly:!0})],ue.prototype,"spatialReference",void 0),h([p({constructOnly:!0})],ue.prototype,"view",void 0),h([p()],ue.prototype,"options",void 0),h([p({readOnly:!0})],ue.prototype,"updating",null),h([p({readOnly:!0})],ue.prototype,"snappingSources",null),ue=h([F("esri.views.interactive.snapping.FeatureSnappingEngine")],ue);let ul=class{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new ei;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([E(()=>e.updating,s=>e.layerSource.updating=s,k),E(()=>e.availability,s=>e.layerSource.availability=s,k)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}};function pl(i){return(i instanceof hl||i instanceof cl)&&!ml(i)}function ml({constraint:{start:i,end:e}}){const t=wi(i,e),n=ze(i,e);return t<Hr()||n/t<gl}function mi(i,e,t,n,s,r,{spatialReference:a}){const l=I(fl,e);l[0]+=t,l[1]+=n,l[2]+=s;const o=G(l,a,A,r);return o?zo(o,i):1/0}const Dn=y(),fl=y(),gl=1e-4;class ni{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=b.shortLineThreshold*b.shortLineThreshold}snap(e,t){return f(t.vertexHandle)?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(O(e.leftVertex.pos,this.view,t),O(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:n}){return this.squaredShortLineThreshold===0||He(G(t,n,A,this.view),G(e,n,A,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return ze(e,t)<b.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}}let _l=class extends lt{constructor({lineStart:e,lineEnd:t,targetPoint:n,isDraped:s}){super(n,new ks(e,t),s,H.SELF),this._referenceLineHint=new J(q.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new J(q.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},yl=class extends ni{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,l=G(e,a,A,this.view),{view:o}=this,d=n.edges[s-1];let c=d;do{if(this.edgeExceedsShortLineThreshold(c,t)){const u=Xt(c,o,t);this._processCandidateProposal(u.left,u.right,e,l,t,r)}c=c.leftVertex.leftEdge}while(c&&c!==d);return r}snapExistingVertex(e,t){const n=[],s=Q(t.vertexHandle),r=s.component;if(r.edges.length<2)return n;const{view:a}=this,{spatialReference:l}=t,o=G(e,l,A,a),d=s.leftEdge,c=s.rightEdge;d&&c&&this.edgeExceedsShortLineThreshold(d,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal(O(d.leftVertex.pos,a,t),O(c.rightVertex.pos,a,t),e,o,t,n);const u=r.edges[0];let m=u;do{if(m!==s.leftEdge&&m!==s.rightEdge&&this.edgeExceedsShortLineThreshold(m,t)){const _=Xt(m,a,t);this._processCandidateProposal(_.left,_.right,e,o,t,n)}m=m.rightVertex.rightEdge}while(m&&m!==u);return n}_processCandidateProposal(e,t,n,s,r,a){var c;const{spatialReference:l,pointer:o}=r,d=Wi(n,{start:e,end:t,type:j.LINE});He(s,G(d,l,A,this.view))<this.squaredProximityThreshold(o)&&a.push(new _l({lineStart:e,lineEnd:t,targetPoint:d,isDraped:((c=r.elevationInfo)==null?void 0:c.mode)==="on-the-ground"}))}},vl=class extends lt{constructor({referenceLine:e,lineStart:t,targetPoint:n,isDraped:s}){const r=xe(t),{left:a,right:l}=e;rt(r,kn(r,r,l),a),super(n,new ks(t,r),s,H.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new J(q.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new bs(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new J(q.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{T(e.right,n.edge.left)&&(n.fadeLeft=!1,t.fadeRight=!1),T(e.right,n.edge.right)&&(n.fadeRight=!1,t.fadeRight=!1),T(e.left,n.edge.right)&&(n.fadeRight=!1,t.fadeLeft=!1),T(e.left,n.edge.left)&&(n.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},Sl=class extends ni{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=G(e,t.spatialReference,A,l),d=O(n.vertices[r-1].pos,l,t),c=O(n.vertices[0].pos,l,t),u=n.edges[s-1];let m=u;do{if(this.edgeExceedsShortLineThreshold(m,t)){const _=Xt(m,l,t);this._checkEdgeForParallelLines(_,d,e,o,t,a),this._checkEdgeForParallelLines(_,c,e,o,t,a)}m=m.leftVertex.leftEdge}while(m&&m!==u);return a}snapExistingVertex(e,t){const n=[],s=Q(t.vertexHandle),r=s.component;if(r.edges.length<3)return n;const{view:a}=this,l=G(e,t.spatialReference,A,a),o=s.leftEdge,d=s.rightEdge,c=r.vertices[0],u=O(c.pos,a,t),m=r.vertices.length,_=r.vertices[m-1],S=O(_.pos,a,t),P=r.edges[0];let w=P;do{if(w!==o&&w!==d&&this.edgeExceedsShortLineThreshold(w,t)){const L=Xt(w,a,t);o&&this._checkEdgeForParallelLines(L,O(o.leftVertex.pos,a,t),e,l,t,n),d&&this._checkEdgeForParallelLines(L,O(d.rightVertex.pos,a,t),e,l,t,n),s===c?this._checkEdgeForParallelLines(L,S,e,l,t,n):s===_&&this._checkEdgeForParallelLines(L,u,e,l,t,n)}w=w.rightVertex.rightEdge}while(w&&w!==P);return n}_checkEdgeForParallelLines(e,t,n,s,r,a){var m;const l=e.left,o=e.right;if(di(Me,t,l,o),ze(Me,t)<b.parallelLineThreshold)return;di(Me,n,l,o,t);const{spatialReference:d,pointer:c}=r,u=W(Me[0],Me[1],n[2]);if(He(s,G(u,d,A,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(u,t)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new vl({referenceLine:e,lineStart:t,targetPoint:u,isDraped:((m=r.elevationInfo)==null?void 0:m.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const n=e.left,s=e.right;for(const r of t)if(di(Me,s,r.constraint.start,r.constraint.end,n),ze(Me,s)<b.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const Me=re();class wl extends ni{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=G(e,t.spatialReference,A,a),o=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const c=O(o.pos,a,t),u=O(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,u,c,e,l,t)}const d=n.vertices[0];if(this.edgeExceedsShortLineThreshold(d.rightEdge,t)){const c=O(d.pos,a,t),u=O(d.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,u,c,e,l,t)}return r}snapExistingVertex(e,t){const n=[],s=Q(t.vertexHandle);if(s.component.vertices.length<3)return n;const{view:r}=this,a=G(e,t.spatialReference,A,r),l=s.leftEdge,o=s.rightEdge;if(l&&l.leftVertex.leftEdge){const d=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(d,t)){const c=O(d.rightVertex.pos,r,t),u=O(d.leftVertex.pos,r,t);this._checkForSnappingCandidate(n,u,c,e,a,t)}}if(o&&o.rightVertex.rightEdge){const d=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(d,t)){const c=O(d.leftVertex.pos,r,t),u=O(d.rightVertex.pos,r,t);this._checkForSnappingCandidate(n,u,c,e,a,t)}}return n}_checkForSnappingCandidate(e,t,n,s,r,a){var m;const{spatialReference:l,pointer:o}=a;he(Ht,n,t);const d=ge(Pl,Ht[1],-Ht[0],0),c=Et(d,he(Ht,s,n))/vt(d),u=mt(xe(s),n,d,c);if(He(r,G(u,l,A,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(u,n)||this.isVertical(n,t))return;const _=se(y(),n,d,Math.sign(c));e.push(new Us({targetPoint:u,constraint:new Ns(n,_),previousVertex:t,otherVertex:n,otherVertexType:st.CENTER,isDraped:((m=a.elevationInfo)==null?void 0:m.mode)==="on-the-ground"}))}}}const Ht=re(),Pl=y();let xl=class extends lt{constructor({targetPoint:e,point1:t,point2:n,isDraped:s}){super(e,new Fs(Un(y(),t,n,.5),.5*Wn(t,n)),s,H.SELF),this._p1=t,this._p2=n}get hints(){return[new J(q.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new J(q.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new Ui(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},bl=class extends ni{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=n.vertices[0],o=n.vertices[r-1],d=O(l.pos,a,t),c=O(o.pos,a,t);return this._processCandidateProposal(d,c,e,t,s),s}snapExistingVertex(e,t){const n=[],s=Q(t.vertexHandle),r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:a}=this,l=O(s.leftEdge.leftVertex.pos,a,t),o=O(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(l,o,e,t,n),n}_processCandidateProposal(e,t,n,s,r){var _;if(!this.exceedsShortLineThreshold(e,t,s))return;const a=Ir(El,e,t,.5),l=.5*Wn(e,t),o=y();Ca(o,n,a,l),o[2]=n[2];const d=o,{spatialReference:c,pointer:u}=s,m=G(n,c,A,this.view);if(He(m,G(d,c,A,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(e,d)||this.isVertical(d,t))return;r.push(new xl({targetPoint:d,point1:e,point2:t,isDraped:((_=s.elevationInfo)==null?void 0:_.mode)==="on-the-ground"}))}}};const El=re();let Ue=class extends _e{constructor(i){super(i),this.updating=!1,this._snappers=new at,this._domain=H.SELF}initialize(){this._snappers.push(new Sl(this.view,this.options),new yl(this.view,this.options),new wl(this.view,this.options),new bl(this.view,this.options))}set options(i){this._set("options",i);for(const e of this._snappers)e.options=i}async fetchCandidates(i,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const s of this._snappers.items)for(const r of s.snap(i,t))n.push(r);return qi(i,n),n}};h([p({readOnly:!0})],Ue.prototype,"updating",void 0),h([p({constructOnly:!0})],Ue.prototype,"view",void 0),h([p()],Ue.prototype,"options",null),Ue=h([F("esri.views.interactive.snapping.SelfSnappingEngine")],Ue);function Ml(i,e){return[new Ue({view:i,options:e}),new ue({view:i,options:e,spatialReference:i.spatialReference})]}let It=class extends lt{constructor(e,t,n,s){super(e,new Hs(e,t.constraint,n.constraint),s,H.ALL),this.first=t,this.second=n}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new ws(this.targetPoint,this.isDraped,this.domain)]}},te=class extends Gr.EventedMixin(Li){constructor(e){super(e),this.options=new Os,this.snappingEnginesFactory=Ml,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=pe.MAIN}initialize(){this.handles.add([E(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:s}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:n,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},nt),E(()=>this.options,e=>{for(const t of this._engines)t.options=e},nt),E(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:e,snappingEnginesFactory:t})=>this._recreateEngines(e,t),k)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)}_recreateEngines(e,t){if(this._destroyEngines(),!e)return;const{view:n,options:s}=this;this._engines=t(n,s)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}get _squaredSatisfiesConstraintThreshold(){return b.satisfiesConstraintScreenThreshold*b.satisfiesConstraintScreenThreshold}async snap(e){return $l(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:n}=e;this._removeVisualization();const s=this._currentMainCandidate;if(g(s))return t;const r=this._selectUpdateInput(e);if(g(r))return t;const{spatialReference:a}=n,l=hn(r,a);if(g(l))return t;const{view:o}=this,{elevationInfo:d,visualizer:c}=n,u=[],m=ht(l,o,n),_=s.constraint.closestTo(m);if(!this._arePointsWithinScreenThreshold(m,_,n))return this._resetSnappingState(),t;s.targetPoint=_,u.push(...s.hints);for(const S of this._currentOtherActiveCandidates)S.targetPoint=_,u.push(...S.hints);return f(c)&&this.handles.add(c.draw(u,{spatialReference:a,elevationInfo:Cl(n),view:o,selfSnappingZ:n.selfSnappingZ}),Gt),En(_,o,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:d})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case pe.MAIN:return e;case pe.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=pe.MAIN}_removeVisualization(){this.handles.remove(Gt)}async _snapSinglePoint({point:e,context:t,signal:n}){const{view:s}=this,r=ht(e,s,t),a=await this._fetchCandidates(r,H.ALL,t,n);return this._createSnapResult(r,pe.MAIN,a,s,t,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:t.elevationInfo},n)}async _snapMultiPoint({point:e,scenePoint:t,context:n,signal:s}){const{view:r}=this,{coordinateHelper:a,spatialReference:l}=n;await Fr(t.spatialReference,l);const o=hn(t,l),d=ht(o,r,n),c=await this._fetchCandidates(d,H.FEATURE,n,s);if(c.length>0){const _=await this._fetchCandidates(d,H.SELF,n,s);return this._createSnapResult(d,pe.SCENE,[...c,..._],r,n,{z:o.z,m:o.m,spatialReference:o.spatialReference,elevationInfo:n.elevationInfo},s)}const u=ht(e,r,n),m=await this._fetchCandidates(u,H.SELF,n,s);return this._createSnapResult(u,pe.MAIN,m,r,n,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:n.elevationInfo},s)}async _fetchCandidates(e,t,n,s){return(await Promise.all(this._engines.map(r=>r.fetchCandidates(e,t,n,s)))).flat()}_createSnapResult(e,t,n,s,r,a,l){return{get valid(){return!Nr(l)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:d,hints:c}=this._processCandidates(e,t,n,r);return this._removeVisualization(),f(r.visualizer)&&this.handles.add(r.visualizer.draw(c,{spatialReference:o,elevationInfo:A,view:s,selfSnappingZ:r.selfSnappingZ}),Gt),En(d,s,a)}}}_processCandidates(e,t,n,s){if(n.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),qi(e,n);const r=this._currentMainCandidate;if(f(r)){const a=this._findOldConstraintInNewCandidates(r,n);if(a>=0){if(!(n[a]instanceof It))return this._intersectWithOtherCandidates(a,n,e,t,s);if(this._arePointsWithinScreenThreshold(e,r.targetPoint,s))return this._updateSnappingCandidate(r,t,n,s)}}return this._intersectWithOtherCandidates(0,n,e,t,s)}_findOldConstraintInNewCandidates(e,t){return e instanceof It?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,n,s,r){const{coordinateHelper:a}=r,l=t[e],o=[];for(let d=0;d<t.length;++d){if(d===e)continue;const c=t[d];for(const u of l.constraint.intersect(c.constraint)){const m=u.closestTo(l.targetPoint);o.push([new It(m,l,c,c.isDraped),this._squaredScreenDistance(n,m,a)])}}return o.length>0&&(o.sort((d,c)=>d[1]-c[1]),o[0][1]<this._squaredPointProximityThreshold(r.pointer))?this._updateSnappingCandidate(o[0][0],s,t,r):this._updateSnappingCandidate(l,s,t,r)}_updateSnappingCandidate(e,t,n,s){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const l of n){if(e instanceof It){if(l.constraint.equals(e.first.constraint)||l.constraint.equals(e.second.constraint))continue}else if(l.constraint.equals(e.constraint))continue;const o=l.constraint.closestTo(r);this._squaredScreenDistance(o,r,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(l.targetPoint=r,this._currentOtherActiveCandidates.push(l),a.push(...l.hints))}return{snappedPoint:r,hints:a}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,t,n){return this._squaredScreenDistance(e,t,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(e,t,n){return He(this._toScreen(e,n),this._toScreen(t,n))}_toScreen(e,t){return G(e,t.spatialReference,A,this.view)}_findOldCandidateIndex(e,t){let n=-1;for(let s=0;s<e.length;++s)if(t.constraint.equals(e[s].constraint)){n=s;break}return n}get test(){return{visualizationsActive:this.handles.has(Gt),engines:this._engines}}};var pe;h([p({constructOnly:!0})],te.prototype,"view",void 0),h([p()],te.prototype,"options",void 0),h([p({readOnly:!0})],te.prototype,"updating",null),h([p()],te.prototype,"snappingEnginesFactory",void 0),h([p()],te.prototype,"_engines",void 0),h([p()],te.prototype,"_squaredMouseProximityTreshold",null),h([p()],te.prototype,"_squaredTouchProximityThreshold",null),h([p()],te.prototype,"_squaredSatisfiesConstraintThreshold",null),te=h([F("esri.views.interactive.snapping.SnappingManager")],te),function(i){i[i.MAIN=0]="MAIN",i[i.SCENE=1]="SCENE"}(pe||(pe={}));const Gt="visualization-handle";function $l(i){return f(i.scenePoint)}function Cl({coordinateHelper:i,elevationInfo:e}){return i.hasZ()?A:e}const kt=new Map;function Ol(i){if(!kt.has(i)){const n=Qo(i,{distance:10}),s=Rl(i,n.options);kt.set(i,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=kt.get(i);e.referenceCount++;const t=Wt(()=>Tl(i,e));return{snappingManager:e.snappingManager,...t}}function Tl(i,e){e.referenceCount--,e.referenceCount>0||kr(()=>{e.referenceCount===0&&(e.remove(),kt.delete(i))})}function Rl(i,e){return new te({view:i,options:e,snappingEnginesFactory:(t,n)=>[new ue({view:i,spatialReference:i.spatialReference,options:n})]})}class Ws{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function Dl({predicate:i=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:n,useZ:s=!0}){const r=new ts;if(g(e))return{snappingStep:[An,r],cancelSnapping:An};let a,l=null,o=null,d=null;const c=()=>{l=St(l),e.doneSnapping(),f(o)&&o.frameTask.remove(),o=null,a=zi(a),d=null},u=Al(e,s,r);let m=null,_=null,S=null;return{snappingStep:[P=>{if(!i(P))return P;const{action:w}=P;if(w==="start"){const{info:L}=P,Fe=Ll(e.view);if(o=zl(t,P,Fe),o.context.selfSnappingZ=null,!s&&f(L)){const oe=Hl(t.coordinateHelper,L.handle.component);f(oe)&&(o.context.selfSnappingZ={value:oe,elevationInfo:t.elevationInfo})}}if(f(o)){const{context:L,originalScenePos:Fe,originalPos:oe}=o,{mapEnd:Ji,mapStart:Ki,scenePoints:Ys}=P,si=Bs(oe,Di(Ji,Ki)),Qi=Di(Ki,oe),Xs={...P,action:"update"},Js=o.context,ri=Vl(Fe,Ys),en=e.update({point:si,scenePoint:ri,context:L});if(S=en,Zs(Ji,en,Qi,s),m=si,_=ri,w!=="end"){const{frameTask:Ks}=o;g(l)&&(l=new AbortController),d=Qs=>{n.addPromise(bi(u({frameTask:Ks,event:Xs,context:Js,point:si,scenePoint:ri,delta:Qi,getLastState:()=>({point:m,scenePoint:_,updatePoint:Qs.forceUpdate?null:S})},Q(l).signal)))},d({forceUpdate:!1}),g(a)&&(a=E(()=>e.options.effectiveEnabled,()=>d==null?void 0:d({forceUpdate:!0})))}}return w==="end"&&c(),P},r],cancelSnapping:P=>(c(),P)}}function Al(i,e,t){return Yn(async({frameTask:n,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:d},c)=>{const u=await n.schedule(()=>i.snap({point:s,scenePoint:r,context:a,signal:c}),c);if(u.valid){let m=await n.schedule(()=>u.apply(),c);const _=d();f(_.point)&&s!==_.point&&(m=i.update({point:_.point,scenePoint:_.scenePoint,context:a})),!g(_.updatePoint)&&Da(m,_.updatePoint)||(Zs(l.mapEnd,m,o,e),t.execute(l))}})}function Ll(i){return i.type==="3d"?i.resourceController.scheduler.registerTask(Bn.SNAPPING):Zn}function zl(i,e,t){return{context:new Ws({editGeometryOperations:i.editGeometryOperations,elevationInfo:i.elevationInfo,pointer:i.pointer,vertexHandle:f(e.info)?e.info.handle:null,excludeFeature:i.excludeFeature,visualizer:i.visualizer}),originalPos:f(e.snapOrigin)?i.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:f(e.scenePoints)?e.scenePoints.sceneStart:null,frameTask:t}}function Bs(i,[e,t,n]){const s=Ye(i);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=n),s}function Vl(i,e){return g(i)||g(e)?null:Bs(i,Di(e.sceneEnd,e.sceneStart))}function Di(i,e){const t=i.hasZ&&e.hasZ?i.z-e.z:0;return[i.x-e.x,i.y-e.y,t]}function Zs(i,e,[t,n,s],r){i.x=e.x+t,i.y=e.y+n,r&&i.hasZ&&e.hasZ&&(i.z=e.z+s)}function Hl(i,e){if(!i.hasZ())return null;const t=e.vertices;let n=null;for(const s of t){const r=i.getZ(s.pos);if(f(n)&&f(r)&&Math.abs(r-n)>1e-6)return null;g(n)&&(n=r)}return n}function An(i){return i}let Te=class extends _e{constructor(i){super(i),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=Yn(async(e,t,n,s)=>{const r=this._frameTask;if(g(r))return;const a=await r.schedule(()=>t.snap({...e,context:n,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&f(this._snapPoints)&&(this.stagedPoint=t.update({...this._snapPoints,context:n}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(i){this._stagedPoint=this.constrainResult(i)}initialize(){var e,t;const i=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=f(i)?i.registerTask(Bn.SNAPPING):Zn}destroy(){this._abortController=St(this._abortController),this._frameTask=zi(this._frameTask)}update(i,e,t){this._snapPoints=i;const{point:n,scenePoint:s}=i,r=e.update({point:n,scenePoint:s,context:t});return this.stagedPoint=r,r}async snap(i,e,t){const{point:n,scenePoint:s}=i;return this.stagedPoint=e.update({point:n,scenePoint:s,context:t}),this._snapPoints=i,g(this._abortController)&&(this._abortController=new AbortController),this._snap(i,e,t,this._abortController.signal)}async resnap(i,e){g(this._snapPoints)||await this.snap(this._snapPoints,i,e)}abort(){this._abortController=St(this._abortController),this._snapPoints=null}};h([p({constructOnly:!0})],Te.prototype,"view",void 0),h([p()],Te.prototype,"stagedPoint",null),h([p()],Te.prototype,"constrainResult",void 0),h([p()],Te.prototype,"_stagedPoint",void 0),Te=h([F("esri.views.interactive.snapping.SnappingOperation")],Te);let N=class extends Li{constructor(i){super(i),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new ei,this._getSnappingContext=bo(t=>new Ws({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new Oa(new Ta("point",Ra(!0,!1,this.view.spatialReference))),visualizer:new Go})),this._snappingManagerResult=Ol(i.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=fi(),this._focusedOffsetManipulatorMaterial=fi(),this._thinOffsetManipulatorMaterial=fi(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Le(2)}),this._constraintSnappingIndicator=new $e({view:i.view,attached:!0,width:1,color:M.toUnitRGBA(D.constraint.color),renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5)});const e=M.toUnitRGBA(D.disabledPointIndicator.color);e[3]*=D.disabledPointIndicator.opacity,this._stagedStartIndicator=new Jo({view:i.view,attached:!1,color:e,size:2*D.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:i.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:x.OccludeAndTransparent})}initialize(){this._snappingOperation=new Te({view:this.view}),this._orientationManipulatorTexture=Sa(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new $a({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:x.Opaque});const{computations:i}=this.analysisViewData;for(const e of i)this._addComputation(e);this.addHandles([i.on("after-add",e=>this._addComputation(e.item)),i.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([E(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:t})=>{if(g(t)||g(e))return;const n=Ye(e,new Xe);this._applyPointUpdate(t,{endPoint:n})},nt),E(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,t)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=e;if(n===(t==null?void 0:t.stagedDimension)&&r===(t==null?void 0:t.firstGrabbedManipulator)){for(const a of[s,t==null?void 0:t.selectedComputation])if(f(a)){const l=this._computationManipulators.get(a);this._updateManipulators(a,l,e)}}else for(const[a,l]of this._computationManipulators)this._updateManipulators(a,l,e)},k),E(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},Ut),E(()=>this.view.state.camera,()=>{f(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),E(()=>jr(this._stagedComputation,e=>{const t=e.elevationAlignedStartPoint,n=y();return f(t)&&this.view.renderCoordsHelper.toRenderCoords(t,n)?n:null}),e=>{f(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Vo(this,()=>{const e=this._activeComputation,t=this._stagedComputation;if(g(e)||f(t)){const n=et(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(bi(this._snappingOperation.resnap(this._snappingManager,s)))}if(f(e)){const{start:n,end:s}=this._computationManipulators.get(e);if(n.grabbing||s.grabbing){const r=n.grabbing?"start":"end",a=this._computeConstraint(e);Co(e,r,{constraint:a,view:this.view})}}})}destroy(){this._snappingOperation=_t(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(f(this._stagedComputation))return this._stagedComputation;const{selectedComputation:i}=this.analysisViewData;return this.hasGrabbedManipulators&&f(i)?i:null}get _stagedComputation(){const i=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return g(i)||g(e)||e.dimension!==i?null:e}get _constraintHandles(){return[Vi(()=>this.analysisViewData.selectedComputation,i=>{i.previousConstraint=this._computeConstraint(i)},{...k,equals:Ei}),E(()=>{const i=this._activeComputation;if(g(i))return null;const{measureType:e,orientation:t}=i.dimension;return{measureType:e,orientation:t,computation:i}},(i,e)=>{if(f(i)&&g(e)){const{measureType:t,orientation:n,computation:s}=i;switch(s.previousConstraint){case K.Horizontal:s.preConstraintProperties={measureType:R.Horizontal,orientation:0};break;case K.Vertical:s.preConstraintProperties={measureType:R.Vertical,orientation:0};break;case K.Direct:s.preConstraintProperties={measureType:R.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:t,orientation:n}}}g(i)&&f(e)&&(e.computation.preConstraintProperties=null)},nt)]}get _snappingIndicatorHandles(){const i="snapping-indicator-event-handles";return[E(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:t})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(i),g(t))n.attached=!1;else if(t===e)n.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(t),a=()=>{n.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],i)}}),E(()=>{const e=this._activeComputation;return f(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:t})=>{const n=this._constraintSnappingIndicator;f(e)&&f(t)&&t!==K.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!f(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(i){const{_stagedDimension:e}=this;if(g(e)){const t=this._onUnstagedClick(i);return this.analysis.dimensions.add(t),null}return this._onStagedClick(i),e}onPointerMove({mapPoint:i,pointerType:e}){if(e==="touch")return;const t=this._getSnappingContext(e);this.updatingHandles.addPromise(bi(this._snappingOperation.snap({point:i},this._snappingManager,t)))}onManipulatorSelectionChanged(){f(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:i,pointerType:e}){let t=i;if(e==="mouse"){const s=this._getSnappingContext(e);t=this._snappingManager.update({point:i,context:s})}const n=new ra({startPoint:Ye(t,new Xe),endPoint:null,measureType:R.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:i,pointerType:e}){const t=this._stagedComputation;if(g(t))return;let n=i;if(e==="mouse"){const r=this._getSnappingContext(e);n=this._snappingManager.update({point:i,context:r})}const s=Ye(n,new Xe);this._applyPointUpdate(t,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(i){if(this._computationManipulators.has(i))return;const e=this._setupPointManipulator(i,{isStart:!0}),t=this._setupPointManipulator(i,{isStart:!1}),n=this._setupOffsetManipulator(i),s=this._setupHeadingManipulator(i),r=this._setupRotationManipulator(i),a=this._setupMeasureTypeManipulator(i,R.Direct),l=this._setupMeasureTypeManipulator(i,R.Horizontal),o=this._setupMeasureTypeManipulator(i,R.Vertical),d=new io({start:e,end:t,offset:n,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});this._setupComputationToManipulatorsSync(i,d),this._computationManipulators.set(i,d),this.manipulators.addMany(d.values())}_removeComputation(i){const e=this._computationManipulators.get(i);if(!g(e)){this._computationHandles.remove(i),this._computationManipulators.delete(i);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(i,e){this._computationHandles.add([E(()=>i.geometry,()=>this._updateManipulators(i,e),{...k,equals:Ei})],i)}_setupPointManipulator(i,e){const{view:t}=this,{dimension:n}=i,s=no(t,{metadata:n}),r=ao(s,{isStart:e.isStart,createSnappingPipelineStep:a=>Dl({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:a=>this._applyPointUpdate(i,a),view:t});return this._computationHandles.add(r,i),s}_setupOffsetManipulator(i){const{view:e}=this,t=so(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:i.dimension}),n=oo(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupHeadingManipulator(i){const{view:e}=this,t=yn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=lo(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupRotationManipulator(i){const{view:e}=this,t=yn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=co(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupMeasureTypeManipulator(i,e){const{view:t}=this,n=ro(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:i.dimension}),s=po(n,{computation:i,manipulatorMeasureType:e,view:t});return this._computationHandles.add(s,i),n}_updateManipulators(i,e,t={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=t,{start:a,end:l,offset:o,heading:d,rotation:c}=e,u=s===i,m=Pt(i),{dimension:_}=i;for(const w of e.values()){const L=m&&g(n)&&(g(r)||w===r);w===o?(w.available=L,w.selected=u):w.available=L&&u}if(!m)return;f(this._computeConstraint(i))?e.forEachMeasureTypeManipulator(w=>w.available=!1):e.manipulatorForMeasureType(_.measureType).available=!1;for(const w of[d,c])_.measureType===R.Direct&&_.offset!==0||(w.available=!1);Fi(i)?c.available=!1:d.available=!1;const{geometry:S}=i;a.renderLocation=S.directSegment.startRenderSpace,l.renderLocation=S.directSegment.endRenderSpace;const{renderCoordsHelper:P}=this.view;mo(o,S,P),d.available&&fo(d,i,P),c.available&&go(c,i,P),e.forEachMeasureTypeManipulator((w,L)=>{w.available&&vo(w,i,L,P)})}_updateManipulatorStyle(i){const e=xo(i),t=ji(i),n={lineSizePt:i,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=t/2,vn(r,n),vn(a,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:t})}_applyPointUpdate(i,e){const{view:t}=this,n=Bt(i);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=Zt(n,t.renderCoordsHelper);if(g(s))return;const r=this._computeConstraint({...n,geometry:s});vs(i,e,{...n,constraint:r,unconstrainedGeometry:s,view:t}),i===this._stagedComputation&&this._updateStagedDimensionOffset(i)}_updateStagedDimensionOffset(i){if(g(i.geometry))return;i.geometry.directSegment.eval(.5,Ln);const e=this.view.state.camera.computeRenderPixelSizeAt(Ln);i.dimension.offset=D.initialOffsetPx*e}_computeConstraint(i){return $o(Mo(i,this._snappingManager.options),this.view)}get testInfo(){const i=e=>this.analysisViewData.computations.find(t=>t.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=x.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:t}of e.renderObjects)t.material.setParameters({renderOccluded:x.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(i(e)),getComputationForDimension:e=>i(e),getConstraintForDimension:e=>{const t=i(e);return f(t)?this._computeConstraint(t):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function fi(){const{color:i,opacity:e}=D.offsetManipulator;return new me({color:[...M.toUnitRGB(i),e],width:1,renderOccluded:x.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}h([p({constructOnly:!0})],N.prototype,"analysis",void 0),h([p({constructOnly:!0})],N.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],N.prototype,"manipulators",void 0),h([p({constructOnly:!0})],N.prototype,"parentTool",void 0),h([p({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),h([p({readOnly:!0})],N.prototype,"updating",null),h([p()],N.prototype,"firstGrabbedManipulator",null),h([p()],N.prototype,"hasGrabbedManipulators",null),h([p()],N.prototype,"snappingOptions",null),h([p()],N.prototype,"_stagedDimension",void 0),h([p()],N.prototype,"_activeComputation",null),h([p()],N.prototype,"_stagedComputation",null),N=h([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],N);const Ln=y();var Ze;(function(i){i.Ready="ready",i.Creating="creating",i.Created="created"})(Ze||(Ze={}));let Z=class extends fa{constructor(i){super(i),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=D.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=qr(this.view.state.viewingMode),this._intersector.options.store=Ur.MIN,this._lengthDimensionSubTool=new N({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([qe(this._lengthDimensionSubTool),Wt(()=>this._clearPointerMoveTimeout()),E(()=>this.state,i=>{i===Ze.Created&&this.finishToolCreation()},k),Vi(()=>this.firstGrabbedManipulator,i=>{this.selectedDimension=i.metadata},k),E(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),k)])}get state(){return this.analysis.dimensions.some(i=>i.type==="length")?f(this._activeSubTool)?Ze.Creating:Ze.Created:Ze.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(i){this.analysisViewData.selectedDimension=i}onInputEvent(i){switch(i.type){case"immediate-click":this._clickHandler(i);break;case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":if($n.cancel===i.key){if(f(this._activeSubTool)&&this._activeSubTool.removeStaged())return void i.stopPropagation();this.active||(this.selectedDimension=null)}else $n.delete.includes(i.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){f(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(i){if(this.hasFocusedManipulators)return void i.stopPropagation();if(g(this._activeSubTool))return;const e=this._intersectScreen(i);g(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:i.pointerType}),i.stopPropagation())}_doubleClickHandler(i){this.active&&(this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(i);g(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:i.pointerType})}_deleteKeyHandler(){f(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(i){const e=Wr(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const t=this._intersector.results.min,n=$.get();return t.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){f(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=zi(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(i=>{i.manipulator.state|=fe}),this._prevPointerMoveTimeout=Br.setTimeout(()=>{this.manipulators.forEach(i=>{i.manipulator.state&=~fe})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:i=>{this._pointerMoveTimerMs=i,this._resetPointerMoveTimeout()}}}};h([p({constructOnly:!0})],Z.prototype,"view",void 0),h([p({constructOnly:!0})],Z.prototype,"analysis",void 0),h([p({readOnly:!0})],Z.prototype,"state",null),h([p({readOnly:!0})],Z.prototype,"updating",null),h([p({readOnly:!0})],Z.prototype,"cursor",null),h([p({constructOnly:!0})],Z.prototype,"analysisViewData",void 0),h([p()],Z.prototype,"selectedDimension",null),h([p()],Z.prototype,"automaticManipulatorSelection",void 0),h([p()],Z.prototype,"_activeSubTool",void 0),h([p()],Z.prototype,"_lengthDimensionSubTool",void 0),Z=h([F("esri.views.3d.analysis.Dimension.DimensionTool")],Z);let Il=class extends Jn{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=x.OccludeAndTransparent,this._width=1,this._color=jt(1,0,1,1),this._placement="end",this._textureId=null,this._material=t,this._hasExternalMaterial=f(t),this.applyProps(e)}setGeometryFromSegment(e,t){const n=e.endRenderSpace;this.transform=Zr(Gl,n),this._normal=t;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return f(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,f(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return f(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,f(this._material)&&this._material.setParameters({width:e})}get color(){return f(this._material)?this._material.parameters.color:this._color}set color(e){this._color=Fn(e),f(this._material)&&this._material.setParameters({color:this._color})}get placement(){return f(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,f(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return f(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,f(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new Xn({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of Yr(this.geometry,this.normal)){const n=Xr(Q(this._material),t);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(Q(this._material))}};const Gl=Ai();class Fl{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new ei,this._messages=null,this._labelSegment=new Ve;const{analysis:t,computation:n,view:s,messages:r}=e;this.analysis=t,this.computation=n,this.view=s,this._messages=r;const a=e.visible,l={view:s,attached:a},{fontSize:o,textColor:d,textBackgroundColor:c}=t.style;this._visualElements=new Ul({marker:new Il(l,e.markerMaterial),dimension:new $e(l,e.dimensionLineMaterial),startOffset:new $e(l,e.offsetLineMaterial),endOffset:new $e(l,e.offsetLineMaterial),dimensionSmall:new $e(l,e.smallDimensionLineMaterial),startOffsetSmall:new $e(l,e.smallOffsetLineMaterial),endOffsetSmall:new $e(l,e.smallOffsetLineMaterial),label:new da({view:s,attached:a,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:ce(o),textColor:d.clone(),backgroundColor:c.clone()})}),this._handles.add([E(()=>n.geometry,u=>{this.updateCameraDependentElements(s.state.camera,u,t.style),f(n.geometry)&&this._updateLines(n.geometry)},{...Ut,equals:Ei}),E(()=>n.length,u=>this._updateLabelContent(u),Ut)])}destroy(){this.destroyed=!0,this._handles=_t(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=_n(kl,wt.Start,e.directSegment,e.dimensionSegment),n=_n(jl,wt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,t,n){const s=this._visualElements;if(g(t)){for(const P of s.values())P.visible=!1;return}const r=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,ql)),a=Ua(t,r),l=a<(ce(n.lineSize)*D.smallScreenLengthLineSizeFactor)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const d=ce(n.fontSize)*D.labels.minScreenLengthFontSizeFactor,{label:c}=s;if(c.visible=a>=d**2,!c.visible)return;const{dimensionSegment:u,primaryOffsetAxis:m}=t,{offset:_}=this.computation.dimension,S=(Math.sign(_)>=0?1:-1)*Nl(n)*r;Ia(this._labelSegment,u,m,S),c.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=ce(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;g(e)||g(this._messages)?t.text="":t.text=ca(this._messages,e,e.unit)}}function Nl(i){return 1.5*ce(i.fontSize)+D.labels.marginPx+ce(i.lineSize/2)}const kl=new Ve,jl=new Ve,ql=y();class Ul{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Wl=class{constructor(e,t){this._textures=e,this._textureRepository=t,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const t=Jr(this._textures,e),n=new Aa(this._textureRepository,t.texture.id);return this._texturesByPrimitive.set(e,{result:t,reference:n}),t.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:t})=>{t.dispose(),e.release()}),this._texturesByPrimitive.clear()}},ve=class extends _e{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(i){super(i),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new Xn({width:1,anchor:Kr.Tip,color:dt,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:x.OccludeAndTransparent}),this._dimensionLineMaterial=new me({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new me({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new me({width:1,color:dt,renderOccluded:x.OccludeAndTransparent}),this._smallOffsetLineMaterial=new me({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5),stippleScaleWithLineWidth:!0})}initialize(){var t;const i=(t=this.view.sharedSymbolResources)==null?void 0:t.textures;if(f(i)){const{textureRepository:n}=this.view._stage.renderView,s=new Wl(i,n),r=s.acquire("triangle");this.addHandles(Wt(()=>s.destroy())),this._markerMaterial.setParameters({textureId:r.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(Wt(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:e}=this.analysisViewData;for(const n of e)this._addComputation(n);this.addHandles([e.on("change",({added:n,removed:s})=>{for(const r of s)this._removeComputation(r);for(const r of n)this._addComputation(r)}),E(()=>M.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},k),E(()=>this.analysis.style.lineSize,n=>{const s=ce(n);this._markerMaterial.setParameters({width:s*D.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const r=Math.max(s*D.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:r})},k),E(()=>({camera:this.view.state.camera,style:Bl(this.analysis)}),({camera:n,style:s})=>{for(const[r,a]of this._dimensionVisualizations)a.updateCameraDependentElements(n,r.geometry,s),a.updateLabelStyle(s)}),E(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([Qr(()=>this._updateMessageBundle()),Vi(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},nt)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(i=>{i.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const i of this._lineMaterials())i.setParameters({renderOccluded:x.Occlude})}}}_addComputation(i){this._dimensionVisualizations.has(i)||this._dimensionVisualizations.set(i,new Fl({analysis:this.analysis,computation:i,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(i){const e=this._dimensionVisualizations.get(i);g(e)||(e.destroy(),this._dimensionVisualizations.delete(i))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await ea("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Bl(i){const{fontSize:e,lineSize:t,textColor:n,textBackgroundColor:s}=i.style;return{fontSize:e,lineSize:t,textBackgroundColor:s.clone(),textColor:n.clone()}}h([p({constructOnly:!0})],ve.prototype,"analysisViewData",void 0),h([p({constructOnly:!0,nonNullable:!0})],ve.prototype,"view",void 0),h([p()],ve.prototype,"analysis",null),h([p()],ve.prototype,"visible",null),h([p()],ve.prototype,"loadingMessages",void 0),ve=h([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],ve);let ut=class extends _e{constructor(i){super(i),this.dimension=null,this.length=null}};h([p({constructOnly:!0,nonNullable:!0})],ut.prototype,"dimension",void 0),h([p()],ut.prototype,"length",void 0),ut=h([F("esri.views.3d.analysis.LengthDimensionResult")],ut);const Zl=ut;let Y=class extends _e{constructor(i){super(i),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(i){const{dimension:e,...t}=i;return{result:new Zl({dimension:e}),...t}}initialize(){this.addHandles([E(()=>this.dimension.startPoint,i=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(i),k),E(()=>this.dimension.endPoint,i=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(i),k)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};h([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"result",void 0),h([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"projectAndAlignPoint",void 0),h([p()],Y.prototype,"dimension",null),h([p()],Y.prototype,"length",null),h([p()],Y.prototype,"geometry",void 0),h([p()],Y.prototype,"unconstrainedGeometry",void 0),h([p()],Y.prototype,"elevationAlignedStartPoint",void 0),h([p()],Y.prototype,"elevationAlignedEndPoint",void 0),h([p()],Y.prototype,"preConstraintProperties",void 0),h([p()],Y.prototype,"previousConstraint",void 0),Y=h([F("esri.views.3d.analysis.LengthDimensionComputation")],Y);const Yl=i=>{let e=class extends i{constructor(...t){super(...t),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new at}createLengthDimensions(t){throw new Error("Method not implemented.")}};return h([p({constructOnly:!0})],e.prototype,"view",void 0),h([p({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),h([p()],e.prototype,"tool",void 0),h([p({readOnly:!0})],e.prototype,"results",null),h([p()],e.prototype,"selectedDimension",void 0),h([p()],e.prototype,"interactive",void 0),h([p()],e.prototype,"visible",void 0),e=h([F("esri.views.analysis.DimensionAnalysisView")],e),e};let U=class extends Yl(ta(_e)){constructor(i){super(i),this.type="dimension-view-3d",this.tool=null,this.computations=new at,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=i=>{if(g(i))return null;const{spatialReference:e,elevationProvider:t}=this.view,n=ia(i,e,t);return g(n)&&na(this.analysis,i.spatialReference,Hn.getLogger(this.declaredClass)),n},this.addHandles([ga(this,Z),un(()=>this.analysis.dimensions,"after-add",i=>this._onDimensionAdd(i.item),{onListenerAdd:i=>{for(const e of i)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),un(()=>this.analysis.dimensions,"after-remove",i=>this._onDimensionRemove(i.item))]),this._analysisVisualization=new ve({analysisViewData:this,view:this.view}),this._analysisController=new Ce({analysisViewData:this,view:this.view})}destroy(){this._placementTask=St(this._placementTask),this._analysisVisualization=_t(this._analysisVisualization),_a(this)}get updating(){var i;return((i=this._analysisVisualization)==null?void 0:i.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(i=>this._dimensionsToComputations.get(i).result)}get selectedComputation(){const{selectedDimension:i}=this;return g(i)?null:this._dimensionsToComputations.get(i)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(i){return this.selectedDimension=null,this._placementTask=St(this._placementTask),this._placementTask=ya(this,i),this._placementTask.promise}_onDimensionAdd(i){const{computations:e,_dimensionsToComputations:t}=this;if(t.has(i))return;const n=new Y({dimension:i,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),t.set(i,n)}_onDimensionRemove(i){const{computations:e,_dimensionsToComputations:t}=this,n=e.findIndex(r=>r.dimension===i),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),t.delete(i),_t(s)}_onDimensionsClear(){this.computations.drain(i=>i.destroy()),this._dimensionsToComputations.clear()}};h([p({readOnly:!0})],U.prototype,"type",void 0),h([p()],U.prototype,"tool",void 0),h([p()],U.prototype,"updating",null),h([p({readOnly:!0})],U.prototype,"results",null),h([p({readOnly:!0})],U.prototype,"computations",void 0),h([p()],U.prototype,"selectedDimension",void 0),h([p()],U.prototype,"selectedComputation",null),h([p()],U.prototype,"_analysisVisualization",void 0),h([p()],U.prototype,"_analysisController",void 0),h([p()],U.prototype,"_dimensionsToComputations",void 0),h([p()],U.prototype,"_placementTask",void 0),U=h([F("esri.views.3d.analysis.DimensionAnalysisView3D")],U);const Xl=U,gc=Object.freeze(Object.defineProperty({__proto__:null,default:Xl},Symbol.toStringTag,{value:"Module"}));export{gc as D,nl as Z,Ho as a,$d as b,qi as d,Cd as f,Md as l,Xi as n,hl as r,cl as s};
