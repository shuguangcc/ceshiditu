import{e as h,y as d,n as z,m as Ue,c as Ct,B as Z,X as At,_ as Ea,t as ee,A as to}from"./cast-7928d7aa.js";import{r as p,t as _,o as li,e as O,s as R,h as $t,v as eo,i as et,n as io}from"./typedArrayUtil-a8b5b3e9.js";import{l as A,a as ao,h as ft,f as Kt,w as vi,U as De}from"./reactiveUtils-f41a4e00.js";import"./ensureType-cf29afa9.js";import{G as oo,o as at,u as yt,g as bt,U as so,e as P,z as Re,P as $e,_ as Gt,H as Oa,v as no,s as Qt,A as Pt,p as ro,T as Ri,q as Vt,r as ti}from"./vec3-a020a6f6.js";import{n as V,r as U,t as Ta,f as $i}from"./vec3f64-2f9cef06.js";import{i as Aa,s as lo,u as Ii,f as C,d as po,g as ho}from"./elevationInfoUtils-427916a5.js";import{x as Ga}from"./ElevationInfo-ce9cacc2.js";import{i as Xe,x as Pi,d as co}from"./screenUtils-410d12c0.js";import"./Error-653283ae.js";import{h as uo}from"./string-cdf077e6.js";import{j as go}from"./asyncUtils-62e8a185.js";import{f as mo}from"./promiseUtils-6684e352.js";import{x as _o,d as Ie,b as de,a as ue,e as ei,p as Li}from"./quantityFormatUtils-ba1f6cd1.js";import{d as vo,$ as pi,Z as fo}from"./unitUtils-47abac71.js";import{b as yo,r as X,v as hi,l as ci,A as Mo,s as Ae,w as Vi,j as Ci,f as bo,M as So,o as Da}from"./vec2-2cef68de.js";import{n as he}from"./vec2f64-30dc1443.js";import{b as xo,m as wo}from"./Polyline-bf268e7b.js";import{u as Eo}from"./messages-be07754e.js";import{x as Oo}from"./TextOverlayItem-a6091360.js";import{d as To,a as Mt,b as ve,e as Ze,m as Ao,l as Go,g as Se}from"./automaticLengthMeasurementUtils-24c52b73.js";import{ca as Do,g as Ro,ad as zi,aW as ki,cb as $o,af as Io,aY as Hi,cc as Po,ar as Ye,cd as Nt,c1 as Lo,ce as Vo,cf as Co,at as fi,cg as zo,ch as ko,bg as ot,ci as ce,cj as Ho,ck as ie,bW as Pe,cl as Ra,bf as w,by as yi,bi as $a,cm as No,cn as Uo,bX as Xo,co as jt,bu as Fe,c7 as Dt,bo as Le,cp as Zo,cq as Ia,cr as Yo,cs as Fo,bq as Ve,aQ as Be,ct as Ni,cu as Bo,cv as _t,cw as Ui,bA as xe,bQ as Xi,bd as mt,c6 as Pa,cx as jo,cy as qo,bY as Wo,cz as Jo,cA as Ko,cB as Qo,cC as ts,bS as qt,c0 as es,bT as ne,cD as Zi,bx as is}from"./index-455b69b8.js";import{a as ge,_ as Yi,y as v,G as Mi,r as bi}from"./VerticesVisualElement-dd38c964.js";import{n as St}from"./Evented-515b9d9c.js";import{D as ii,a as Fi,r as as}from"./vec4-790471c0.js";import{r as Bi,j as os}from"./EffectView-d3bf37ed.js";import{x as ss,j as ji,g as ns}from"./projection-d7b57a6c.js";import{a as La,A as Va,M as qi,Z as rs}from"./aaBoundingBox-fc742a4e.js";import{v as fe}from"./dehydratedFeatures-4eeb381a.js";import{s as ls}from"./Identifiable-aa6d459d.js";import{i as ps,n as Si}from"./basicInterfaces-19ed850e.js";import{u as hs,d as Ce,S as cs}from"./PointVisualElement-685382db.js";import{v as ds}from"./objectResourceUtils-ef6e3cdf.js";import{c as st}from"./VisualVariablePassParameters-5807c7dc.js";import{O as ai}from"./VertexAttribute-9c5c630d.js";import{Z as us,q as gs}from"./DrawGraphicTool-5e0248da.js";import{j as ms}from"./Collection-78126e82.js";import{a as Ca,d as xi}from"./HandleOwner-e1406413.js";import{i as J,A as vt,N as di,I as re,C as za,z as ka,R as _s}from"./manipulatorUtils-302eea16.js";import{t as zt}from"./manipulatorUtils-0cd1c493.js";import{m as je,a as ui,b as me}from"./mathUtils-2519596a.js";import{w as Ha}from"./aaBoundingRect-4a760199.js";import{l as Na}from"./Color-a42a8267.js";import{x as Wi,R as vs,u as Ge,g as Ua,q as ze,c as fs,b as ys,i as Xa,f as Ji,m as Ms}from"./mat4-44a0988f.js";import{e as qe,t as bs,o as Ss}from"./mat4f64-1e28eae0.js";import{c as x,e as q,p as Ki,b as Qi,t as Bt,d as xs}from"./sphere-4f5e644f.js";import{N as wi,G as Za,h as ws,T as Es,F as Os,P as Ts,C as gi,o as As}from"./Factory-d9ba6160.js";import{q as Gs}from"./colorUtils-82440b70.js";import{C as Ds}from"./GraphicManipulator-7826bc29.js";import{r as _e,p as We,a as Ei,l as Rs,c as $s,n as Is}from"./TranslateTooltipInfos-4fb7abcc.js";import{v as ke,x as Ps,D as Ls}from"./euclideanLengthMeasurementUtils-3ebdcf15.js";import{Y as ye,_ as Ya,p as Oi,H as Vs,q as ta}from"./plane-45609588.js";import{d as ea}from"./utils-725f8b4e.js";import{i as Cs}from"./automaticAreaMeasurementUtils-d516ac98.js";import{w as zs}from"./Extent-69509002.js";import{l as mi}from"./ViewingMode-5d7d590b.js";import{r as ks}from"./Cyclical-b66238c6.js";import{e as Hs}from"./vec4f64-e407da96.js";import{g as Ns,l as Us}from"./projection-aa2a8986.js";import{s as Fa,o as Xs,_ as Zs,A as Ys,u as Fs,j as Bs,L as js,r as ia,q as qs,R as Ws,B as Js,K as Ks,J as Qs}from"./sliceToolUtils-d711e2da.js";import{i as tn,p as en}from"./ExtentTooltipInfos-4b5e4bb7.js";import"./nextTick-3ee5a785.js";import"./common-c186b691.js";import"./jsonMap-c1f958cf.js";import"./fieldUtils-31bfecd2.js";import"./preload-helper-41c905a7.js";import"./arcadeOnDemand-c6d1b9f2.js";import"./geometry-5a216427.js";import"./typeUtils-eb9416d0.js";import"./lengthUtils-d2d33f94.js";import"./Ellipsoid-89682c5e.js";import"./locale-30120714.js";import"./widget-f7489a3f.js";import"./intl-f1e98361.js";import"./number-347a3a44.js";import"./request-d3e98716.js";import"./assets-0b172f07.js";import"./Promise-dfdee8ba.js";import"./uuid-73213768.js";import"./dom-5b7af1bf.js";import"./geometryEngine-62e3ccf4.js";import"./geometryEngineBase-3dd302e0.js";import"./hydrated-be86c8b3.js";import"./Basemap-a8f7f439.js";import"./collectionUtils-3831b7c4.js";import"./deprecate-b9088bd3.js";import"./Loadable-48bc1293.js";import"./loadAll-7fd968fe.js";import"./Portal-8b65c9c4.js";import"./PortalGroup-bfe93c76.js";import"./PortalUser-4c8e1adc.js";import"./PortalItem-aa42c739.js";import"./writeUtils-067c4f82.js";import"./layerUtils-034678f6.js";import"./compilerUtils-034cacb8.js";import"./enumeration-3c281341.js";import"./opacityUtils-243aae26.js";import"./CollectionFlattener-3dd1f479.js";import"./TablesMixin-e7a6aab1.js";import"./Layer-f0696768.js";import"./Graphic-b46e2684.js";import"./PopupTemplate-6eb885db.js";import"./Clonable-ba795b08.js";import"./symbols-fa594797.js";import"./CIMSymbol-1379245a.js";import"./Symbol-fc4312a4.js";import"./symbolLayerUtils3D-1f8d4478.js";import"./persistableUrlUtils-a16d0f55.js";import"./Symbol3DAnchorPosition2D-c0f4a14d.js";import"./jsonUtils-03c4af61.js";import"./workers-898a7c4c.js";import"./Connection-a681777e.js";import"./Queue-3a0c055d.js";import"./TileInfo-34f80a8e.js";import"./byteSizeEstimations-f0cab514.js";import"./executeQueryJSON-bcd96e1a.js";import"./normalizeUtils-ee4bf39f.js";import"./query-922e6fbf.js";import"./pbfQueryUtils-72f9b45b.js";import"./pbf-e1a6c35b.js";import"./OptimizedFeature-3de538c1.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-d9d8ef40.js";import"./zscale-1e1fc911.js";import"./FeatureSet-0573546e.js";import"./Field-f5fc9f6b.js";import"./fieldType-b1002185.js";import"./SimpleObservable-7dcdef1d.js";import"./colorUtils-639f4d25.js";import"./Query-ff8c2cfb.js";import"./TimeExtent-744afd75.js";import"./RelationshipQuery-db5fcd0c.js";import"./LegendOptions-e65e7a9c.js";import"./jsonUtils-c56f8821.js";import"./UniqueValueRenderer-103ec66d.js";import"./diffUtils-1ac65748.js";import"./colorRamps-3a8ac20b.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-c59ab38d.js";import"./jsonUtils-d7db3dc7.js";import"./styleUtils-4adfed9e.js";import"./DictionaryLoader-2cf5144e.js";import"./LRUCache-14115d91.js";import"./MemCache-4b976a8b.js";import"./heatmapUtils-84e8c43b.js";import"./featureConversionUtils-01cdde8a.js";import"./TopFeaturesQuery-785f5453.js";import"./FeatureLayer-a9f3e6ec.js";import"./MultiOriginJSONSupport-27362d57.js";import"./LayerFloorInfo-2cd5e8ae.js";import"./FeatureLayerBase-aebdf2da.js";import"./HeightModelInfo-22ad72d7.js";import"./arcgisLayerUrl-0b2b7691.js";import"./OperationalLayer-24e6fa34.js";import"./editsZScale-2015e7db.js";import"./APIKeyMixin-34d76a46.js";import"./ArcGISService-ea748edf.js";import"./BlendLayer-d8293c8d.js";import"./parser-2b40deea.js";import"./mat4f32-77b3d8ac.js";import"./CustomParametersMixin-807d2055.js";import"./EditBusLayer-40671d1a.js";import"./FeatureReductionLayer-4077b2ae.js";import"./labelingInfo-5c3a46f6.js";import"./labelUtils-a194a22a.js";import"./defaultsJSON-59981e75.js";import"./OrderedLayer-e7edf19c.js";import"./PortalLayer-f1a64f99.js";import"./RefreshableLayer-1c078c47.js";import"./ScaleRangeLayer-271178b7.js";import"./TemporalLayer-39c07299.js";import"./TimeInfo-c89d0ef4.js";import"./FeatureTemplate-746d033e.js";import"./FeatureType-c83c5f49.js";import"./fieldProperties-7547b373.js";import"./FieldsIndex-aa6dd3fa.js";import"./versionUtils-92993d41.js";import"./styleUtils-da81b13f.js";import"./popupUtils-07fe66a7.js";import"./mat2d-d0b91e3e.js";import"./Scheduler-8433672d.js";import"./GraphicsLayer-10573c27.js";import"./enums-0fc02184.js";import"./mat3-3fc68e72.js";import"./mat3f32-d3d088e8.js";import"./vec2f32-461e65a9.js";import"./TileStrategy-4189758f.js";import"./TileStore-787dbea4.js";import"./TileKey-0750ad58.js";import"./rbush-8e36784a.js";import"./quickselect-322ec8e1.js";import"./capabilities-3636c6a4.js";import"./context-util-1e3c8cfc.js";import"./lineSegment-e6f72ff2.js";import"./scaleUtils-b32a50d8.js";import"./ElevationSamplerData-7decf898.js";import"./PhysicallyBasedRendering.glsl-a986c926.js";import"./View.glsl-8b12b8c2.js";import"./ShaderBuilder-93e8045e.js";import"./FloatPassUniform-d2dfc562.js";import"./Float4PassUniform-3a47b7b3.js";import"./RgbaFloatEncoding.glsl-6036ca34.js";import"./Texture2DPassUniform-6e8ae673.js";import"./vec3f32-c9aa289f.js";import"./Texture2DDrawUniform-22924c6f.js";import"./PiUtils.glsl-0c0898f0.js";import"./ReadLinearDepth.glsl-7ff30f7d.js";import"./WaterSurface.glsl-fc8a5726.js";import"./ForwardLinearDepth.glsl-36f9eb3b.js";import"./Matrix3PassUniform-da8eddae.js";import"./mat3f64-c6305894.js";import"./Slice.glsl-a612de15.js";import"./Transform.glsl-f15542a7.js";import"./OutputHighlight.glsl-7364b03b.js";import"./MultipassTerrainTest.glsl-e79d40de.js";import"./NormalUtils.glsl-a59958d7.js";import"./AlphaCutoff-96178e0d.js";import"./TransparencyPassType-cd195b0e.js";import"./EvaluateSceneLighting.glsl-3bbc6edf.js";import"./enums-64ab819c.js";import"./Texture-e79b14e7.js";import"./SSAOBlur.glsl-c6f142fc.js";import"./ScreenSpacePass-00f8c8a4.js";import"./SSAO.glsl-6f3b4065.js";import"./FramebufferObject-50e1b68f.js";import"./ShaderTechniqueConfiguration-9f5b4555.js";import"./HUD.glsl-80cf9a21.js";import"./VerticalOffset.glsl-86460edb.js";import"./DefaultTechniqueConfiguration-e8962072.js";import"./edgeProcessing-3ca548e1.js";import"./deduplicate-b0bc48cc.js";import"./InterleavedLayout-5e9cf734.js";import"./BufferView-646ba1de.js";import"./types-e1c0a5bf.js";import"./VertexElementDescriptor-2925c6af.js";import"./DefaultMaterial_COLOR_GAMMA-9831d979.js";import"./vec33-ce3aa99b.js";import"./Version-9baeb7ac.js";import"./quat-5b263584.js";import"./quatf64-7fd38d64.js";import"./Util-a48361c6.js";import"./Octree-1a841545.js";import"./HUDMaterial.glsl-4bf3c7df.js";import"./sdfPrimitives-a24e9cb2.js";import"./floatRGBA-fa8308d2.js";import"./Texture-bbae5d9d.js";import"./TextureOnly.glsl-18701a3b.js";import"./ObjectAndLayerIdColor.glsl-73c19386.js";import"./VisualVariables.glsl-b8290512.js";import"./labelFormatUtils-4d730eaa.js";import"./I3SUtil-3ffd3baa.js";import"./I3SBinaryReader-3d2c2faa.js";import"./symbolColorUtils-604c5345.js";import"./LineCallout.glsl-a0056465.js";import"./earcut-58237617.js";import"./QueryEngineResult-665bf7fb.js";import"./quantizationUtils-33aba427.js";import"./ItemCache-ee28c7ba.js";import"./WhereClause-2b5b05b2.js";import"./utils-30a9a7e0.js";import"./generateRendererUtils-a996108f.js";import"./utils-1f4fcfec.js";import"./json-48e3ea08.js";import"./MeshComponent-f50df6af.js";import"./MarkerSizing.glsl-c6fa192a.js";import"./RibbonLine.glsl-2a3b4d4e.js";import"./OutputDepth.glsl-179f1d8f.js";import"./LineStipple.glsl-de782d6a.js";import"./MixExternalColor.glsl-25f0049c.js";import"./DiscardOrAdjustAlphaBlend.glsl-5f837994.js";import"./callExpressionWithFeature-a7532499.js";import"./LineMarker.glsl-8f444621.js";import"./NativeLine.glsl-cdbbf172.js";import"./VertexColor.glsl-db21b96c.js";import"./Normals.glsl-90e28525.js";import"./Path.glsl-60b36878.js";import"./ColorMaterial.glsl-8310ffb3.js";import"./Pattern.glsl-d3388745.js";import"./LercDecoder-73115fd2.js";import"./config-1337d16e.js";import"./DefaultMaterial.glsl-b4f4cbc5.js";import"./workerHelper-c6d4a8cb.js";import"./Subtype-5b01b21f.js";import"./datetime-4f774298.js";import"./ExportImageParameters-f328a234.js";import"./sublayerUtils-ba7f61bc.js";import"./cimSymbolUtils-2e4dde89.js";import"./utils-c81a5c52.js";import"./webStyleSymbolUtils-55ed91cd.js";import"./devEnvironmentUtils-5002a058.js";import"./enums-4b2a86a0.js";import"./RealisticTree.glsl-2b30ed32.js";import"./LineVisualElement-69b2e868.js";import"./RightAngleQuadVisualElement-d5a5e64b.js";import"./ImageMaterial-0dc3e395.js";import"./ImageMaterial.glsl-2969e37d.js";import"./ShadedColorMaterial.glsl-7dee9441.js";import"./measurementUtils-c86e49dc.js";import"./euclideanAreaMeasurementUtils-0db711c3.js";import"./persistable-19c823da.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";const an=3025,on={default:15,far:25};let rt=class extends Ue{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=go(async a=>{const o=await Eo("esri/core/t9n/Units");mo(a),this._messagesUnits=o}),i=()=>li(this.context,a=>a.editGeometryOperations);this.addHandles([A(()=>[p(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(a=>ao(i,a,()=>this._update())),Ct(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return _(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return on[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(_(t))return void this._destroyUnusedLabels();const{components:i,geometry:a,coordinateHelper:o}=t.editGeometryOperations.data;if(!a)return void this._destroyUnusedLabels();const s=i.length;for(let n=0;n<s;++n){const r=[];if(i[n].iterateVertices(f=>{r.push(o.toXYZ(f.pos))}),n===0&&p(this.stagedVertex)&&r.push(o.toXYZ(this.stagedVertex)),r.length<2)continue;const l=r[0],c=r[r.length-1];a.type==="polygon"&&r.length>2&&!oo(l,c)&&r.push(l);const g=s===1&&!xo(r,!1,!1);let u=sn,m=nn;this.toScreenPointArray(t,l,u);for(let f=1;f<r.length;++f){const y=r[f-1],S=r[f];this.toScreenPointArray(t,S,m),this._addLabel(t,y,u,S,m,g),[u,m]=[m,u]}}this._destroyUnusedLabels()}_addLabel(t,i,a,o,s,n){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||yo(a,s)<an)return void(r.visible=!1);const l=p(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":Aa(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:c}=t.editGeometryOperations.data,g=To(i,o,c,l),u=this._messagesUnits,m=vo(t.view);r.text=p(u)&&p(g)?_o(u,g,m):"",r.visible=!0;const f=s[0]-a[0],y=s[1]-a[1];n?X(K,-y,f):X(K,y,-f),hi(K,K),ci(K,K,this._edgeDistancePixels),Mo(le,a,s,.5),Ae(le,le,K),r.position=[le[0],le[1]],Math.abs(K[0])>Math.abs(K[1])?r.anchor=K[0]>0?"left":"right":r.anchor=-K[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const i=new Oo({fontSize:10,anchor:"center"});t.view.overlay.items.add(i);const a={label:i};return this._labelInfos.push(a),this._nextLabelIndex=this._labelInfos.length,a}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){li(this.context,i=>i.view.overlay.items.remove(t)),t.destroy()}};h([d()],rt.prototype,"context",void 0),h([d()],rt.prototype,"stagedVertex",void 0),h([d()],rt.prototype,"visible",void 0),h([d()],rt.prototype,"edgeDistance",void 0),h([d()],rt.prototype,"updating",null),h([d()],rt.prototype,"_messagesUnits",void 0),h([d()],rt.prototype,"_edgeDistancePixels",null),rt=h([z("esri.views.interactive")],rt);const K=he(),le=he(),sn=Xe(),nn=Xe();let He=class extends rt{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:i,editGeometryOperations:a},o,s=Xe()){const{spatialReference:n}=a.data.coordinateHelper;return Do(o,n,i,t,aa),t.state.camera.projectToScreen(aa,s),s}};He=h([z("esri.views.3d.interactive.SegmentLabels3D")],He);const aa=V();let rn=class{constructor(t){this._resourceFactory=t,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return p(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(t){t!==this._attached&&(this._attached=t,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?_(this._resources)||(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?_(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var o;this._destroyResources();const t=this._resourceFactory.createResources(),i=new Wt({view:this._resourceFactory.view}),a=(o=this._resourceFactory.view.basemapTerrain)==null?void 0:o.overlayManager;this._resources={layerView:new Wt({view:this._resourceFactory.view}),external:t,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){var i;if(_(this._resources))return;this._ensureRenderGeometriesRemoved();const t=(i=this._resourceFactory.view.basemapTerrain)==null?void 0:i.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){_(this._resources)||_(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,zi.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){_(this._resources)||_(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,zi.UPDATE),this._resources.geometriesAdded=!0)}},Wt=class extends ls(Ue){constructor(t){super(t),this.drapeSourceType=Ro.Features,this.updatePolicy=ps.SYNC}};h([d({constructOnly:!0})],Wt.prototype,"view",void 0),h([d({readOnly:!0})],Wt.prototype,"drapeSourceType",void 0),Wt=h([z("DrapedVisualElementLayerView")],Wt);let Ht=class{constructor(t){this.view=null,this._attachmentOrigin=fe(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new St,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Bi(1,0,1,1),this._innerWidth=0,this._innerColor=Bi(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=st.OccludeAndTransparentStencil,this._resources=new hs({view:t.view,createResources:a=>this._createResources(a),recreateGeometry:(a,o)=>(a.geometries.length=0,this._recreateGeometry(o,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=t.view.spatialReference,this._drapedResources=new rn({view:t.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new Ce({view:t.view});for(const a in t)a in this?a==="attached"?i=t[a]:this[a]=t[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this._resources.destroy(),this._drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(t){t!==this._isDraped&&(this._isDraped=t,this._updateAttached(this.attached),this._laserline.attached=this._laserlineAttached)}get _laserlineAttached(){return this.attached&&this.visible&&p(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this._resources.visible}set visible(t){this._resources.visible=t,this._drapedResources.visible=t,this._laserline.attached=this._laserlineAttached}get attached(){return this._resources.attached||this._drapedResources.attached}set attached(t){this._updateAttached(t)}_updateAttached(t){this._resources.attached=!this.isDraped&&t,this._drapedResources.attached=this.isDraped&&t,this._laserline.attached=this._laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this._resources.recreateGeometry(),this._drapedResources.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){ii(t,this._color)||(Fi(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){ii(t,this._innerColor)||(Fi(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=p(t)!==p(this._stipplePattern);this._stipplePattern=t,i?this._resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&ii(t,this._stippleOffColor)||(this._stippleOffColor=t?os(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this._resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this._laserlineAttached,p(t)&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=p(this._resources.resources)?this._resources.resources.geometries:null;if(!t||t.length===0)return null;at(Ut,0,0,0);let i=0;for(const a of t){const o=a.vertexAttributes.get(ai.POSITION),s=a.indices.get(ai.POSITION),n=O(this._resources.resources).material.isClosed(o.data,s);ds(o,s,n,oa)&&(yt(Ut,Ut,oa),i++)}return i===0?null:(bt(Ut,Ut,1/i),this.view.renderCoordsHelper.fromRenderCoords(Ut,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){p(this._resources.resources)&&this._resources.resources.material.setParameters(this._materialParameters),p(this._drapedResources.resources)&&this._drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return p(this.geometry)&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===st.OccludeAndTransparentStencil?st.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,i,a){const o=this._createRenderGeometries();for(const s of o)t.addGeometry(s,i),a.push(s);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(t){const i=new ki(this._materialParameters),a=[];return this._recreateGeometry(t,i,a),{material:i,geometries:a,forEach:o=>{o(i),a.forEach(o)}}}_createDrapedResources(){const t=new ki(this._materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const i=this.geometry;if(_(i)||_(this.view.basemapTerrain.spatialReference))return[];const a=$o(i,this.view.basemapTerrain.spatialReference),o=[];for(const{position:s}of a.lines){const n={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:s},removeDuplicateStartEnd:this._isClosed},r=new Io(Hi(n),t),l=Va(ln);qi(l,s),as(r.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),o.push(r)}return o}calculateMapBounds(t){if(_(this._resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this._resources.resources.geometries){const o=a.vertexAttributes.get(ai.POSITION),s=new Float64Array(o.data.length);ss(o.data,i.spatialReference,0,s,this.view.spatialReference,0,o.data.length/3),qi(t,s)}return!0}_createRenderGeometries(){const t=this.geometry;if(_(t))return[];const i=Po(t,this.view.elevationProvider,this.view.renderCoordsHelper,Ye.fromElevationInfo(this.elevationInfo??new Ga({mode:Aa(t,null)}))),a=[],o=[];for(const{position:s,mapPosition:n}of i.lines){const r={attributeData:{position:s,mapPosition:n},removeDuplicateStartEnd:this._isClosed};a.push(Hi(r)),o.push(s)}return this._laserline.pathVerticalPlane=o,a}};const ln=La(),oa=V(),Ut=V();let Xt=class extends us{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:i}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Ga({mode:t,offset:i})}normalizeCtorArgs(t){if(!t.elevationInfo){const i=t.hasZ??!0;return{...t,elevationInfo:lo(i)}}return t}initializeGraphic(t){const i=this._createGraphicState=new Nt({graphic:t});return Z([this.view.maskOccludee(t),this.view.trackGraphicState(i),A(()=>({element:this._outlineVisualElement,isDraped:i.isDraped}),({element:a,isDraped:o})=>{li(a,s=>s.isDraped=o)},ft)])}makeDrawOperation(){const{geometryType:t}=this,i=t!=="circle"&&t!=="rectangle";return new Lo({view:this.view,manipulators:this.manipulators,geometryType:gs(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Vo(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Co(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ge,segmentLabels:i?new He:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:p(this._createGraphicState)?this._createGraphicState.isDraped:Ii(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){const{view:i}=this;return p(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),null):(this._activeVertexVisualElement=new Yi({view:i,spatialReference:i.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:v.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=v.colorToVec4(v.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,this._verticalLineVisualElement=new Mi({view:i,extensionType:v.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent}),v.visualElements.zVerticalLine.apply(this._verticalLineVisualElement),Ct(()=>{this._activeVertexVisualElement=R(this._activeVertexVisualElement),this._verticalLineVisualElement=R(this._verticalLineVisualElement)}))}_updateVerticalLineVisualElement(t){const i=this._verticalLineVisualElement;if(_(i))return;const{renderCoordsHelper:a,spatialReference:o,elevationProvider:s}=this.view;at(Zt,t[0],t[1],t[2]),sa.setFromElevationInfo(this.elevationInfo),Zt[2]=fi(Zt,s,sa,a),a.toRenderCoords(Zt,o,Zt)?(i.setStartEndFromWorldDownAtLocation(Zt),i.attached=!0):i.attached=!1}onOutlineChanged(t){if(p(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const i=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ht({view:this.view,geometry:t,elevationInfo:i,isDraped:p(this._createGraphicState)?this._createGraphicState.isDraped:Ii(this.hasZ,i)==="on-the-ground",attached:!1}),v.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),v.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Ct(()=>{this._outlineVisualElement=R(this._outlineVisualElement)})}onRegularVerticesChanged(t){return p(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Yi({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:v.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Ct(()=>{this._verticesVisualElement=R(this._verticesVisualElement)}))}};h([d({constructOnly:!0})],Xt.prototype,"elevationInfo",void 0),h([d({constructOnly:!0})],Xt.prototype,"geometryType",void 0),h([d()],Xt.prototype,"type",void 0),h([d({constructOnly:!0})],Xt.prototype,"view",void 0),Xt=h([z("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Xt);const sa=new Ye,Zt=V();var it;(function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"})(it||(it={}));var T;(function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"})(T||(T={}));let Ba=class{constructor(){this.grabbingState=it.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=it.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((i,a)=>{if(a===T.TRANSLATE_Z&&(this.zManipulator=i),i instanceof J&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),_(this.firstGrabbedXY)&&i.grabbing&&a===T.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=it.ANY,a){case T.TRANSLATE_Z:this.grabbingState|=it.Z;break;case T.TRANSLATE_XY:this.grabbingState|=it.XY}})}};function pn(e){const{view:t,graphic:i}=e,a=new Nt({graphic:i}),o=hn(e,a),s=[o,cn(e,o.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:o.visualElement,remove:()=>Z(s).remove()}}function hn(e,t){const{view:i,graphic:a}=e,o=new Ht({view:i,geometry:_i(a)?a.geometry:null,elevationInfo:C(a),attached:!1});v.visualElements.lineGraphics.shadowStyle.apply(o);const s=()=>{o.attached=t.displaying};v.visualElements.lineGraphics.outline.apply(o);const n=[A(()=>t.displaying,s),A(()=>t.isDraped,r=>{o.isDraped=r}),t.on("changed",()=>o.geometry=_i(a)?a.geometry:null),At(o)];return s(),{visualElement:o,remove:()=>Z(n).remove()}}function cn(e,t,i){const{graphic:a,view:o}=e,s=[],n=C(a),r=n.mode==="on-the-ground"||!n.offset&&n.mode!=="absolute-height",l=new Ba,c=new Mi({view:o,extensionType:v.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent});v.visualElements.pointGraphics.shadowStyle.apply(c);const g=je(v.visualElements.heightPlaneAngleCutoff),u=new Ce({view:o,attached:!1,angleCutoff:g});v.visualElements.heightPlane.apply(u);let m=1,f=1;const y=()=>{if(l.update(e),!i.displaying||r&&(i.isDraped||!_i(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,c.attached=!1,void(u.attached=!1);t.laserlineEnabled=!0;{const M=l.grabbingState&it.XY?v.visualElements.laserlineAlphaMultiplier:1;M!==m&&(m=M,v.visualElements.lineGraphics.shadowStyle.apply(t,M),v.visualElements.pointGraphics.shadowStyle.apply(c,M))}{const M=l.grabbingState&it.Z?v.visualElements.laserlineAlphaMultiplier:1;M!==f&&(f=M,v.visualElements.heightPlane.apply(u,M))}dn(c,l),un(e,t,u,l)};v.visualElements.zVerticalLine.apply(c),s.push(i.on("changed",y),A(()=>i.displaying,y),t.events.on("attachment-origin-changed",y),At(c),At(u));const S=[],G=()=>{Z(S).remove(),S.length=0,e.forEachManipulator(M=>S.push(M.events.on("grab-changed",y))),e.forEachManipulator(M=>S.push(M.events.on("select-changed",y))),y()};return G(),s.push(e.onManipulatorsChanged(G),Ea(()=>Z(S))),Z(s)}function dn(e,t){const i=t.numSelected===1?t.firstSelected:t.numSelected>1&&p(t.firstGrabbedXY)?t.firstGrabbedXY:null;p(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}function un(e,t,i,a){if(a.numSelected>0){at(It,0,0,0);let o=0;e.forEachManipulator((s,n)=>{n===T.TRANSLATE_XY&&s.selected&&s instanceof J&&(yt(It,It,s.renderLocation),o++)}),o>0?(i.heightManifoldTarget=bt(It,It,1/o),i.attached=!0):i.attached=!1}else{const o=t.attachmentOrigin;p(o)&&e.view.renderCoordsHelper.toRenderCoords(o,It)?(i.heightManifoldTarget=It,i.attached=!0):i.attached=!1}}function _i(e){return p(e.geometry)&&(e.geometry.type==="polygon"||e.geometry.type==="polyline")}const It=V();function gn(e){const{view:t,graphic:i}=e,a=new Nt({graphic:i}),o=[],s=_n(e,a,o);return mn(e,a,o,s),o.push(t.trackGraphicState(a)),{visualElement:s,remove(){Z(o).remove()}}}function mn(e,t,i,a){const{view:o,graphic:s}=e,n=new Mi({view:o,extensionType:v.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:st.OccludeAndTransparent});v.visualElements.zVerticalLine.apply(n);const r=new Ce({view:o,intersectsLineInfinite:!0,attached:!1});v.visualElements.pointGraphics.shadowStyle.apply(r);const l=je(v.visualElements.heightPlaneAngleCutoff),c=new Ce({view:o,attached:!1,angleCutoff:l});v.visualElements.heightPlane.apply(c);const g=C(e.graphic),u=Ye.fromElevationInfo(g),m=g.mode==="on-the-ground"||!g.offset&&g.mode!=="absolute-height",f=new Ba;let y=1,S=1;const G=()=>{f.update(e);const M=Ti(s),I=m&&(t.isDraped||_(M)||!M.hasZ);let Y=!0;if(!I&&p(M)){const $=fi(M,o.elevationProvider,u,o.renderCoordsHelper);at(tt,M.x,M.y,$),ji(tt,M.spatialReference,tt,o.renderCoordsHelper.spatialReference),n.setStartEndFromWorldDownAtLocation(tt),r.intersectsWorldUpAtLocation=tt}else Y=!1;const ae=f.grabbingState&it.Z?v.visualElements.laserlineAlphaMultiplier:1;ae!==y&&(y=ae,v.visualElements.heightPlane.apply(c,ae));const oe=Va(Mn);!I&&t.displaying&&a.calculateMapBounds(oe)&&ji(rs(oe,tt),o.spatialReference,tt,o.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=tt,c.attached=!0):c.attached=!1;const pt=f.grabbingState&it.XY?v.visualElements.laserlineAlphaMultiplier:1;pt!==S&&(S=pt,v.visualElements.pointGraphics.shadowStyle.apply(r,pt));const be=Y&&t.displaying&&!I;r.attached=be,n.attached=be};i.push(A(()=>[t.displaying,t.isDraped],G),t.on("changed",G)),e.forEachManipulator(M=>{i.push(M.events.on("grab-changed",G))}),i.push(At(r)),i.push(At(n)),i.push(At(c)),G()}function _n(e,t,i){const{view:a,graphic:o}=e,s=new cs({view:a,geometry:Ti(o),elevationInfo:C(o),attached:!1});return vn(e,s,t,i),i.push(At(s)),s}function Ti(e){const t=e.geometry;return _(t)?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function vn(e,t,i,a){const o=()=>t.attached=i.displaying;fn(e,t,i,a),v.visualElements.pointGraphics.outline.apply(t),a.push(A(()=>i.displaying,o,ft))}function fn(e,t,i,a){const{view:o,graphic:s}=e;let n=null;const r=c=>{p(n)&&(n.remove(),n=null),i.isDraped&&p(c)&&(n=yn(o,c,()=>{t.geometry=c}))},l=()=>{const c=Ti(s);r(c),t.geometry=c};a.push(i.on("changed",l),Ea(()=>n)),l()}function yn(e,t,i){const a=e.elevationProvider.spatialReference;ns(t,tt,a);const o=tt[0],s=tt[1];return e.elevationProvider.on("elevation-change",n=>{Ha(n.extent,o,s)&&i()})}const tt=V(),Mn=La();function Je(e){switch(O(e.graphic.geometry).type){case"point":case"mesh":return gn(e);case"polygon":case"polyline":return pn(e);default:return null}}const bn=[1,.5,0],ja=128,lt=70,Sn=80,qa=.02,xn=54,wn=100,Wa=Math.ceil(lt/3*2),Lt=160,oi=.5,si=24,Yt=9,En=Lt+30,na=Lt+53,On=60,Tn=23,An=5*Math.PI/12,Gn=1*Math.PI/3,ra=10,la=.2,pa=30,ha=53,ca=.2,da=.3,Dn=200,Rn=3,$n=1e6;class Me{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(i=>i.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(i=>i.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(i=>i.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(i=>{t||(t=i.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(i=>i.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(i=>i===t)}someManipulator(t){let i=!1;return this.forEachManipulator(a=>{!i&&t(a)&&(i=!0)}),i}_forEachManipulator3D(t){this.forEachManipulator((i,a)=>{i instanceof J&&t(i,a)})}}function Ke(e,t,i,a){const o=e.graphic,s=(n,r)=>t({action:n,graphic:o,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((n,r,l)=>{const c=r.next(g=>(g.action==="start"&&s("start",g),g)).next(zo(o,a)).next(g=>{switch(g.action){case"start":case"update":(g.translationX||g.translationY||g.translationZ)&&s("update",g);break;case"end":s("end",g)}return g});return l.next(ko(o)).next(()=>{s("end",{screenDeltaX:0,screenDeltaY:0})}),c})}function Ja(e){if(_(e)||e.type!=="polyline"&&e.type!=="polygon")return 0;const t=(e.type==="polyline"?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}function Ne(e){if(_(e)||_(e.axis))return 1;const{mapStart:t,mapEnd:i,axis:a}=e,o=[i.x-t.x,i.y-t.y];return o[0]*a[0]+o[1]*a[1]>0?1:-1}let In=class extends Me{constructor(t){super(),this._handles=new ee,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=lt,this._updateAfterDrag=!1,this.events=new St,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._handles=R(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:i}of this._arrowManipulatorInfos)t(i,T.TRANSLATE_XY)}createGraphicDragPipeline(t,i,a){const o=i.graphic,s=C(o),n=O(o.geometry).spatialReference;return Ke(i,a,r=>this.createDragPipeline((l,c,g,u,m)=>r(l,t(l,c,g,u,m),g),s,n,o),this._view.state.viewingMode)}createDragPipeline(t,i,a,o){return Z(this._arrowManipulatorInfos.map(({manipulator:s},n)=>ot(s,(r,l,c,g,u)=>{const m=l.next(f=>({...f,manipulatorType:T.TRANSLATE_XY})).next(ce(this._view,r.elevationAlignedLocation)).next(wi(this._view,r.elevationAlignedLocation,i,a,o)).next(Ho(r.location,this.angle+(n+1)*Math.PI*.5)).next(ie());t(r,m,c,g,u)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:i},a){const o=this._radius/lt,s=xn*o,n=s*Math.sqrt(3)/2,r=Pe(n,s/2,s/2,qa);Ra(r,Wi(q.get(),at(x.get(),0,-n/3,0))),t.renderObjects=[{geometry:r,material:this._opaqueMaterial,stateMask:w.Focused},{geometry:r,material:this._transparentMaterial,stateMask:w.Unfocused}],t.radius=n/3*2*1.2;const l=vs(q.get(),a*Math.PI/2),c=Wi(q.get(),at(x.get(),0,wn*o,0));Ge(i,l,c)}_createManipulators(){for(let t=0;t<4;t++){const i=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,i=Ua(q.get(),t,U(0,0,1));if(_(i))return;const a=ze(q.get(),at(x.get(),this.displayScale,this.displayScale,this.displayScale)),o=Ge(q.get(),a,i);for(const s of this._arrowManipulatorInfos){const n=Ge(q.get(),o,s.transform);s.manipulator.modelTransform=n}}_createArrowManipulator(t){const i=new J({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:U(0,0,1)}}),a={manipulator:i,transform:qe()};return this._updateArrowManipulator(a,t),this._handles.add(i.events.on("drag",o=>{this._updateAfterDrag&&o.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const i=Na.toUnitRGBA(bi.main);return i[3]*=t,new yi({color:i,transparent:t!==1,cullFace:Si.Back,renderOccluded:st.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}};class Pn{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this.next=new $a,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&p(this._lastDragEvent)){const i=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(p(a)){const o={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?a:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this.next.execute(o)}}this._enabled=t}_snap(t){const i=p(this._view)?this._view.toMap(t,{exclude:[]}):null;return p(i)&&p(this._view)&&(i.z=po(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(t,i){return this._view=t,this._elevationInfo=i,this._lastDragEvent=null,a=>{if(this._lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const o=this._snap(a.screenEnd);return p(o)?{action:a.action,mapStart:a.mapStart,mapEnd:o,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class Ln extends Me{constructor(t){super(),this._snapToScene=new Pn,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=lt,this._view=t.view,this._tool=t.tool,t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,i,a){const o=i.graphic,s=C(o),n=O(o.geometry).spatialReference;return Ke(i,a,r=>this.createDragPipeline((l,c,g,u,m)=>r(l,t(l,c,g,u,m),g),s,n,o),this._view.state.viewingMode)}createDragPipeline(t,i,a,o){const s=this._view;return ot(this._manipulator,(n,r,l,c,g)=>{const u=r.next(ce(s,n.elevationAlignedLocation)).next(wi(s,n.elevationAlignedLocation,i,a,o)).next(this._snapToScene.createDragEventPipelineStep(s,i),this._snapToScene.next).next(m=>({...m,manipulatorType:T.TRANSLATE_XY})).next(ie());t(n,u,l,c,g)})}_updateManipulatorTransform(){const t=ze(q.get(),at(x.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new J({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:U(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=No(qa,1,ja,U(0,0,1),U(0,0,0)),i=ze(qe(),U(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:t,material:this._discMaterial,transform:i,stateMask:w.Focused},{geometry:t,material:this._discMaterialTransparent,transform:i,stateMask:w.Unfocused}],this._manipulator.radius=Sn*(this._radius/lt)}_createMaterial(t=1){const i=Na.toUnitRGBA(bi.main);return i[3]*=t,new yi({color:i,transparent:t!==1,cullFace:Si.Back,renderOccluded:st.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Vn extends Me{constructor(t){super(),this._radius=lt,this.events=new St,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_Z)}createGraphicDragPipeline(t,i,a){const o=O(i.graphic.geometry).spatialReference;return Ke(i,a,s=>this.createDragPipeline((n,r,l,c,g)=>s(n,t(n,r,l,c,g),l),o),this._view.state.viewingMode)}createDragPipeline(t,i){const a=this._view;return ot(this._manipulator,(o,s,n,r,l)=>{const c=s.next(g=>({...g,manipulatorType:T.TRANSLATE_Z})).next(Za(a,o.renderLocation,i)).next(ie());t(o,c,n,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/lt,i=v.zManipulator.height*t,a=v.zManipulator.coneHeight*t,o=v.zManipulator.coneWidth*t,s=v.zManipulator.width*t,n=[U(0,0,0),U(0,0,i)],r=Uo(n,s/2,16,!1),l=Xo(a,o/2,16,!1),c=[U(0,0,0),U(0,0,i+a)],g=M=>{const I=qe();if(fs(I,I,[0,0,i]),ys(I,I,Math.PI/2),M){const Y=1+2*M/o;Xa(I,I,[Y,Y,Y])}return I},u=g(0),m=(M,I)=>{const Y=Gs(v.zManipulator.color,I);return[Y.r/255,Y.g/255,Y.b/255,v.zManipulator.color.a*M]},f=vt(m(1,.25),st.Occlude),y=vt(m(1,0),st.Occlude),S=vt(m(.7,0),v.zManipulator.renderOccluded),G=vt(m(.85,0),v.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:u,material:f,stateMask:w.Unfocused},{geometry:r,material:f,stateMask:w.Unfocused},{geometry:l,transform:u,material:y,stateMask:w.Focused},{geometry:r,material:y,stateMask:w.Focused},{geometry:l,transform:u,material:S,stateMask:w.Unfocused},{geometry:r,material:S,stateMask:w.Unfocused},{geometry:l,transform:u,material:G,stateMask:w.Focused},{geometry:r,material:G,stateMask:w.Focused}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[c]}}_createManipulator(){const t=new J({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=i=>{const a=this._view.state.camera,o=ua;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);const s=so(a.eye,o),n=a.computeRenderPixelSizeAtDist(s),r=P(Ft,o,a.eye);Re(r,r);const l=Cn;this._view.renderCoordsHelper.worldUpAtPosition(ua,l);const c=Math.abs($e(r,l)),g=Gt(Ft,r,l),u=Gt(Ft,g,l),m=ui(c,.01,1),f=1-Math.sqrt(1-m*m)/m/a.fullWidth,y=this._radius/lt,S=v.zManipulator.width*y;bt(u,Re(u,u),(1/f-1)*s+n*S),i[12]-=Ft[0],i[13]-=Ft[1],i[14]-=Ft[2]},this._manipulator=t,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const ua=V(),Ft=V(),Cn=V();class kt extends Me{constructor(t){super(),this._handles=new ee,this._interactive=!0;const{tool:i,view:a,snapToScene:o,radius:s}=t;this._view=a,this.xyManipulation=new Ln({tool:i,view:a,snapToScene:o,radius:s}),this.xyAxisManipulation=new In({tool:i,view:a,radius:s}),this.zManipulation=new Vn({tool:i,view:a,radius:s}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(n=>{this._handles.add(n.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,i,a){return Z([this.xyManipulation.createGraphicDragPipeline((o,s,n,r,l)=>t(b.XY,o,s,n,r,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((o,s,n,r,l)=>t(b.XY_AXIS,o,s,n,r,l),i,a),this.zManipulation.createGraphicDragPipeline((o,s,n,r,l)=>t(b.Z,o,s,n,r,l),i,a)])}createDragPipeline(t,i,a,o){return Z([this.xyManipulation.createDragPipeline((s,n,r,l,c)=>t(b.XY,s,n,r,l,c),i,a,o),this.xyAxisManipulation.createDragPipeline((s,n,r,l,c)=>t(b.XY_AXIS,s,n,r,l,c),i,a,o),this.zManipulation.createDragPipeline((s,n,r,l,c)=>t(b.Z,s,n,r,l,c),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>t(i,T.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(uo("esri-mobile"))return;const a=[];i.forEachManipulator(s=>a.push(s)),t.forEachManipulator(s=>a.push(s));const o=()=>{const s=[];this._xyAxisVisible||t.forEachManipulator(n=>s.push(n.disableDisplay())),this._handles.remove(ga),this._handles.add(s,ga)};for(const s of a)this._handles.add(s.events.on("focus-changed",o));this._view.inputManager&&this._handles.add(Kt(()=>{var s;return(s=this._view.inputManager)==null?void 0:s.latestPointerType},o)),o()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this._interactive||i.grabbing})}static radiusForSymbol(t){const i=p(t)&&t.type==="point-3d"&&t.symbolLayers;return i&&i.length>0&&i.some(a=>a.type==="icon")?Wa:lt}}const ga="disable-xy-axis-display";var b;(function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"})(b||(b={}));class Ai extends Me{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,T.TRANSLATE_XY)}createGraphicDragPipeline(t){return Ke(this._graphicState,t,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(t){const i=this._view,a=this._graphicState.graphic,o=p(a.geometry)?a.geometry.spatialReference:null;return ot(this._manipulator,(s,n,r,l,c)=>{const g=n.next(ws(c,i,a,o)).next(jt()).next(ie());t(s,g,r,l,c)})}_createManipulator(){const t=this._view,i=this._graphicState.graphic;this._manipulator=new Ds({graphic:i,view:t,selectable:!0,cursor:"move"})}}class zn{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class kn{constructor(t,i,a){this.dx=t,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class ma{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}let ht=class extends Ca(St.EventedMixin(Fe)){constructor(e){super(e),this.graphics=new ms,this.enableZ=!0,this.tooltipOptions=new Dt,this.type="move-3d",this._snappingPipeline=new Le,this._tooltip=null}initialize(){const{graphics:e,view:t}=this;this.addHandles([e.on("change",()=>this._refreshManipulators()),A(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new ve({view:t}):R(this._tooltip)},vi)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=R(this._tooltip),this._moveManipulation=R(this._moveManipulation),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter(t=>Zo(t)===Ia.SUPPORTED).map(t=>new Hn(t));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map(t=>this.view.trackGraphicState(t.state))),this._updateMoveManipulation(e))}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ai({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",o=>{this.emit("immediate-click",{...o,graphic:i.graphic}),o.stopPropagation()}),a.events.on("grab-changed",({action:o})=>{const{tooltipOptions:s,_tooltip:n}=this;_(n)||(o==="start"?n.info=new _e({tooltipOptions:s}):n.clear())})])),this.handles.add(t.manipulationXY.createDragPipeline((a,o,s,n)=>this._buildDragEventPipeline(e,b.XY,a,o,s,n)))}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new kt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:e.length===1?kt.radiusForSymbol(e[0].graphic.symbol):lt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(s=>{this.handles.add(s.events.on("immediate-click",n=>{t.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...n,graphic:this.graphics.getItemAt(0)}),n.stopPropagation()}))});const i=s=>n=>{this.handles.add(n.events.on("focus-changed",({action:r})=>{const l=this._tooltip;_(l)||(r==="focus"?this._updateMoveTooltip(e,s):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(b.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(b.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(b.Z));const a=()=>this._updateMoveManipulation(e);for(const s of e)this.handles.add([s.state.on("changed",a),A(()=>s.state.displaying,a)]);const o=e[e.length-1];this.handles.add(o.state.on("changed",()=>this._updateMoveManipulationAngle(o))),this.handles.add(t.createDragPipeline((s,n,r,l,c)=>this._buildDragEventPipeline(e,s,n,r,l,c),C(o.graphic),O(o.graphic.geometry).spatialReference,o.graphic)),this._updateMoveManipulationAngle(o)}_createVisualElements(e){for(const t of e){const i=t.graphic,a=Je({view:this.view,graphic:i,forEachManipulator:o=>{t.manipulationXY.forEachManipulator(o),this._moveManipulation.forEachManipulator(o)},onManipulatorsChanged:()=>Ct()});_(a)||(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Ht&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(e)}),A(()=>t.state.isDraped,()=>this._updateMoveManipulation(e))]),this.handles.add(a))}}_updateMoveManipulationAngle(e){this._moveManipulation.angle=Ja(e.graphic.geometry)}_updateMoveManipulation(e){const t=fe(0,0,0,this.view.spatialReference);let i=0,a=!1;const o=this._moveManipulation;for(const s of e){if(!s.state.displaying)continue;const n=s.state.graphic;this.enableZ&&zt(n)&&(a=!0);const r=s.geometryRepresentation instanceof Ht&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:di(this.view,n);p(r)&&(t.x+=r.x,t.y+=r.y,t.z+=r.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,o.location=t,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=a):o.available=!1}_buildDragEventPipeline(e,t,i,a,o,s){const n=[],r=[];let l=null,c=null;const g=()=>{for(const u of n)u.dragging=!1;n.length=0,r.length=0,l=null,c=null,this._moveManipulation.interactive=!0};if(o=o.next(u=>c(u)).next(()=>{if(this.emit("graphic-move-stop",new ma(r)),this.destroyed)return null;g()}),e.length===1&&t===b.XY){const u=e[0].graphic;a=this._buildSnappingPipelineSteps(u,C(u),a,o,s)}return a.next(u=>{if(u.action==="start"){n.length=0,r.length=0;for(const m of e)m.dragging||!m.manipulationXY.hasManipulator(i)&&m.manipulationXY.grabbing||(n.push(m),r.push(m.graphic),m.dragging=!0);if(r.length!==0&&(this._moveManipulation.interactive=!1,l=Yo(r,this.view.state.viewingMode),c=Fo(r),this.emit("graphic-move-start",new zn(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l(u)).next(u=>(this._updateMoveTooltip(e,t,u),u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const m=this.view.toScreen(u.mapStart),f=this.view.toScreen(u.mapEnd),y=f.x-m.x,S=f.y-m.y;if(this.emit("graphic-move",new kn(y,S,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new ma(r)),this.destroyed)return null;g()}})}_updateMoveTooltip(e,t,i){const{tooltipOptions:a,_tooltip:o}=this;if(_(o))return;o.clear();const s=e.length===0?"absolute-height":e[0].state.isDraped?"on-the-ground":"absolute-height";switch(t){case b.XY:o.info=new _e({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,(n,r)=>Mt(n,r,s));break;case b.XY_AXIS:o.info=new Ei({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,(n,r)=>{const l=Mt(n,r,s);return Ie(l,Ne(i))});break;case b.Z:o.info=new We({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,ke)}}_updateMoveTooltipDistance(e,t,i){if(p(t)&&t.action!=="end"){const{mapStart:a,mapEnd:o}=t,s=i(a,o);e.distance=p(s)?s:de}}_buildSnappingPipelineSteps(e,t,i,a,o){const s=e.geometry;if(_(s)||s.type!=="point"&&s.type!=="mesh")return i;const n=(s.type==="point"?s:s.anchor).clone(),r=new Ve({elevationInfo:t,pointer:o,editGeometryOperations:Be.fromGeometry(n,this.view.state.viewingMode),visualizer:new ge,excludeFeature:e}),l=this.snappingManager;return i.next(c=>(n.z=ho(this.view,n,C(e),{mode:"absolute-height",offset:0}),{...c,snapOrigin:r.coordinateHelper.pointToVector(n)})).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:r,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],ht.prototype,"view",void 0),h([d()],ht.prototype,"graphics",void 0),h([d({constructOnly:!0,nonNullable:!0})],ht.prototype,"enableZ",void 0),h([d({constructOnly:!0,type:Dt})],ht.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],ht.prototype,"snappingManager",void 0),h([d()],ht.prototype,"type",void 0),h([d()],ht.prototype,"updating",null),ht=h([z("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],ht);class Hn{constructor(t){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Nt({graphic:t})}get graphic(){return this.state.graphic}}function _a(e,t,i){const a=i.mode==="on-the-ground"?Ni.XY:Ni.XYZ;return new Bo(e,a,t,0)}function va(e,t,i){const a=V();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const o=fa(e,t,ye(i.plane)),s=fa(e,t,i.edgeDirection);if(_(o)||_(s))return null;const n=Gt(V(),o,s);return Ya(a,n,Oi())}function fa(e,t,i){const a=fe(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),o=V(),s=V();return e.renderCoordsHelper.toRenderCoords(t,o)&&e.renderCoordsHelper.toRenderCoords(a,s)?Oa(s,o,s):null}function Nn(e,t,i){const a=ye(e),o=Oa(V(),t,i),s=Gt(V(),o,a),n=Gt(V(),o,s);return bs(o[0],o[1],o[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1)}function Un(e,t,i){const a=i.projectToRenderScreen(e,Pi()),o=i.projectToRenderScreen(t,Pi());return p(a)&&p(o)?no(P(a,a,o)):0}let Tt=class extends Ze{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=de,this.area=null,this.totalLength=null}};h([d()],Tt.prototype,"type",void 0),h([d()],Tt.prototype,"distance",void 0),h([d()],Tt.prototype,"area",void 0),h([d()],Tt.prototype,"totalLength",void 0),Tt=h([z("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Tt);let L=class extends St.EventedMixin(xi){constructor(e){super(e),this._vertexManipulatorMaterial=vt(v.colorToVec4(v.reshapeManipulators.vertex.color),v.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=re(v.colorToVec4(v.reshapeManipulators.vertex.outlineColor),v.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=re(v.colorToVec4(v.reshapeManipulators.vertex.hoverOutlineColor),v.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=vt(v.colorToVec4(v.reshapeManipulators.edge.color),v.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=re(v.colorToVec4(v.reshapeManipulators.edge.outlineColor),v.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=vt(v.colorToVec4(v.reshapeManipulators.edgeOffset.color),v.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=vt(v.colorToVec4(v.reshapeManipulators.edgeOffset.hoverColor),v.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=vt(v.colorToVec4(v.reshapeManipulators.selected.color),v.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=re(v.colorToVec4(v.reshapeManipulators.selected.outlineColor),v.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=re(v.colorToVec4(v.reshapeManipulators.selected.hoverOutlineColor),v.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new ee,this._manipulatorInfos=[],this._editGeometryOperations=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=D.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new Le,this._snappingPipelineHandle=new Le,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:e,view:t}=this,i=this._graphicState=new Nt({graphic:e});this._tooltip=new ve({view:t}),this.addHandles([A(()=>i.displaying,a=>{for(const o of this._manipulatorInfos)o.manipulator.available=a}),A(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:o,edgeOffsetEnabled:s})=>{p(a)&&(a.visible=o,a.edgeDistance=s?"far":"default")},ft),Kt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),ft),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=R(this._segmentLabels),this._tooltip=R(this._tooltip),this._removeManipulators()}get inputGeometry(){return p(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const e=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");this._removeVertices(e)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=R(this._moveManipulation),this._graphicMoveManipulation=R(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(_(this._editGeometryOperations))return;const e=C(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return p(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return p(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(_(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return p(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(_(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return p(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._removeManipulators(),this._tooltip.clear(),_(e)||(R(this._editGeometryOperations),this._editGeometryOperations=Be.fromGeometry(e,this.view.state.viewingMode),this._createManipulators(),R(this._segmentLabels),this._segmentLabels=new He({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:C(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(e,t){if(t.action==="end")return t;let i=0;const a=[],o=this._manipulatorInfos.some(n=>n.type==="vertex"&&n.manipulator.selected),s=e===Jt.SELECTED_OR_ALL&&o;for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.grabbing||s&&!n.manipulator.selected||a.push(n),i++);if(a.length===0)return t;if(this._moveVertices(a,t),a.length===i){if(this._updateEventState(D.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(D.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)t.type==="vertex"&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(D.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const o=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===e.info)&&o.push(s);this._moveVertices(o,e,_t.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case D.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case D.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case D.MOVING:switch(this._reshapeEventState){case D.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case D.RESHAPING:switch(this._reshapeEventState){case D.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case D.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulation(){const{tool:e,view:t}=this,i=this._graphicState;if(this._graphicMoveManipulation=new Ai({tool:e,view:t,graphicState:i}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((o,s,n)=>{s.next(r=>this._trackNumDragging(r)).next(r=>(r.action==="start"&&(a=O(this._editGeometryOperations).createUndoGroup()),r)).next(r=>this._perGraphicManipulatorDragAction(Jt.ALL,r)).next(r=>(this._updateTranslateGraphicTooltip(b.XY,r),r)).next(r=>{r.action==="end"&&(this._tooltip.clear(),a=$t(a))}),n.next(()=>this._onDragCancel(!0,()=>a=$t(a)))})),this._graphicMoveManipulation.forEachManipulator(o=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(o,!1)))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(a.events.on("immediate-click",o=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...o,graphic:this.graphic}),o.stopPropagation()})))}_createMoveManipulation(e){const{graphic:t,handles:i,tool:a,view:o}=this,s=this._graphicState;this._moveManipulation=new kt({tool:a,view:o,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&zt(t),snapToScene:!1,radius:kt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(l=>i.add([l.events.on("immediate-click",c=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(g=>g.manipulator.selected)||this.emit("immediate-click",{...c,graphic:t}),c.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const n=l=>c=>{i.add(c.events.on("focus-changed",({action:g})=>{g==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(n(b.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(n(b.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(n(b.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=O(t.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,c,g,u,m)=>(u=u.next(f=>(this._onDragCancel(),f)),g.next(f=>this._trackNumDragging(f)).next(f=>{const y=this._manipulatorInfos.filter(S=>S.type==="vertex"&&S.manipulator.selected);return f.manipulatorType===T.TRANSLATE_XY&&y.length===1?{...f,info:y[0],snapOrigin:y[0].handle.pos}:f}).next(Ui(this.view,e,t)).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:f=>!!f.info,cancel:u,snappingManager:a.snappingManager,snappingContext:new Ve({editGeometryOperations:O(this._editGeometryOperations),elevationInfo:e,pointer:m,excludeFeature:t,visualizer:new ge}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipelineHandle.next).next(jt()).next(f=>this._perGraphicManipulatorDragAction(Jt.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f))),e,r,t),A(()=>s.displaying,()=>{this._updateMoveManipulationPosition()},ft),s.on("changed",()=>this._updateMoveManipulationPosition()),A(()=>s.isDraped,l=>{this._updateMoveManipulationPosition();const c="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),c):i.remove(c)},ft)])}_createVisualElements(){const{graphic:e,view:t}=this,i=Je({view:t,graphic:e,forEachManipulator:a=>{if(!this.destroyed){this._graphicMoveManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a);for(const o of this._manipulatorInfos)a(o.manipulator,T.TRANSLATE_XY)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});p(i)&&(this._outlineVisualElement=i.visualElement instanceof Ht?i.visualElement:null),p(this._outlineVisualElement)&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=C(this.graphic)){const i=v.reshapeManipulators.edgeOffset,a=i.size/2,o=a+i.collisionPadding;if(_(this._edgeOffsetManipulatorGeometryInside)||_(this._edgeOffsetManipulatorGeometryOutside)){const u=a/o,m=u*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=Pe(m,u/2,u/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=Pe(-m,u/2,u/2,i.height,-i.offset)}const s=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:w.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:w.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:w.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:w.Focused}],n=new J({view:this.view,renderObjects:s,elevationInfo:t.mode!=="on-the-ground"||ea(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:U(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),r=new J({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),l={manipulator:n,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:r,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const c=[];for(const u of[l.handle.leftVertex,l.handle.rightVertex]){const m=this._getManipulatorInfoFromHandle(u);p(m)&&c.push(m.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)))}l.locationUpdateHandle=Z(c),this._manipulatorHandles.add(l.locationUpdateHandle,n),this._manipulatorHandles.add([this._watchAndUpdateGrabState(n,!0),this._watchAndUpdateGrabState(r,!0)],n),this._manipulatorHandles.add(ot(n,this._createEdgeOffsetPipeline(l,t)),n),this._manipulatorHandles.add(ot(r,(u,m,f,y)=>{if(y==="touch")this._createEdgeOffsetPipeline(l,t)(u,m,f);else if(this.enableMoveGraphic){const S=this.graphic,G=p(S.geometry)?S.geometry.spatialReference:null;m.next(M=>this._trackNumDragging(M)).next(ce(this.view,u.elevationAlignedLocation)).next(wi(this.view,u.elevationAlignedLocation,t,G,S)).next(ie()).next(jt()).next(M=>this._perGraphicManipulatorDragAction(Jt.ALL,M)).next(M=>(this._updateTranslateGraphicTooltip(b.XY,M),M)).next(M=>{M.action==="end"&&this._tooltip.clear()}),f.next(()=>this._onDragCancel(!u.metadata.deleting))}}),n);const g=u=>{this._manipulatorInfos.some(m=>m.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...u,graphic:this.graphic}),u.stopPropagation()};return this._manipulatorHandles.add([n.events.on("immediate-click",g),r.events.on("immediate-click",g),n.events.on("focus-changed",({action:u})=>{const m=this._tooltipOptions;if(u==="focus"&&m.enabled){const f=this._tooltip.info=new Tt({tooltipOptions:m});this._updateTooltipAreaOrTotalLength(f)}else this._tooltip.clear()})],n),this._manipulatorInfos.push(l),this.manipulators.add(n),this.manipulators.add(r),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,a=e.edgeManipulator,o=()=>{e.visibilityHandle=$t(e.visibilityHandle);const s=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=p(s)&&p(n)&&Un(s.manipulator.renderLocation,n.manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||r)&&(i.grabbable=!r,a.grabbable=!r,e.visibilityHandle=Z([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",o),a.events.on("focus-changed",o),{remove:()=>{$t(e.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}}],i),o()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=O(this._editGeometryOperations).data,i=va(this.view,e.manipulator.elevationAlignedLocation,_a(t,e.handle,O(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex),o=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(_(a)||_(o))return;const s=a.manipulator.renderLocation,n=o.manipulator.renderLocation,r=p(i)?Nn(i,s,n):Ss;e.manipulator.modelTransform=r,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=r;const l=Qt(P(we,s,n))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,o)=>{this._clearSelection();const{step:s,cleanup:n}=this._initializeEdgeOffset(e,t);a.next(r=>this._trackNumDragging(r)).next(ce(this.view,i.elevationAlignedLocation)).next(s).next(Es(this.view)).next(Os(this.view,O(this._editGeometryOperations).data.spatialReference)).next(jt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&n()}),o.next(()=>{i.metadata.deleting||(n(),this._onDragCancel())})}}_initializeEdgeOffset(e,t){const i=O(this._editGeometryOperations),a=_a(i.data.coordinateHelper,e.handle,t),o=i.createUndoGroup(),s=va(this.view,e.manipulator.elevationAlignedLocation,a);if(a.requiresSplitEdgeLeft){const u=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);p(u)&&this._splitEdgeManipulator(u,1)}if(a.requiresSplitEdgeRight){const u=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);p(u)&&this._splitEdgeManipulator(u,0)}const n=()=>new wo({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),r=new Ht({view:this.view,isDraped:this._graphicState.isDraped,geometry:n(),elevationInfo:e.elevationInfo,width:v.visualElements.lineGraphics.outline.width,color:v.colorToVec4(bi.main),attached:!0});let l;const c=()=>{this._cleanEdgeOffsetCollapsedEdges(e),l=$t(l)},g=this.on("undo",c);return l=Z([At(r),A(()=>this._graphicState.isDraped,u=>r.isDraped=u),this._graphicState.on("changed",()=>r.geometry=n()),o,g]),{step:u=>_(a)||_(s)?(c(),null):{...u,operation:a,plane:s},cleanup:c}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||_(t.operation))return t;this._updateEventState(D.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:o}=t;return(i||a||o)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:i}=e;return _(t)||_(i)?e:(e.action==="start"&&t.selectArrowFromStartPoint(i),{...e,signedDistance:t.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:i,operation:a}=e,o=this._tooltip,s=this._tooltipOptions;if(!s.enabled||_(i))return o.clear(),e;let n=o.info;(_(n)||n.type!=="reshape-edge-offset")&&(n=o.info=new Tt({tooltipOptions:s}));const{coordinateHelper:r}=O(this._editGeometryOperations).data;return n.distance=e.action==="end"?de:Xn(this._graphicState.isDraped,i*a.selectedArrow,t,a.plane,r),this._updateTooltipAreaOrTotalLength(n),e}}_cleanEdgeOffsetCollapsedEdges(e){var r,l;const t=(r=e.handle.leftVertex.leftEdge)==null?void 0:r.leftVertex,i=e.handle.leftVertex,a=(l=e.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,o=e.handle.rightVertex,s=O(this._editGeometryOperations).data.coordinateHelper,n=[];if(t&&s.distance(t.pos,i.pos)<ni){const c=this._getManipulatorInfoFromHandle(i);p(c)&&n.push(c)}if(s.distance(i.pos,o.pos)<ni||a&&s.distance(a.pos,o.pos)<ni){const c=this._getManipulatorInfoFromHandle(o);p(c)&&n.push(c)}n.length&&this._removeVertices(n)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=C(this.graphic)){if(e.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(_(this._vertexManipulatorGeometry)||_(this._vertexManipulatorOutlineGeometry)){const{size:n,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(v.reshapeManipulators.vertex);this._vertexManipulatorGeometry=xe(n,16,16),this._vertexManipulatorOutlineGeometry=xe(r,16,16)}if(_(this._edgeManipulatorGeometry)||_(this._edgeManipulatorOutlineGeometry)){const{size:n,outlineSize:r}=this._computeVertexManipulatorSizeAndOutline(v.reshapeManipulators.edge);this._edgeManipulatorGeometry=xe(n,16,16),this._edgeManipulatorOutlineGeometry=xe(r,16,16)}const i=p(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Q.Vertex|w.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:Q.Vertex|w.Unfocused|w.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Q.Vertex|w.Focused|w.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:w.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:w.Selected|w.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:w.Selected|w.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Q.Edge|w.Focused|w.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Q.Edge|w.Focused|w.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:Q.Edge|w.Unfocused|w.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:Q.Edge|w.Unfocused|w.Unselected});const a=new J({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible),metadata:{deleting:!1}});this._setTypeSpecificManipulatorSettings(a,e,t);const o=e.type==="edge"?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(o),this.manipulators.add(a),this._updateManipulatorPosition(o),o.type==="edge"){const n=[];for(const r of[o.handle.leftVertex,o.handle.rightVertex]){const l=this._getManipulatorInfoFromHandle(r);p(l)&&n.push(l.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(o)))}o.locationUpdateHandle=Z(n),this._manipulatorHandles.add(o.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const s=ot(a,(n,r,l,c)=>{let g=null;l=l.next(u=>(this._onDragCancel(!n.metadata.deleting,()=>g=$t(g)),u)),r.next(u=>this._trackNumDragging(u)).next(u=>{if(u.action==="start"&&(g=O(this._editGeometryOperations).createUndoGroup()),o.type==="edge"){const m=this._splitEdgeManipulator(o);return{...u,info:m,snapOrigin:m.handle.pos}}return{...u,info:o,snapOrigin:o.handle.pos}}).next(ce(this.view,n.elevationAlignedLocation)).next(Ts(this.view,this.graphic,n.elevationAlignedLocation,n.location.spatialReference,this.graphic)).next(Ui(this.view,t,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new Ve({editGeometryOperations:O(this._editGeometryOperations),elevationInfo:t,pointer:c,excludeFeature:this.graphic,visualizer:new ge}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipeline.next).next(jt()).next(u=>{this._perVertexManipulatorDragAction(u),u.action==="end"&&(g=$t(g)),this._updateTranslateVertexTooltip(n,b.XY,u)})});return this._manipulatorHandles.add([s,a.events.on("immediate-click",n=>this._manipulatorClickCallback(n,o)),a.events.on("select-changed",()=>{o.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:n})=>{n==="focus"&&o.type!=="edge"?this._updateTranslateVertexTooltip(a,b.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),o}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_onDragCancel(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=p(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null),p(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case D.NONE:break;case D.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(D.NONE)}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=Q.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=v.reshapeManipulators.vertex.size/2+v.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=p(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":e.state=Q.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=v.reshapeManipulators.edge.size/2+v.reshapeManipulators.edge.collisionPadding,e.elevationInfo=i.mode!=="on-the-ground"||ea(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",i=>this._onGrabStateChanged(e,t,i.action,i.pointerType))}_onGrabStateChanged(e,t,i,a="mouse"){if(i==="start")t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(D.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(o=>{o.manipulator.interactive=o.manipulator.grabbing||!this._numGrabbing&&p(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in o&&(o.edgeManipulator.interactive=o.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(o=>{o.interactive=o.grabbing||!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){_(e)||(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),eo(this._manipulatorInfos,e),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e){for(const t of this._manipulatorInfos)if(e===t.handle)return t}return null}_updateManipulatorPosition(e){if(_(e))return;const t=O(this._editGeometryOperations);if(e.type==="vertex")e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,pe),e.manipulator.grabbing&&p(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if(e.type==="edge"){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),a=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(_(i)||_(a))return;const o=i.manipulator,s=a.manipulator;if(p(e.manipulator.elevationInfo)&&e.manipulator.elevationInfo.mode==="on-the-ground"){const n=o.location,r=s.location,l=.5,c=n.x+l*(r.x-n.x),g=n.y+l*(r.y-n.y),u=n.hasZ&&r.hasZ?0:void 0;e.manipulator.location=fe(c,g,u,t.data.spatialReference)}else Pt(we,o.renderLocation,s.renderLocation,.5),e.manipulator.renderLocation=we}}_splitEdgeManipulator(e,t=.5){const i=O(this._editGeometryOperations),a=O(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const o=C(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(e),s=this._createVertexOrEdgeManipulator(a)):(s=e,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,o)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,b.XY),this._updateSelection(e.manipulator);const n=this._updateEventState(D.RESHAPING),r=i.data.coordinateHelper.vectorToArray(s.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:O(a.index)}],added:r}),n&&this._updateEventState(D.NONE),s}_updateMoveManipulationPosition(){const e=at(we,0,0,0);let t=0,i=!1,a=null,o=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(t++,yt(e,e,s.manipulator.renderLocation),_(a)||s.selectedIndex>a.selectedIndex?(o=a,a=s):(_(o)||s.selectedIndex>o.selectedIndex)&&(o=s)):i=!0);if(t!==0){const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&zt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&t!==1}else{const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&zt(this.graphic)}if(t!==0){let s=0;if(p(a)){const n=a.handle.pos,r=p(o)?o.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=_(o)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;r&&l?this._moveManipulation.xyAxisManipulation.available=!1:r?s=ya(r,n):l&&(s=ya(n,l))}this._moveManipulation.angle=s,this._moveManipulation.radius=Wa}else this._moveManipulation.angle=Ja(O(this.graphic.geometry)),this._moveManipulation.radius=kt.radiusForSymbol(this.graphic.symbol);t!==0&&i?(bt(e,e,1/t),pe.spatialReference=O(this._editGeometryOperations).data.spatialReference,pe.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,pe),this._moveManipulation.elevationAlignedLocation=pe):p(this._outlineVisualElement)&&!this._graphicState.isDraped&&p(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:za(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=O(this._editGeometryOperations);for(const a of e)if(a.type==="vertex"&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const o=O(i.removeVertices([a.handle]).removedVertices[0].createdEdge);o&&this._createVertexOrEdgeManipulator(o)}if(t.length>0){const a=t.map(s=>{const n=i.data.components.indexOf(s.component);return{coordinates:i.data.coordinateHelper.vectorToArray(s.pos),componentIndex:n,vertexIndex:O(s.index)}});this.outputGeometry=i.data.geometry;const o=this._updateEventState(D.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||o&&(this._updateEventState(D.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=t.action==="start"?_t.NEW_STEP:_t.ACCUMULATE_STEPS){const a=O(this._editGeometryOperations);a.moveVertices(e.map(o=>o.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const o of e)this._updateManipulatorPosition(o)}_offsetEdge(e,t){if(_(t.operation)||_(t.signedDistance))return;const i=O(this._editGeometryOperations),a=t.operation.clone();a.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,e.button===Xi.Right&&this._removeVertices([t])),t.type==="edge"&&e.button===Xi.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const i=this._tooltipOptions;if(!i.enabled)return;const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case b.XY:this._tooltip.info=new _e({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(o,s)=>Mt(o,s,a));break;case b.XY_AXIS:this._tooltip.info=new Ei({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(o,s)=>{const n=Mt(o,s,a);return Ie(n,Ne(t))});break;case b.Z:this._tooltip.info=new We({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,ke)}}_updateTranslateVertexTooltip(e,t,i){const a=this._tooltipOptions;if(!a.enabled)return;let o;const s=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case b.XY:o=new Is({tooltipOptions:a}),this._updateTranslateTooltipDistance(o,i,(r,l)=>Mt(r,l,s)),this._updateTooltipAreaOrTotalLength(o);break;case b.XY_AXIS:o=new $s({tooltipOptions:a}),this._updateTranslateTooltipDistance(o,i,(r,l)=>{const c=Mt(r,l,s);return Ie(c,Ne(i))}),this._updateTooltipAreaOrTotalLength(o);break;case b.Z:o=new Rs({tooltipOptions:a}),this._updateTranslateTooltipDistance(o,i,ke)}const n=Ps(e.elevationAlignedLocation);p(n)&&(o.elevation={mode:"absolute-height",...n}),this._tooltip.info=o}_updateTranslateTooltipDistance(e,t,i){if(p(t)&&t.action!=="end"){const{mapStart:a,mapEnd:o}=t,s=i(a,o);e.distance=p(s)?s:de}}_updateTooltipAreaOrTotalLength(e){const{geometry:t}=this.graphic;if(_(t))return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";e.area=t.type==="polygon"?Cs(t,i):null,e.totalLength=t.type==="polyline"?Ao(t,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function ya(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Xn(e,t,i,a,o){if(e){const s=o.toXYZ(o.pointToVector(i)),n=Vs(a,s,x.get()),r=Go(n,s,o.spatialReference);if(p(r))return ue(r.value*Math.sign(t),r.unit)}return ue(t*pi(i.spatialReference),"meters")}h([d()],L.prototype,"_segmentLabels",void 0),h([d({constructOnly:!0})],L.prototype,"tool",void 0),h([d()],L.prototype,"_tooltip",void 0),h([d()],L.prototype,"inputGeometry",null),h([d()],L.prototype,"outputGeometry",void 0),h([d({readOnly:!0})],L.prototype,"updating",null),h([d()],L.prototype,"manipulators",null),h([d()],L.prototype,"view",null),h([d()],L.prototype,"graphic",null),h([d()],L.prototype,"enableZShape",null),h([d()],L.prototype,"enableZVertex",null),h([d()],L.prototype,"enableMoveGraphic",null),h([d()],L.prototype,"enableMidpoints",null),h([d()],L.prototype,"enableEdgeOffset",null),h([d()],L.prototype,"_labelOptions",null),h([d()],L.prototype,"_tooltipOptions",null),L=h([z("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],L);const pe=fe(0,0,null,null),we=V(),ni=1e-6;var Q,D,Jt;(function(e){e.Vertex=mt.Custom1,e.Edge=mt.Custom2})(Q||(Q={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(D||(D={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Jt||(Jt={}));let H=class extends St.EventedMixin(Fe){constructor(e){super(e),this._handles=new ee,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Pa,this.tooltipOptions=new Dt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const e=this._reshapeOperation=new L({tool:this});this.addHandles([e.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),e.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),e.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),e.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),e.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>{t.stopPropagation()}),A(()=>this.graphic,()=>this._updateGraphic(),vi)]),this.finishToolCreation()}destroy(){this._handles=R(this._handles),this._reshapeOperation=R(this._reshapeOperation)}get updating(){var e;return((e=this._reshapeOperation)==null?void 0:e.updating)??!1}_updateGeometry(){const e=jo(this.graphic);this._reshapeOperation.inputGeometry=p(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),qo(this.graphic)!==Ia.SUPPORTED)return;const e=A(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},De);this._handles.add(e,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){_(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){p(this.snappingManager)&&this.snappingManager.doneSnapping(),p(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){p(this.snappingManager)&&this.snappingManager.doneSnapping(),p(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){e.type!=="key-down"||e.key!=="Delete"&&e.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([d()],H.prototype,"_reshapeOperation",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"view",void 0),h([d({constructOnly:!0})],H.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"enableZShape",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"enableZVertex",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"enableMoveGraphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"enableMidpoints",void 0),h([d({constructOnly:!0,nonNullable:!0})],H.prototype,"enableEdgeOffset",void 0),h([d()],H.prototype,"type",void 0),h([d({constructOnly:!0,type:Pa})],H.prototype,"labelOptions",void 0),h([d({constructOnly:!0,type:Dt})],H.prototype,"tooltipOptions",void 0),h([d({constructOnly:!0})],H.prototype,"snappingManager",void 0),h([d()],H.prototype,"updating",null),h([d()],H.prototype,"automaticManipulatorSelection",void 0),H=h([z("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],H);let ct=class extends Ze{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};h([d()],ct.prototype,"type",void 0),h([d()],ct.prototype,"rotation",void 0),h([d()],ct.prototype,"rotationPrecision",void 0),h([d()],ct.prototype,"orientation",void 0),h([d()],ct.prototype,"orientationPrecision",void 0),h([d()],ct.prototype,"rotationType",void 0),ct=h([z("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],ct);let Ot=class extends Ze{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([d()],Ot.prototype,"type",void 0),h([d()],Ot.prototype,"scale",void 0),h([d()],Ot.prototype,"size",void 0),h([d()],Ot.prototype,"sizeUnit",void 0),h([d()],Ot.prototype,"sizePrecision",void 0),Ot=h([z("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Ot);let W=class extends Ze{constructor(e){super(e),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([d()],W.prototype,"type",void 0),h([d()],W.prototype,"orientation",void 0),h([d()],W.prototype,"orientationEnabled",void 0),h([d()],W.prototype,"orientationPrecision",void 0),h([d()],W.prototype,"rotationType",void 0),h([d()],W.prototype,"size",void 0),h([d()],W.prototype,"sizeUnit",void 0),h([d()],W.prototype,"sizeEnabled",void 0),h([d()],W.prototype,"sizePrecision",void 0),W=h([z("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],W);var E,te;(function(e){e.ScaleIn=mt.Custom2,e.ScaleOut=mt.Custom3,e.RotateLeft=mt.Custom4,e.RotateRight=mt.Custom5,e.Unlocked=mt.Custom7,e.DelayedFocused=mt.Custom8,e.TouchInput=mt.Custom12})(E||(E={}));class Zn{constructor({adapter:t,tooltipOptions:i,mode:a,tool:o}){this._mode=null,this._handles=new ee,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new St,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>p(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this._adapter.scale:1,this.tool=o,this._mode=a,this._adapter=t,this._tooltipOptions=i,this._tooltip=new ve({view:o.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(Kt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),ft))}get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}destroy(){p(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=R(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=R(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const i=to({update:({deltaTime:a})=>{t.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:i}}cancelActiveAnimation(){p(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=R(this._activeAnimation))}forEachManipulator(t){t(this._ringManipulator,T.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const i=this.tool.graphicState.graphic,a=ot(t,(o,s,n)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:Ta(o.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const c=x.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(o.renderLocation,c),s.next(gi(this.tool.view,Ya(o.renderLocation,c,Oi()))).next(g=>{const u=ye(g.plane),m=ka(g.renderStart,g.renderEnd,l.origin,u),f=ks.shortestSignedDiff(l.angle,m);l.angleDir=ui(l.angleDir+f,-da,da),l.angle=m;const y=Yn(l,g),S=y-this._adapter.scale;if(l.scaleDir=ui(l.scaleDir+S,-ca,ca),this._onScaleChanged(),l.mode==="none"){const G=this._mode||Fn(g,g.plane,l.origin,this.tool.view.state.camera);if(p(G)){switch(G){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=G}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+m;break;case"scale":r.state.scale=y,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),g.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:me(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:y,yScale:y})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:me(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:y,yScale:y})}}return g.action==="end"&&(this.startAnimation(Ma(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),g}).next(this._updateTooltipPipelineStep(l)),n.next(()=>{if(r.cancel(),p(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(Ma(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,t.events.on("focus-changed",o=>{o.action==="focus"?this.startAnimation(Bn(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),t.events.on("immediate-click",o=>{o.stopPropagation()}),A(()=>{var o;return(o=this.tool.graphicState)==null?void 0:o.displaying},o=>this._ringManipulator.available=o,ft)])}_updateTooltipPipelineStep(t){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const o=this._tooltip,s=this._tooltipOptions.visualVariables,n=p(s)?s.size:null,r=p(s)?s.rotation:null;switch(t.mode){case"scale":o.info=new Ot({tooltipOptions:a,scale:{value:this._adapter.scale},size:ue(et(this._adapter.size,-1),"meters"),sizeUnit:p(n)?n.unit:null,sizePrecision:p(n)?Oe(n.valueType):null});break;case"rotate":{const l=p(r)?Oe(r.valueType):null,c=p(r)?r.rotationType:"geographic";o.info=new ct({tooltipOptions:a,rotation:ei(et(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:ei(-this._adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:c})}}return i}}_updateFocusTooltip(){if(this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,i=p(t)?t.rotation:null,a=p(t)?t.size:null;this._tooltip.info=new W({tooltipOptions:this._tooltipOptions,orientation:ei(-this._adapter.angle,"radians","geographic"),orientationEnabled:this._mode==null||this._mode==="rotate",orientationPrecision:p(i)?Oe(i.valueType):null,rotationType:p(i)?i.rotationType:"geographic",size:ue(et(this._adapter.size,-1),"meters"),sizeUnit:p(a)?a.unit:null,sizeEnabled:this._mode==null||this._mode==="scale",sizePrecision:p(a)?Oe(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(E.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(E.Unlocked,!(p(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),p(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut,!1),this._ringManipulator.updateStateEnabled(E.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(E.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(E.RotateLeft|E.RotateRight,!1),this._ringManipulator.updateStateEnabled(E.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(E.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut|E.RotateLeft|E.RotateRight,!1)}_updateManipulatorTransform(){const t=Ua(q.get(),this._adapter.angle,U(0,0,1));if(_(t))return;const i=this.getScale(),a=ze(q.get(),at(x.get(),i,i,i));this._ringManipulator.modelTransform=Ge(q.get(),a,t)}_createRingManipulator(){const t=($,nt,xt)=>{const wt=[],Et=Math.ceil(ja*(nt-$)/(2*Math.PI));for(let k=0;k<Et+1;k++){const se=$+k*(nt-$)/Et;wt.push(U(xt*Math.cos(se),xt*Math.sin(se),0))}return wt},i=$=>t(0,2*Math.PI,$),a=$=>[[-$/2,0],[$/2,0],[$/2,oi/2],[-$/2,oi/2]],o=($,nt)=>Wo(a(nt),$,[],[],!1),s=i(Lt),n=o(s,si),r={left:[],right:[]},l=[];for(let $=0;$<2;$++){const nt=$*Math.PI-Math.PI/4,xt=Math.PI/2-An,wt=nt+xt,Et=nt+Math.PI/2-xt,k=t(wt,Et,En),se=o(k,Yt);l.push(k),l.push(t(wt,Et,na-si/2)),r.left.push(se),r.right.push(se);for(let Qe=0;Qe<2;Qe++){const Gi=Qe===0,F=qe();if(Gi){Xa(F,F,[1,-1,1]),Ji(F,F,-wt,[0,0,1]);const Rt=Math.round(la*(k.length-1));F[12]=k[Rt][0],F[13]=k[Rt][1],F[14]=k[Rt][2]}else{Ji(F,F,Et,[0,0,1]);const Rt=Math.round((1-la)*(k.length-1));F[12]=k[Rt][0],F[13]=k[Rt][1],F[14]=k[Rt][2]}const Di=Pe(On,0,Tn,oi);Ra(Di,F),(Gi?r.left:r.right).push(Di)}}const c=[];for(let $=0;$<2;$++){const nt=$*Math.PI-Math.PI/4,xt=Math.PI/2-Gn,wt=nt+xt,Et=nt+Math.PI/2-xt,k=t(wt,Et,na);c.push(o(k,Yt))}const g=i(Lt+pa),u=i(Lt+ha),m=o(g,Yt),f=o(u,Yt),y=i(Lt-pa),S=i(Lt-ha),G=o(y,Yt),M=o(S,Yt),I=this._createMaterial(),Y=this._createMaterial(.66),ae=this._createMaterial(.5),oe=this._createMaterial(.33);let pt=[{geometry:n,material:I,stateMask:E.DelayedFocused},{geometry:n,material:ae,stateMask:w.None}];this._mode&&this._mode!=="scale"||(pt=pt.concat([{geometry:c,material:I,stateMask:E.DelayedFocused|E.Unlocked},{geometry:m,material:Y,stateMask:E.DelayedFocused|E.ScaleIn},{geometry:f,material:oe,stateMask:E.DelayedFocused|E.ScaleIn},{geometry:G,material:Y,stateMask:E.DelayedFocused|E.ScaleOut},{geometry:M,material:oe,stateMask:E.DelayedFocused|E.ScaleOut}])),this._mode&&this._mode!=="rotate"||(pt=pt.concat([{geometry:r.right,material:I,stateMask:E.DelayedFocused|E.Unlocked},{geometry:r.left,material:I,stateMask:E.DelayedFocused|E.RotateLeft},{geometry:r.right,material:I,stateMask:E.DelayedFocused|E.RotateRight}]));const be=[s,...l];return new J({view:this.tool.view,renderObjects:pt,autoScaleRenderObjects:!1,worldOriented:!0,radius:si,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:C(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:be,direction:U(0,0,1)}})}_createMaterial(t=1){const i=Hs([...bn,t]);return new yi({color:i,transparent:t!==1,cullFace:Si.Back,renderOccluded:st.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function Yn(e,t){const i=P(x.get(),t.renderStart,e.origin),a=P(x.get(),t.renderEnd,e.origin),o=Qt(i),s=Qt(a);return o===0?0:s/o}function Fn(e,t,i,a){const{renderStart:o,renderEnd:s}=e,n=Ee(o,a,x.get()),r=Ee(s,a,x.get());if(ro(n,r)<ra*ra)return null;const l=P(x.get(),o,i),c=Gt(x.get(),l,ye(t)),g=o,u=yt(x.get(),g,c),m=Ee(i,a,x.get()),f=n,y=Ee(u,a,x.get()),S=P(x.get(),y,f),G=P(x.get(),n,m),M=Ki(f,S),I=Ki(m,G);return Qi(M,r)<Qi(I,r)?"rotate":"scale"}function Ee(e,t,i){return t.projectToScreen(e,ri),at(i,ri[0],ri[1],0)}function Ma(e,t){let i=null,a=1;const o=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=o,t()},update:s=>(a+=((a+1)/2-a)*Math.min(s*Rn,1),t(),Math.abs(a-1)<.01?te.STOP:te.CONTINUE),destroy:()=>{e.getScale=i,t()}}}function Bn(e,t){let i=0,a=null;const o=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=o,i=0,t()},update:s=>(i+=s,!a()||i>Dn?te.STOP:te.CONTINUE),destroy:()=>{e.getFocused=a,t()}}}function Oe(e){switch(e){case"integer":case"long":return 0;default:return null}}(function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"})(te||(te={}));const ri=Xe();function Ka(e){return p(e.geometry)&&e.geometry.type==="mesh"?jn(e.geometry):qn(e)}function jn(e){return p(e.transform)?Wn(e,e.transform):Jn(e)}function qn(e){let t=e.geometry,i=io;return{undo(a){i=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=i}}}function Wn(e,t){let i=t.clone(),a=null;return{undo:o=>{a=p(e.transform)?e.transform.clone():null,e.transform=i,o.notifyGeometryChanged()},redo:o=>{i=p(e.transform)?e.transform.clone():null,e.transform=a,o.notifyGeometryChanged()}}}function Jn(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}let dt=class extends xi{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([Kt(()=>p(this._interactionState)&&this._interactionState.angle!==this._interactionState.previousAngle?{interactionState:this._interactionState,angle:this._interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},De),Kt(()=>p(this._interactionState)&&this._interactionState.scale!==this._interactionState.previousScale?{interactionState:this._interactionState,scale:this._interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},De)])}get angle(){const t=this.geometry.transform;if(_(t))return 0;const i=Ns(t.rotation)[2];return Math.abs(i)>.999999?je(Us(t.rotation))*Math.sign(i):0}get scale(){return p(this._interactionState)?this._interactionState.scale:1}startInteraction(){const t=new ut({angle:this.angle});this._interactionState=t;const i=()=>this._interactionState=null;return{state:t,done:i,cancel:()=>{t.cancel(),i()}}}createUndoRecord(){return Ka(this.graphic)}_updateMeshRotation(t){const i=this.geometry.anchor,a=this.viewingMode===mi.Global,{angle:o,previousAngle:s}=t;this.geometry.rotate(0,0,me(o-s),{origin:i,geographic:a}),t.previousAngle=o,p(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const i=this.geometry.anchor,a=this.viewingMode===mi.Global,{scale:o,previousScale:s}=t;this.geometry.scale(o/s,{origin:i,geographic:a}),t.previousScale=o,p(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([d({constructOnly:!0})],dt.prototype,"graphic",void 0),h([d({constructOnly:!0})],dt.prototype,"geometry",void 0),h([d({constructOnly:!0})],dt.prototype,"viewingMode",void 0),h([d()],dt.prototype,"angle",null),h([d()],dt.prototype,"scale",null),h([d()],dt.prototype,"_interactionState",void 0),dt=h([z("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],dt);let ut=class extends Ue{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:i}=this;return{angle:t,scale:i}}cancel(){this.angle=this.initialAngle,this.scale=1}};h([d()],ut.prototype,"angle",void 0),h([d()],ut.prototype,"initialAngle",void 0),h([d()],ut.prototype,"previousAngle",void 0),h([d()],ut.prototype,"previousScale",void 0),h([d()],ut.prototype,"scale",void 0),h([d()],ut.prototype,"state",null),ut=h([z("InteractionState")],ut);let N=class extends xi{constructor(e){super(e),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Kt(()=>p(this._interactionState)?this._interactionState.state:null,e=>{this._updateSymbol(e)},De))}get angle(){return p(this._interactionState)?this._interactionState.angle:p(this._orientationReferenceSymbolLayer)?Kn(this._orientationReferenceSymbolLayer.heading):0}get scale(){return p(this._interactionState)?this._interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return p(this._interactionState)?this._interactionState.initialAngle:0}get size(){const e=this._sizeReferenceSymbolLayer;if(_(e))return null;const t=this.findLayerView(),i=this._graphicSymbol;if(_(t)||_(i)||i.type!=="point-3d")return null;const a=t.getSymbolLayerSize(i,e);if("size"in a&&p(a.size))return a.size;const o=this.sizeAxis;return"width"in a&&p(a.width)&&(_(o)||o==="width"||o==="all"||o==="width-and-depth")?a.width:"depth"in a&&p(e.depth)&&(_(o)||o==="depth"||o==="all"||o==="width-and-depth")?a.depth:"height"in a&&p(e.height)&&(_(o)||o==="height"||o==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return _(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return _(e)||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&p(t.heading))}get _graphicSymbol(){return p(this.graphic)&&p(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(p(this._interactionState)||_(e)||_(t))return Qn;const i=e.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(e,r):null).toArray(),a=e.clone(),o=this.angle,s=new gt({originalSymbol:a,angle:o,initialSizes:i});this._interactionState=s;const n=()=>this._interactionState=null;return{state:s,done:n,cancel:()=>{this._graphicSymbol=a,n()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e},redo:i=>{e=i.symbol,i.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:i,initialSizes:a}){const o=this._graphicSymbol;if(_(o)||o.type!=="point-3d")return;const s=o.clone(),n=-me(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,s,(l,c,g)=>{const u=et(l.heading,0)+n;c.heading!==u&&(c.heading=u,r=!0);const m=a[g];if(p(m)&&"width"in m){m.width=this.sizeFilter(m.width),m.height=this.sizeFilter(m.height),m.depth=this.sizeFilter(m.depth);const f=m.width*e;c.width!==f&&(c.width=f,r=!0);const y=m.depth*e;c.depth!==y&&(c.depth=y,r=!0);const S=m.height*e;c.height!==S&&(c.height=S,r=!0)}}),r&&(this._graphicSymbol=s)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach((a,o)=>{const s=t.symbolLayers.getItemAt(o);a.type==="object"&&s.type==="object"&&i(a,s,o)})}};function Kn(e){return-je(e)}h([d()],N.prototype,"angle",null),h([d()],N.prototype,"scale",null),h([d()],N.prototype,"relativeAngle",null),h([d()],N.prototype,"initialAngle",null),h([d()],N.prototype,"size",null),h([d()],N.prototype,"sizeAxis",void 0),h([d({constructOnly:!0})],N.prototype,"graphic",void 0),h([d()],N.prototype,"_interactionState",void 0),h([d({constructOnly:!0})],N.prototype,"findLayerView",void 0),h([d({constructOnly:!0})],N.prototype,"sizeFilter",void 0),h([d()],N.prototype,"_sizeReferenceSymbolLayer",null),h([d()],N.prototype,"_orientationReferenceSymbolLayer",null),h([d()],N.prototype,"_graphicSymbol",null),N=h([z("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],N);const Qn={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let gt=class extends Ue{constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}get state(){const{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:o}=this;return{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:o}}};h([d()],gt.prototype,"originalSymbol",void 0),h([d()],gt.prototype,"angle",void 0),h([d()],gt.prototype,"initialAngle",void 0),h([d()],gt.prototype,"initialSizes",void 0),h([d()],gt.prototype,"scale",void 0),h([d()],gt.prototype,"state",null),gt=h([z("InteractionState")],gt);let B=class extends Ca(St.EventedMixin(Fe)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Dt,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new Le,this._tooltip=null}initialize(){const{graphic:e,view:t}=this;this.graphicState=new Nt({graphic:e}),this.addHandles(A(()=>this.tooltipOptions.enabled,o=>{this._tooltip=o?new ve({view:t}):R(this._tooltip)},vi)),this._moveManipulation=new kt({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&zt(e),radius:kt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(o=>this.handles.add(o.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:e}),s.stopPropagation()})));const i=o=>s=>{this.handles.add(s.events.on("focus-changed",({action:n})=>{const r=this._tooltip;_(r)||(n==="focus"?this._updateMoveTooltip(o):r.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(b.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(b.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(b.Z)),this._moveManipulation.elevationInfo=C(e);const a=e.geometry;if(this._moveManipulation.createGraphicDragPipeline((o,s,n,r,l)=>(p(a)&&o===b.XY&&(n=n.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new Ve({elevationInfo:C(e),pointer:l,editGeometryOperations:Be.fromGeometry(new zs({spatialReference:a.spatialReference}),t.state.viewingMode),visualizer:new ge,excludeFeature:e}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:r,useZ:!1}),this._snappingPipeline.next)),n=n.next(c=>(this._updateMoveTooltip(o,c),c))),this.graphicState,o=>{const{action:s,graphic:n,dxScreen:r,dyScreen:l}=o,c={graphic:n,dxScreen:r,dyScreen:l};switch(s){case"start":this.emit("graphic-translate-start",c),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",c);break;case"end":this.emit("graphic-translate-stop",c)}}),this._moveManipulation.angle=p(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(A(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const o=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Zn({tool:this,mode:o,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([Je({view:this.view,graphic:this.graphic,forEachManipulator:o=>this._forEachManipulator(o),onManipulatorsChanged:()=>Ct()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),A(()=>t.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(o=>{o instanceof J&&this.handles.add(o.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=R(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=R(this._scaleRotate),this._scaleRotateAdapter=R(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){_(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return p(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new dt({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new N({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.graphic.layer),sizeAxis:p(this.tooltipOptions.visualVariables)&&p(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),p(this._scaleRotate)&&this._scaleRotate.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return A(()=>this.graphicState.displaying,e=>{this._forEachManipulator(t=>t.available=e),this._moveManipulation.zManipulation.available=e&&this.enableZ&&zt(this.graphic)})}_createGeometryUndoRecord(){return Ka(this.graphic)}set snapToScene(e){this._moveManipulation&&(this._moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this._moveManipulation.location=e,p(this._scaleRotate)&&(this._scaleRotate.location=e)}set elevationAlignedLocation(e){this._moveManipulation.elevationAlignedLocation=e,p(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){p(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(_(this._scaleRotate))return;const e=this._scaleRotate.getScale();this._moveManipulation.displayScale=e}_updateMoveAngle(){this.view.state.viewingMode===mi.Local||this.view.scale<$n?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){za(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(e,t){const{tooltipOptions:i,_tooltip:a}=this;if(_(a))return;a.clear();const o=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case b.XY:a.info=new _e({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,(s,n)=>Mt(s,n,o));break;case b.XY_AXIS:a.info=new Ei({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,(s,n)=>{const r=Mt(s,n,o);return Ie(r,Ne(t))});break;case b.Z:a.info=new We({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,ke)}}_updateMoveTooltipDistance(e,t,i){if(p(t)&&t.action!=="end"){const{mapStart:a,mapEnd:o}=t,s=i(a,o);e.distance=p(s)?s:de}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:p(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],B.prototype,"enableZ",void 0),h([d()],B.prototype,"enableRotation",void 0),h([d()],B.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Dt})],B.prototype,"tooltipOptions",void 0),h([d()],B.prototype,"graphicState",void 0),h([d({value:!1})],B.prototype,"snapToScene",null),h([d({constructOnly:!0})],B.prototype,"snappingManager",void 0),h([d({readOnly:!0})],B.prototype,"type",void 0),h([d({readOnly:!0})],B.prototype,"updating",null),B=h([z("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],B);class tr{constructor(){this._lastDragEvent=null,this.next=new $a,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&p(this._lastDragEvent)){const i={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=t}createDragEventPipelineStep(){return this._lastDragEvent=null,t=>(this._lastDragEvent=t.action!=="end"?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t)}_adjustScaleFactors(t){const i=Fa(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-i:i,t.factor2=t.factor2<0?-i:i}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}function Te(e,t){return Qa(e,t,!1)}function ba(e,t){return Qa(e,t,!0)}function Qa(e,t,i){if(e instanceof Jo){if(e.operation instanceof Ko)return er(e.operation,t,i),!0;if(e.operation instanceof Qo)return ir(e.operation,t,i),!0;if(e.operation instanceof ts)return ar(e.operation,t,i),!0}return!1}function er(e,t,i=!1){const a=i?-1:1,o=U(a*e.dx,a*e.dy,a*e.dz);yt(t.origin,t.origin,o)}function ir(e,t,i=!1){const a=i?-e.angle:e.angle;Ri(t.basis1,t.basis1,$i,a),Ri(t.basis2,t.basis2,$i,a)}function ar(e,t,i=!1){const a=i?1/e.factor1:e.factor1,o=i?1/e.factor2:e.factor2;bt(t.basis1,t.basis1,a),bt(t.basis2,t.basis2,o),Vi(t.origin,t.origin,e.origin,e.axis1,a),Vi(t.origin,t.origin,e.origin,e.axis2,o)}function or(e,t,i,a){a||(a=qt());const o=X(Bt.get(),e[1],-e[0]),s=X(Bt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=X(Bt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r=Bt.get();t.components.forEach(g=>g.vertices.forEach(u=>{const m=u.pos;X(r,Ci(e,m),Ci(o,m)),bo(s,s,r),So(n,n,r)}));const l=1e-6,c=X(Bt.get(),n[0]-s[0]<l?i/2:0,n[1]-s[1]<l?i/2:0);return Da(s,s,c),Ae(n,n,c),ci(a.basis1,e,(n[0]-s[0])/2),ci(a.basis2,o,(n[1]-s[1])/2),X(a.origin,s[0]*e[0]+s[1]*o[0],s[0]*e[1]+s[1]*o[1]),Ae(a.origin,a.origin,a.basis1),Ae(a.origin,a.origin,a.basis2),a}function sr(e,t,i,a=0,o){o||(o=qt()),t.toRenderCoords(e.origin,i,o.origin);const s=x.get();yt(s,e.origin,e.basis1),yt(s,s,e.basis2),t.toRenderCoords(s,i,s);const n=x.get();yt(n,e.origin,e.basis1),P(n,n,e.basis2),t.toRenderCoords(n,i,n);const r=x.get();P(r,e.origin,e.basis1),P(r,r,e.basis2),t.toRenderCoords(r,i,r);const l=x.get();P(l,e.origin,e.basis1),yt(l,l,e.basis2),t.toRenderCoords(l,i,l);const c=Pt(x.get(),s,n,.5);P(c,c,o.origin);const g=Pt(x.get(),r,l,.5);P(g,o.origin,g),Pt(o.basis1,c,g,.5);const u=Pt(x.get(),l,s,.5);P(u,u,o.origin);const m=Pt(x.get(),n,r,.5);P(m,o.origin,m),Pt(o.basis2,u,m,.5);const f=Gt(x.get(),o.basis1,o.basis2),y=Gt(f,f,o.basis1);return Re(y,y),bt(o.basis2,y,$e(o.basis2,y)),bt(o.basis1,o.basis1,1+a/Qt(o.basis1)),bt(o.basis2,o.basis2,1+a/Qt(o.basis2)),es(o),o}function Sa(e,t,i,a){const o=x.get();P(o,P(o,e.origin,e.basis1),e.basis2);const s=x.get();Vt(s,o,e.basis1,2);const n=x.get();Vt(n,s,e.basis2,2);const r=x.get();Vt(r,o,e.basis2,2),o[2]=s[2]=n[2]=r[2]=t;const l=a?"on-the-ground":"absolute-height",c=Li(Se(o,s,i,l),Se(r,n,i,l)),g=Li(Se(s,n,i,l),Se(o,r,i,l));return _(g)||_(c)?null:[c,g]}let j=class extends St.EventedMixin(Fe){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Dt,this._preserveAspectRatio=new tr,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new ee,this._moveZManipulator=null,this._resizeManipulators=null,this._rotateManipulator=null,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=qt(),this._mapBoundsStart=qt(),this._zmax=0,this._sizeStart=null,this._displayBounds=qt(),this._displayBoundsStart=qt(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=he(),this._endScale=he()}initialize(){const{view:e,graphic:t,manipulators:i,_handles:a}=this,o=this._graphicState=new Nt({graphic:t}),s=t.geometry;this._editGeometryOperations=Be.fromGeometry(s,e.state.viewingMode),this._graphicMoveManipulation=new Ai({tool:this,view:e,graphicState:o}),this._moveZManipulator=Xs(e,Zs.CENTER_ON_CALLOUT),this._moveZManipulator.state|=Ys,a.add([this._createMoveXYGraphicDragPipeline(),A(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._moveZManipulator,T.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map(g=>{const u=Fs(e,g);return a.add([A(()=>this.enableScaling,()=>this._updateManipulatorAvailability(u,T.SCALE)),u.events.on("grab-changed",m=>this._onResizeGrab(m)),this._createResizeDragPipeline(u,g)]),u}),i.addMany(this._resizeManipulators),this._rotateManipulatorTexture=As(e.toolViewManager.textures),this._rotateManipulator=_s(e,{texture:this._rotateManipulatorTexture.texture}),a.add([A(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._rotateManipulator,T.ROTATE)),this._rotateManipulator.events.on("grab-changed",g=>{this._onRotateGrab(g)}),this._createRotateDragPipeline(this._rotateManipulator)]),i.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const n=Je({view:e,graphic:t,forEachManipulator:g=>this._forEachManipulator(g),onManipulatorsChanged:()=>Ct()});p(n)&&(this._outlineVisualElement=n.visualElement instanceof Ht?n.visualElement:null),p(this._outlineVisualElement)&&a.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(n),a.add([o.on("changed",()=>this._onGeometryChanged()),A(()=>o.displaying,()=>this._updateAllManipulatorAvailability()),A(()=>o.isDraped,()=>this._graphicDrapedChanged(),ft),e.trackGraphicState(o)]);const r=e.pointsOfInterest;r&&a.add(A(()=>r.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=g=>{a.add(g.events.on("grab-changed",()=>{this.grabbing=g.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const c=(g,u)=>{a.add(g.events.on("immediate-click",m=>{u===T.TRANSLATE_XY&&this.emit("immediate-click",{...m,graphic:t}),m.stopPropagation()}))};this._forEachManipulator(c),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:e,view:t}=this,i=this._tooltip=new ve({view:t}),a=()=>{i.info=this._getUpdatedTooltipInfo()};e.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",o=>{this._startAngle=o.angle,a()}),this.on("graphic-rotate",o=>{this._endAngle=o.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",o=>{X(this._startScale,o.xScale,o.yScale),X(this._endScale,o.xScale,o.yScale),a()}),this.on("graphic-scale",o=>{X(this._endScale,o.xScale,o.yScale),a()}),this.on("graphic-scale-stop",()=>{X(this._startScale,0,0),X(this._endScale,0,0),a()})]),this._forEachManipulator(o=>{e.add([o.events.on("focus-changed",a),o.events.on("grab-changed",a),o.events.on("drag",s=>{s.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some(e=>e.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=et(this._moveXYTooltipInfo,()=>new _e({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const e=this._moveZTooltipInfo=et(this._moveZTooltipInfo,()=>new We({tooltipOptions:this.tooltipOptions})),t=this._moveUnit;if(this._moveZManipulator.dragging){const i=this._mapBoundsStart.origin,a=this._mapBounds.origin,o=Ls(i,a,this.view.spatialReference);if(_(o))return null;e.distance=o}else e.distance=ue(0,t);return e}_computeRotateTooltipInfo(){const e=this._rotateTooltipInfo=et(this._rotateTooltipInfo,()=>new tn({tooltipOptions:this.tooltipOptions}));return e.angle=this._startAngle-this._endAngle,e}_computeScaleTooltipInfo(){const e=this.graphic.geometry;if(_(e))return null;const t=this._scaleTooltipInfo=et(this._scaleTooltipInfo,()=>new en({tooltipOptions:this.tooltipOptions})),i=Sa(this._mapBounds,this._zmax,e.spatialReference,this._graphicState.isDraped);return _(i)?null:(t.xSize=i[0],t.ySize=i[1],p(this._sizeStart)&&this._resizeManipulators.some(a=>a.dragging)?(t.xScale=i[0].value/this._sizeStart[0].value,t.yScale=i[1].value/this._sizeStart[1].value):(t.xScale=1,t.yScale=1),t)}_graphicDrapedChanged(){this._handles.remove(xa),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",e=>{p(this._attachmentOrigin)&&Ha(e.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()}),xa)}_updateAllManipulatorAvailability(){this._forEachManipulator((e,t)=>this._updateManipulatorAvailability(e,t))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof J){const a=this._graphicState.displaying,o=this.enableZ&&zt(this.graphic);switch(t){case T.ROTATE:e.available=a&&this.enableRotation;break;case T.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||o),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?Bs:js;break;case T.TRANSLATE_Z:e.available=a&&o;break;default:e.available=a}}}_forEachManipulator(e){this._graphicMoveManipulation.forEachManipulator(e),this._resizeManipulators.forEach(t=>e(t,T.SCALE)),e(this._rotateManipulator,T.ROTATE),e(this._moveZManipulator,T.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}get _moveUnit(){return et(fo(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const e=this.graphic.geometry,t=this._editGeometryOperations.data,i=t.components[0].edges[0],a=Da(Bt.get(),i.leftVertex.pos,i.rightVertex.pos);hi(a,a);const o=et(di(this.view,this.graphic),()=>e.extent.center);let s=rr*this.view.pixelSizeAt(o);const n=this.view.spatialReference,r=e.spatialReference;n.equals(r)||(s*=pi(n)/pi(r)),or(a,t,s,this._mapBounds),this._updateZMax()}_updateZMax(){const e=this._editGeometryOperations.data;if(!e.geometry.hasZ)return void(this._zmax=0);const t=e.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of e.components)for(const o of a.vertices){const s=t.getZ(o.pos);i=Math.max(s,i)}this._zmax=i}_updateDisplayBounds(){const e=this.graphic.geometry;if(_(e))return;const t=p(this._outlineVisualElement)&&!this._graphicState.isDraped&&p(this._outlineVisualElement.attachmentOrigin)?this._outlineVisualElement.attachmentOrigin:di(this.view,this.graphic);this._attachmentOrigin=et(t,e.extent.center);const i=p(t)?t.z:fi(this._mapBounds.origin,this.view.elevationProvider,Ye.fromElevationInfo(C(this.graphic)),this.view.renderCoordsHelper),a=ne(this._mapBounds);a.origin[2]=i,sr(a,this.view.renderCoordsHelper,e.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:this._editGeometryOperations.data.geometry.extent.center;return nr*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline((e,t,i)=>this._applyGraphicMoveSteps(t,i,b.XY))}_createMoveZDragPipeline(){const e=this.view,t=this._editGeometryOperations.data.spatialReference;return ot(this._moveZManipulator,(i,a,o)=>{const s=Ta(i.renderLocation),n=a.next(Za(e,s,t)).next(ie());this._applyGraphicMoveSteps(n,o,b.Z)})}_applyGraphicMoveSteps(e,t,i){const a=e.next(o=>(o.action==="start"&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY})),o)).next(jt()).next(this._moveDragUpdateGeometry()).next(o=>{const s={graphic:this.graphic,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY};switch(o.action){case"start":case"update":(o.mapEnd.x-o.mapStart.x||o.mapEnd.y-o.mapStart.y||o.mapEnd.z-o.mapStart.z)&&this.emit("graphic-translate",s);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",s)}return o}).next(o=>this._updateMoveTooltip(o,i));return t.next(()=>{p(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_updateOperationStartProperties(){ne(this._displayBounds,this._displayBoundsStart),ne(this._mapBounds,this._mapBoundsStart),_(this.graphic.geometry)?this._sizeStart=null:this._sizeStart=Sa(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped)}_moveDragUpdateGeometry(){return e=>{if(_(this.inputState)||this.inputState.type!=="move")return e;const t=[];for(const o of this._editGeometryOperations.data.components)t.push(...o.vertices);const i=e.action==="start"?_t.NEW_STEP:_t.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return Te(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_updateMoveTooltip(e,t){if(t===b.XY||t===b.XY_AXIS){const i=Mt(e.mapStart,e.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");p(i)&&p(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return e}_onResizeGrab(e){if(e.action!=="start")return;const t=this._calculatePickRay(e.screenPoint);ta(this._displayBounds.plane,t,x.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return ot(e,(i,a,o)=>{_(this.inputState)||(a.next(s=>(s.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),s)).next(gi(this.view,this._displayBoundsStart.plane)).next(s=>({...s,handle:t})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,xScale:s.factor1,yScale:s.factor2};switch(s.action){case"start":case"update":this.emit("graphic-scale",n);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",n)}return s}),o.next(()=>{p(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return e=>{const t=this._displayBoundsStart,i=e.handle.direction,a=this._displayBoundsMargin,o=this._displayBoundsMarginStart,s=ti(x.get(),t.origin);Vt(s,s,t.basis1,-i[0]),Vt(s,s,t.basis2,-i[1]);const n=P(x.get(),e.renderEnd,s),r=P(x.get(),e.renderStart,s),l=Fa(e.handle),c=ia(t),g=ia(this._displayBounds)/c,u=(m,f)=>{if(m===0)return 1;let y=Qt(f),S=.5*m*$e(f,n)/y;const G=S<0?-1:1;l&&(S+=(y-.5*m*$e(f,r)/y)*G*g);const M=y<1.5*o?1:wa;return y=Math.max(y-o,wa),G>0&&(S-=a),G*Math.max(G*(S/y),M)};return{...e,factor1:u(i[0],t.basis1),factor2:u(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=ti(V(),this._mapBoundsStart.origin);Vt(t,t,this._mapBoundsStart.basis1,-e.handle.direction[0]),Vt(t,t,this._mapBoundsStart.basis2,-e.handle.direction[1]);const i=X(he(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);hi(i,i);const a=[];for(const n of this._editGeometryOperations.data.components)a.push(...n.vertices);const o=e.action==="start"?_t.NEW_STEP:_t.ACCUMULATE_STEPS,s=this._editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,o,Zi.REPLACE);return ne(this._mapBoundsStart,this._mapBounds),Te(s,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_onRotateGrab(e){if(e.action!=="start")return;const t=qs(this._displayBounds,this.view.renderCoordsHelper,Ws.HEADING,Oi()),i=this._calculatePickRay(e.screenPoint);ta(t,i,x.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return ot(e,(t,i,a)=>{const o=this.inputState;_(o)||(i.next(s=>(s.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),s)).next(gi(this.view,o.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(o)).next(this._rotateDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,angle:me(s.rotateAngle)};switch(s.action){case"start":case"update":this.emit("graphic-rotate",n);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",n)}return s}),a.next(()=>{p(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(e){return t=>{const i=ye(e.rotatePlane),a=ka(t.renderStart,t.renderEnd,this._displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=ti(V(),this._mapBoundsStart.origin),i=[];for(const s of this._editGeometryOperations.data.components)i.push(...s.vertices);const a=e.action==="start"?_t.NEW_STEP:_t.ACCUMULATE_STEPS,o=this._editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,Zi.REPLACE);return ne(this._mapBoundsStart,this._mapBounds),Te(o,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=xs(),i=co(e);return is(this.view.state.camera,i,t),Re(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=Js(this._displayBounds,q.get());Ks(this._rotateManipulator,e,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,e),this._resizeManipulators.forEach((t,i)=>{Qs(t,this._resizeHandles[i],e,this._displayBounds)})}_updateZMoveHandle(e,t){const i=this._displayBounds,a={basis:i.basis1,direction:-1,position:P(x.get(),i.origin,i.basis1),edge:2},o=q.get();Ms(o,t,a.edge*Math.PI/2),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=a.position}_cancel(){const e=this._editGeometryOperations.lastOperation;_(e)||(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,ba(e,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(p(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,ba(O(e),this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Te(O(e),this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"graphic",void 0),h([d({constructOnly:!0,nonNullable:!0})],j.prototype,"enableZ",void 0),h([d()],j.prototype,"enableRotation",void 0),h([d()],j.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:Dt})],j.prototype,"tooltipOptions",void 0),h([d()],j.prototype,"preserveAspectRatio",null),h([d()],j.prototype,"grabbing",void 0),h([d()],j.prototype,"inputState",void 0),h([d({readOnly:!0})],j.prototype,"type",void 0),h([d()],j.prototype,"_moveUnit",null),j=h([z("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],j);const xa="draped-elevation-changes",nr=10,rr=80,wa=1e-6;export{Xt as DrawGraphicTool3D,j as ExtentTransformTool,ht as GraphicMoveTool,H as GraphicReshapeTool,B as GraphicTransformTool};
