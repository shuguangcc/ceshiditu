import{s as a}from"./CircularArray-cf56c6b0.js";import{a as _}from"./mathUtils-2519596a.js";import{t as u,r as o,e as c}from"./typedArrayUtil-a8b5b3e9.js";const p="__esri_stream_id__",h="__esri_timestamp__",n=1e3;class f{constructor(t,e,i,s,r=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=s,this.store=t,this.objectIdField=e,this.purgeInterval=r,this._useGeneratedIds=this.objectIdField===p}add(t){if(this._useGeneratedIds){const s=this._nextId();t.attributes[this.objectIdField]=s,t.objectId=s}else t.objectId=t.attributes[this.objectIdField];if(this._addOrUpdated.set(t.objectId,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return u(this._trackIdLessObservations)&&(this._trackIdLessObservations=new a(1e5)),void this._trackIdLessObservations.enqueue(t.objectId);const e=t.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(e)){const s=o(this._purgeOptions)&&this._purgeOptions.maxObservations!=null?this._purgeOptions.maxObservations:n,r=_(s,0,n);this._trackIdToObservations.set(e,new a(r))}const i=this._trackIdToObservations.get(e).enqueue(t.objectId);o(i)&&(this._addOrUpdated.has(i)?this._addOrUpdated.delete(i):this._removed.push(i))}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),i=performance.now();i-this._lastPurge>=this.purgeInterval&&(this._purge(i),this._lastPurge=i);const s=[];if(o(e))for(const r of e){const d=this.store.removeById(r);o(d)&&s.push(d)}if(o(t))for(const r of t)r.attributes[h]=i,this.store.add(r);(t||s!=null&&s.length)&&this.store.update(t,s)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach(i=>t[e++]=i),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;o(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e=this.store.size;if(e>t.displayCount){if(this._timeInfo.trackIdField){for(const i of this._trackIdToObservations.values())if(e>t.displayCount&&i.size){const s=c(i.dequeue());this._removed.push(s),e--}}if(o(this._trackIdLessObservations)){let i=e-t.displayCount;for(;i-- >0;){const s=this._trackIdLessObservations.dequeue();o(s)&&this._removed.push(s)}}}}_purgeByAge(t){var s;if(!t.age||!((s=this._timeInfo)!=null&&s.startTimeField))return;const e=60*t.age*1e3,i=this._maxAge-e;this.store.forEach(r=>{r.attributes[this._timeInfo.startTimeField]<i&&this._removed.push(r.objectId)})}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const i=t-60*e.ageReceived*1e3;this.store.forEach(s=>{s.attributes[h]<i&&this._removed.push(s.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((t,e)=>{t.size===0&&this._trackIdToObservations.delete(e)})}}export{f as h};
